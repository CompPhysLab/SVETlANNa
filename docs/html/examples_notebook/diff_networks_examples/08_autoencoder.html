

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diffractive Autoencoder for MNIST classification task &mdash; SVETlANNa 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Convolutional Diffractive Network" href="09_convolutional_4f.html" />
    <link rel="prev" title="Reservoir computing for time series prediction of Mackey-Glass sequence" href="05_reservoir_mackey_glass.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SVETlANNa
              <img src="../../_static/logo.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../physics.html">Physical Basis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Command reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../freeprop_examples.html">Examples of solving forward light propagation problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../phase_retrieval_examples.html">Examples of phase retrieval algorithms</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../network_examples.html">Examples of diffractive optical networks</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="03_mnist_experiments.html">Feed-forward Diffractive Optical Neural Network for MNIST task</a></li>
<li class="toctree-l3"><a class="reference internal" href="05_reservoir_mackey_glass.html">Reservoir computing for time series prediction of Mackey-Glass sequence</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Diffractive Autoencoder for MNIST classification task</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Imports">Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#2.1.-MNIST-Dataset">2.1. MNIST Dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.1.-Functions-to-get-new-elements">3.1.1. Functions to get new elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.3.-Autoencoder-(bidirectional-encoder-decoder)-class">3.1.3. Autoencoder (bidirectional encoder-decoder) class</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.1.-Prepare-some-stuff-for-training">4.1. Prepare some stuff for training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.2.1.-Before-training">4.2.1. Before training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.2.2.-Training">4.2.2. Training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.4.1.-Select-a-sample-to-encode/decode">4.4.1. Select a sample to encode/decode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.4.2.-Encode/decode-an-example">4.4.2. Encode/decode an example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="09_convolutional_4f.html">Convolutional Diffractive Network</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SVETlANNa</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../examples.html">Examples</a></li>
          <li class="breadcrumb-item"><a href="../../network_examples.html">Examples of diffractive optical networks</a></li>
      <li class="breadcrumb-item active">Diffractive Autoencoder for MNIST classification task</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/examples_notebook/diff_networks_examples/08_autoencoder.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Diffractive-Autoencoder-for-MNIST-classification-task">
<h1>Diffractive Autoencoder for MNIST classification task<a class="headerlink" href="#Diffractive-Autoencoder-for-MNIST-classification-task" title="Link to this heading"></a></h1>
<p>This notebook is based on the article “All-optical autoencoder machine learning framework using diffractive processors” <a class="reference external" href="https://arxiv.org/pdf/2409.20346">[1]</a>.</p>
<section id="Imports">
<h2>Imports<a class="headerlink" href="#Imports" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import warnings</span>
<span class="c1"># warnings.simplefilter(&quot;always&quot;)  # always show warnings!</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">functional</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">transforms</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterpolationMode</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># our library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationParameters</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConstrainedParameter</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># our library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna</span><span class="w"> </span><span class="kn">import</span> <span class="n">Wavefront</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna</span><span class="w"> </span><span class="kn">import</span> <span class="n">elements</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.detector</span><span class="w"> </span><span class="kn">import</span> <span class="n">Detector</span><span class="p">,</span> <span class="n">DetectorProcessorClf</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToWavefront</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.wf_datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetOfWavefronts</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1"># %config InlineBackend.figure_format = &#39;retina&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">today_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y_%H-%M&#39;</span><span class="p">)</span>  <span class="c1"># date for a results folder name</span>
<span class="n">today_date</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;26-03-2025_23-38&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define all necessery variables for that notebook</span>
<span class="n">VARIABLES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># FILEPATHES</span>
    <span class="s1">&#39;data_path&#39;</span><span class="p">:</span> <span class="s1">&#39;./data&#39;</span><span class="p">,</span>  <span class="c1"># folder which will be created (if not exists) to load/store Weizmann dataset</span>
    <span class="s1">&#39;results_path&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;models/autoencoder/ae_exp_</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="c1"># filepath to save results!</span>

    <span class="c1"># GENERAL SETTINGS - SECTION 1 of the notebook</span>
    <span class="s1">&#39;wavelength&#39;</span><span class="p">:</span> <span class="mf">0.435</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>  <span class="c1"># working wavelength, in [m]</span>
        <span class="c1"># Comment: Value from the article [1] - 0.435 * 1e-3  # in [m]</span>
    <span class="s1">&#39;neuron_size&#39;</span><span class="p">:</span> <span class="mf">0.435</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>  <span class="c1"># size of a pixel for DiffractiveLayers, in [m]</span>
        <span class="c1"># Comment: Value from the article [1] - 64 neurons ~ 27.84 * 1e-3  # in [m]</span>
    <span class="s1">&#39;mesh_size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">),</span>  <span class="c1"># full size of a layer = numerical mesh</span>
        <span class="c1"># Comment: value from the article [1] - (160, 160)</span>

    <span class="s1">&#39;use_apertures&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># if we need to add apertures before each Diffractie layer</span>
        <span class="c1"># Comment: value from the article [1] - unknown</span>
    <span class="s1">&#39;aperture_size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>  <span class="c1"># size of each aperture = a detector square for classes zones</span>
        <span class="c1"># Comment: value from the article [1] - unknown</span>

    <span class="c1"># DATASET OF SUBSEQUENCES SETTINGS - SECTION 2 of the notebook</span>
    <span class="s1">&#39;resize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>  <span class="c1"># size to resize pictures to add 0th padding then (up to the mesh size)</span>
    <span class="s1">&#39;modulation&#39;</span><span class="p">:</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span>  <span class="c1"># modulation type to make a wavefront from each picture mask (see 2.3.2.)</span>
        <span class="c1"># Comment: can be equal to `phase`, `amp` or `both`</span>

    <span class="c1"># NETWORK - SECTION 3 of the notebook</span>
    <span class="s1">&#39;max_phase&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>  <span class="c1"># maximal possible phase for each DiffractiveLayer</span>
    <span class="s1">&#39;free_space_method&#39;</span><span class="p">:</span> <span class="s1">&#39;AS&#39;</span><span class="p">,</span>  <span class="c1"># propagation method</span>
        <span class="c1"># Comment: can be &#39;AS&#39; or &#39;fresnel&#39;</span>
    <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">34.8</span> <span class="o">*</span> <span class="mf">1e-3</span><span class="p">,</span>  <span class="c1"># distance between diffractive layers</span>
        <span class="c1"># Comment: distances between two successive layers were all 34.8mm (80 * wavelength)</span>

    <span class="c1"># ENCODER</span>
    <span class="s1">&#39;encoder_use_slm&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># use SLM (if True) or DiffractiveLayers (if False)</span>
    <span class="s1">&#39;encoder_num_layers&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;encoder_init_phases&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="c1"># value or a list of initial constant phases for DiffractiveLayers OR SLM</span>
    <span class="c1"># SLM settings - if &#39;use_slm&#39; == True</span>
        <span class="c1"># Comment: a size of each SLM is equal to SimulationParameters!</span>
    <span class="s1">&#39;encoder_slm_shapes&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">),</span> <span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">),</span> <span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">)],</span>
        <span class="c1"># list of size &#39;encoder_num_layers&#39;</span>
    <span class="s1">&#39;encoder_slm_levels&#39;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
        <span class="c1"># value OR a list (len = &#39;encoder_num_layers&#39;) of numbers of levels for each SLM</span>
    <span class="s1">&#39;encoder_slm_step_funcs&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>  <span class="c1"># value OR a list of step function names</span>
        <span class="c1"># Comment: available stp functions names - &#39;linear&#39;</span>

    <span class="c1"># PRESERVE PHASE OR NOT?!</span>
    <span class="s1">&#39;preserve_phase&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># by default - resets phases after encoding (before decoding)</span>

    <span class="c1"># DECODER - same params!</span>
    <span class="s1">&#39;decoder_use_slm&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;decoder_num_layers&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;decoder_init_phases&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="c1"># SLM settings - if &#39;use_slm&#39; == True</span>
    <span class="s1">&#39;decoder_slm_shapes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">),</span>
    <span class="s1">&#39;decoder_slm_levels&#39;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
    <span class="s1">&#39;decoder_slm_step_funcs&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>

    <span class="c1"># NETWORK LEARNING - SECTION 4 of the notebook</span>
    <span class="c1"># FOR CUSTOM LOSS</span>
    <span class="s1">&#39;eta_th&#39;</span><span class="p">:</span> <span class="mf">0.04</span><span class="p">,</span>  <span class="c1"># value for loss (see 4.1.2.)</span>
    <span class="s1">&#39;encoding_region_size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>  <span class="c1"># a shape of encoding image</span>
        <span class="c1"># Comment: value from the article [1] - (8, 8)</span>
    <span class="s1">&#39;gamma_rec&#39;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>  <span class="c1"># coeff before MSE between Input and Encoded</span>
    <span class="s1">&#39;gamma_en&#39;</span><span class="p">:</span> <span class="mf">2e-5</span><span class="p">,</span>
    <span class="s1">&#39;gamma_eff&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># coefficients for a loss function (see 4.1.2.)</span>
        <span class="c1"># Comment: values from [1] - 5e-5 and 0.1 respectively</span>

        <span class="c1"># Comment: it is also influence on validation/training loops!!!</span>
    <span class="s1">&#39;DEVICE&#39;</span><span class="p">:</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span>  <span class="c1"># if `cuda` - we will check if it is available (see first cells of Sec. 4)</span>
    <span class="s1">&#39;train_batch_size&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>  <span class="c1"># batch sizes for training (see 4.1.1.)</span>
    <span class="s1">&#39;val_batch_size&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
        <span class="c1"># Comment: value from the article [1] - 20  # for both train and test?</span>
    <span class="s1">&#39;adam_lr&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>  <span class="c1"># learning rate for Adam optimizer (see 4.1.2.)</span>
        <span class="c1"># Comment: value from the article [1] - 0.01</span>
    <span class="s1">&#39;number_of_epochs&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>  <span class="c1"># number of epochs to train</span>
        <span class="c1"># Comment: value from the article [1] - 100-300 ?!</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># functions for SLM step (look documentation of SLM)</span>
<span class="n">SLM_STEPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RESULTS_FOLDER</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;results_path&#39;</span><span class="p">]</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">RESULTS_FOLDER</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">RESULTS_FOLDER</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RESULTS_FOLDER</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;models/autoencoder/ae_exp_26-03-2025_23-38&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save experiment conditions (VARIABLES dictionary)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/conditions.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">ensure_ascii</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="1.-Simulation-parameters">
<h3>1. Simulation parameters<a class="headerlink" href="#1.-Simulation-parameters" title="Link to this heading"></a></h3>
<p>Citations from <strong>Methods and Materials</strong> (<em>Parameter details of diffractive processors</em>) of <a class="reference external" href="https://arxiv.org/pdf/2409.20346">[1]</a>:</p>
<blockquote>
<div><p>… i.e., <span class="math notranslate nohighlight">\(\lambda = 0.435\)</span> mm for <span class="math notranslate nohighlight">\(f_0 = 0.69\)</span> THz …</p>
</div></blockquote>
<blockquote>
<div><p>The diffractive layer sets of numerical models were all <span class="math notranslate nohighlight">\(69.6\)</span> mm <span class="math notranslate nohighlight">\(\times\)</span> <span class="math notranslate nohighlight">\(69.6\)</span> mm in size (<span class="math notranslate nohighlight">\(160 \times 160\)</span> pixels)</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">working_wavelength</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>  <span class="c1"># [m] - like for MNIST</span>

<span class="n">c_const</span> <span class="o">=</span> <span class="mi">299_792_458</span>  <span class="c1"># [m / s]</span>
<span class="n">working_frequency</span> <span class="o">=</span> <span class="n">c_const</span> <span class="o">/</span> <span class="n">working_wavelength</span> <span class="c1"># [Hz]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;lambda    = </span><span class="si">{</span><span class="n">working_wavelength</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> mm&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;frequency = </span><span class="si">{</span><span class="n">working_frequency</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e12</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> THz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
lambda    = 0.435 mm
frequency = 0.689 THz
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># neuron size (square)</span>
<span class="n">neuron_size</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;neuron_size&#39;</span><span class="p">]</span>  <span class="c1"># [m] - like for MNIST</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;neuron size = </span><span class="si">{</span><span class="n">neuron_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> mm&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
neuron size = 0.435 mm
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">APERTURES</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;use_apertures&#39;</span><span class="p">]</span>  <span class="c1"># add apertures BEFORE each diffractive layer or not</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER_SIZE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;mesh_size&#39;</span><span class="p">]</span>  <span class="c1"># mesh size</span>
<span class="n">DETECTOR_SIZE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;aperture_size&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of neurons in simulation</span>
<span class="n">x_layer_nodes</span> <span class="o">=</span> <span class="n">LAYER_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y_layer_nodes</span> <span class="o">=</span> <span class="n">LAYER_SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Comment: Same size as proposed!</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer size (in neurons): </span><span class="si">{</span><span class="n">x_layer_nodes</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">y_layer_nodes</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">x_layer_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_layer_nodes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Layer size (in neurons): 160 x 160 = 25600
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># physical size of each layer</span>
<span class="n">x_layer_size_m</span> <span class="o">=</span> <span class="n">x_layer_nodes</span> <span class="o">*</span> <span class="n">neuron_size</span>  <span class="c1"># [m]</span>
<span class="n">y_layer_size_m</span> <span class="o">=</span> <span class="n">y_layer_nodes</span> <span class="o">*</span> <span class="n">neuron_size</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer size (in mm): </span><span class="si">{</span><span class="n">x_layer_size_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="w"> </span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">y_layer_size_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="w"> </span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Layer size (in mm): 69.600 x 69.600
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_LAYER_SIZE_M</span> <span class="o">=</span> <span class="n">x_layer_size_m</span>
<span class="n">Y_LAYER_SIZE_M</span> <span class="o">=</span> <span class="n">y_layer_size_m</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simulation parameters for the rest of the notebook</span>

<span class="n">SIM_PARAMS</span> <span class="o">=</span> <span class="n">SimulationParameters</span><span class="p">(</span>
    <span class="n">axes</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">x_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x_layer_nodes</span><span class="p">),</span>
        <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">y_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_layer_nodes</span><span class="p">),</span>
        <span class="s1">&#39;wavelength&#39;</span><span class="p">:</span> <span class="n">working_wavelength</span><span class="p">,</span>  <span class="c1"># only one wavelength!</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="2.-Dataset-preparation">
<h3>2. Dataset preparation<a class="headerlink" href="#2.-Dataset-preparation" title="Link to this heading"></a></h3>
</section>
</section>
<section id="2.1.-MNIST-Dataset">
<h2>2.1. <a class="reference external" href="https://www.kaggle.com/datasets/hojjatk/mnist-dataset">MNIST Dataset</a><a class="headerlink" href="#2.1.-MNIST-Dataset" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize a directory for a dataset</span>
<span class="n">MNIST_DATA_FOLDER</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;data_path&#39;</span><span class="p">]</span>  <span class="c1"># folder to store data</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TRAIN (images)</span>
<span class="n">mnist_train_ds</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="n">MNIST_DATA_FOLDER</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># for train dataset</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TEST (images)</span>
<span class="n">mnist_test_ds</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="n">MNIST_DATA_FOLDER</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># for test dataset</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test data : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_test_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Train data: 60000
Test data : 10000
</pre></div></div>
</div>
<p>From <a class="reference external" href="https://arxiv.org/pdf/2409.20346">[1]</a>:</p>
<blockquote>
<div><p><span class="math notranslate nohighlight">\(FOV_I\)</span> and <span class="math notranslate nohighlight">\(FOV_{II}\)</span> were both <span class="math notranslate nohighlight">\(27.84\)</span> mm <span class="math notranslate nohighlight">\(\times\)</span> <span class="math notranslate nohighlight">\(27.84\)</span> mm in size (<span class="math notranslate nohighlight">\(64\times64\)</span> pixels)</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select modulation type</span>
<span class="n">MODULATION_TYPE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;modulation&#39;</span><span class="p">]</span>  <span class="c1"># using ONLY amplitude to encode each picture in a Wavefront!</span>
<span class="n">RESIZE_SHAPE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;resize&#39;</span><span class="p">]</span>  <span class="c1"># size to resize pictures to add 0th padding then (up to the mesh size)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resize_y</span> <span class="o">=</span> <span class="n">RESIZE_SHAPE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">resize_x</span> <span class="o">=</span> <span class="n">RESIZE_SHAPE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># shape for transforms.Resize</span>

<span class="c1"># paddings along OY</span>
<span class="n">pad_top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">resize_y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pad_bottom</span> <span class="o">=</span> <span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">pad_top</span> <span class="o">-</span> <span class="n">resize_y</span>
<span class="c1"># paddings along OX</span>
<span class="n">pad_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">resize_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pad_right</span> <span class="o">=</span> <span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">pad_left</span> <span class="o">-</span> <span class="n">resize_x</span>  <span class="c1"># params for transforms.Pad</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compose all transforms!</span>
<span class="n">image_transform_for_ds</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
  <span class="p">[</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span>
          <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">resize_y</span><span class="p">,</span> <span class="n">resize_x</span><span class="p">),</span>
          <span class="n">interpolation</span><span class="o">=</span><span class="n">InterpolationMode</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">,</span>
      <span class="p">),</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">Pad</span><span class="p">(</span>
          <span class="n">padding</span><span class="o">=</span><span class="p">(</span>
              <span class="n">pad_left</span><span class="p">,</span>  <span class="c1"># left padding</span>
              <span class="n">pad_top</span><span class="p">,</span>  <span class="c1"># top padding</span>
              <span class="n">pad_right</span><span class="p">,</span>  <span class="c1"># right padding</span>
              <span class="n">pad_bottom</span>  <span class="c1"># bottom padding</span>
          <span class="p">),</span>
          <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
      <span class="p">),</span>  <span class="c1"># padding to match sizes!</span>
      <span class="n">ToWavefront</span><span class="p">(</span><span class="n">modulation_type</span><span class="o">=</span><span class="n">MODULATION_TYPE</span><span class="p">)</span>  <span class="c1"># &lt;- selected modulation type here!!!</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TRAIN dataset of WAVEFRONTS</span>
<span class="n">mnist_wf_train_ds</span> <span class="o">=</span> <span class="n">DatasetOfWavefronts</span><span class="p">(</span>
    <span class="n">init_ds</span><span class="o">=</span><span class="n">mnist_train_ds</span><span class="p">,</span>  <span class="c1"># dataset of images</span>
    <span class="n">transformations</span><span class="o">=</span><span class="n">image_transform_for_ds</span><span class="p">,</span>  <span class="c1"># image transformation</span>
    <span class="n">sim_params</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>  <span class="c1"># simulation parameters</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TEST dataset of WAVEFRONTS</span>
<span class="n">mnist_wf_test_ds</span> <span class="o">=</span> <span class="n">DatasetOfWavefronts</span><span class="p">(</span>
    <span class="n">init_ds</span><span class="o">=</span><span class="n">mnist_test_ds</span><span class="p">,</span>  <span class="c1"># dataset of images</span>
    <span class="n">transformations</span><span class="o">=</span><span class="n">image_transform_for_ds</span><span class="p">,</span>  <span class="c1"># image transformation</span>
    <span class="n">sim_params</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>  <span class="c1"># simulation parameters</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test data : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_test_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Train data: 60000
Test data : 10000
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="3.-Autoencoder">
<h3>3. Autoencoder<a class="headerlink" href="#3.-Autoencoder" title="Link to this heading"></a></h3>
<blockquote>
<div><p>distances between two successive layers, <span class="math notranslate nohighlight">\(d_l\)</span>, were all <span class="math notranslate nohighlight">\(34.8\)</span> mm (<span class="math notranslate nohighlight">\(80\lambda\)</span>)</p>
</div></blockquote>
<blockquote>
<div><p>model consists of five equally spaced phase-only modulation diffractive layers (<span class="math notranslate nohighlight">\(N=5\)</span>)</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;preserve_phase&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VARIABLES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">PRESERVE_PHASE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">PRESERVE_PHASE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;preserve_phase&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_ENCODER_LAYERS</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_num_layers&#39;</span><span class="p">]</span>  <span class="c1"># number of diffractive layers</span>
<span class="n">NUM_DECODER_LAYERS</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;decoder_num_layers&#39;</span><span class="p">]</span>  <span class="c1"># number of diffractive layers</span>

<span class="n">ENCODER_USE_SLM</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_use_slm&#39;</span><span class="p">]</span>  <span class="c1"># if we use SLM or DiffractiveLayer as a main element for encoder/decoder</span>
<span class="n">DECODER_USE_SLM</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;decoder_use_slm&#39;</span><span class="p">]</span>

<span class="n">MAX_PHASE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;max_phase&#39;</span><span class="p">]</span>

<span class="n">FS_METHOD</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;free_space_method&#39;</span><span class="p">]</span>
<span class="n">FS_DISTANCE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>  <span class="c1"># [m] - distance between difractive layers</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_init_phases&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">ENCODER_INIT_PHASES</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_init_phases&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ENCODER_INIT_PHASES</span> <span class="o">=</span> <span class="p">[</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_init_phases&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_ENCODER_LAYERS</span><span class="p">)]</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;decoder_init_phases&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">DECODER_INIT_PHASES</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;decoder_init_phases&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">DECODER_INIT_PHASES</span> <span class="o">=</span> <span class="p">[</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;decoder_init_phases&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_DECODER_LAYERS</span><span class="p">)]</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ENCODER_INIT_PHASES</span><span class="p">)</span> <span class="o">==</span> <span class="n">NUM_ENCODER_LAYERS</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">DECODER_INIT_PHASES</span><span class="p">)</span> <span class="o">==</span> <span class="n">NUM_DECODER_LAYERS</span>
</pre></div>
</div>
</div>
<section id="SLM-settings-if-needed-(for-encoder/decoder)">
<h4>SLM settings if needed (for encoder/decoder)<a class="headerlink" href="#SLM-settings-if-needed-(for-encoder/decoder)" title="Link to this heading"></a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ENCODER_USE_SLM</span><span class="p">:</span>
    <span class="n">ENCODER_SLM_VARIABLES</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;encoder_slm_shapes&#39;</span><span class="p">,</span> <span class="s1">&#39;encoder_slm_levels&#39;</span><span class="p">,</span> <span class="s1">&#39;encoder_slm_step_funcs&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;encoder_slm_step_funcs&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">ENCODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># all SLM&#39;s have the same parameter</span>
                <span class="n">ENCODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_ENCODER_LAYERS</span><span class="p">)]</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># for step functions!</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">ENCODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SLM_STEPS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># all SLM&#39;s have the same parameter</span>
                <span class="n">ENCODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SLM_STEPS</span><span class="p">[</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_ENCODER_LAYERS</span><span class="p">)]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ENCODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="n">NUM_ENCODER_LAYERS</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">DECODER_USE_SLM</span><span class="p">:</span>
    <span class="n">DECODER_SLM_VARIABLES</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;decoder_slm_shapes&#39;</span><span class="p">,</span> <span class="s1">&#39;decoder_slm_levels&#39;</span><span class="p">,</span> <span class="s1">&#39;decoder_slm_step_funcs&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;decoder_slm_step_funcs&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">DECODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># all SLM&#39;s have the same parameter</span>
                <span class="n">DECODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_DECODER_LAYERS</span><span class="p">)]</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># for step functions!</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">DECODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SLM_STEPS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># all SLM&#39;s have the same parameter</span>
                <span class="n">DECODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SLM_STEPS</span><span class="p">[</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_DECODER_LAYERS</span><span class="p">)]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">DECODER_SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="n">NUM_DECODER_LAYERS</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="3.1.-Architecture">
<h3>3.1. Architecture<a class="headerlink" href="#3.1.-Architecture" title="Link to this heading"></a></h3>
</section>
</section>
<section id="3.1.1.-Functions-to-get-new-elements">
<h2>3.1.1. Functions to get new elements<a class="headerlink" href="#3.1.1.-Functions-to-get-new-elements" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># functions that return single elements for further architecture</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_free_space</span><span class="p">(</span>
    <span class="n">freespace_sim_params</span><span class="p">,</span>
    <span class="n">freespace_distance</span><span class="p">,</span>  <span class="c1"># in [m]!</span>
    <span class="n">freespace_method</span><span class="o">=</span><span class="s1">&#39;AS&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns FreeSpace layer with a bounded distance parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">FreeSpace</span><span class="p">(</span>
        <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">freespace_sim_params</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">freespace_distance</span><span class="p">,</span>  <span class="c1"># distance is not learnable!</span>
        <span class="n">method</span><span class="o">=</span><span class="n">freespace_method</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_const_phase_layer</span><span class="p">(</span>
    <span class="n">sim_params</span><span class="p">:</span> <span class="n">SimulationParameters</span><span class="p">,</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">max_phase</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns DiffractiveLayer with a constant phase mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_nodes</span><span class="p">,</span> <span class="n">y_nodes</span> <span class="o">=</span> <span class="n">sim_params</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span><span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">))</span>

    <span class="n">const_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span><span class="p">))</span> <span class="o">*</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">DiffractiveLayer</span><span class="p">(</span>
        <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">sim_params</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">ConstrainedParameter</span><span class="p">(</span>
            <span class="n">const_mask</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="n">max_phase</span>
        <span class="p">),</span>  <span class="c1"># HERE WE ARE USING CONSTRAINED PARAMETER!</span>
    <span class="p">)</span>  <span class="c1"># ATTENTION TO DOCUMENTATION!</span>


<span class="c1"># CHANGE ACCORDING TO THE DOCUMENTATION OF SLM!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_const_slm_layer</span><span class="p">(</span>
    <span class="n">sim_params</span><span class="p">:</span> <span class="n">SimulationParameters</span><span class="p">,</span>
    <span class="n">mask_shape</span><span class="p">,</span>
    <span class="n">phase_value</span><span class="p">,</span>
    <span class="n">num_levels</span><span class="p">,</span>
    <span class="n">step_func</span><span class="p">,</span>
    <span class="n">height_m</span><span class="o">=</span><span class="n">Y_LAYER_SIZE_M</span><span class="p">,</span>
    <span class="n">width_m</span><span class="o">=</span><span class="n">X_LAYER_SIZE_M</span><span class="p">,</span>
    <span class="n">max_phase</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns SpatialLightModulator with a constant phase mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">mask_shape</span>
    <span class="n">const_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span><span class="p">))</span> <span class="o">*</span> <span class="n">phase_value</span>

    <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">SpatialLightModulator</span><span class="p">(</span>
        <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">sim_params</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">ConstrainedParameter</span><span class="p">(</span>
            <span class="n">const_mask</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="n">max_phase</span>
        <span class="p">),</span>  <span class="c1"># HERE WE ARE USING CONSTRAINED PARAMETER!</span>
        <span class="n">height</span><span class="o">=</span><span class="n">height_m</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">width_m</span><span class="p">,</span>
        <span class="c1"># location=(0., 0.),  # by default</span>
        <span class="n">number_of_levels</span><span class="o">=</span><span class="n">num_levels</span><span class="p">,</span>
        <span class="n">step_function</span><span class="o">=</span><span class="n">step_func</span><span class="p">,</span>
        <span class="c1"># mode=&#39;nearest&#39;,  # by default it is &#39;nearest&#39;</span>
    <span class="p">)</span>  <span class="c1"># ATTENTION TO DOCUMENTATION!</span>
</pre></div>
</div>
</div>
<p>Function to get a list of elements to reproduce an architecture:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_elements_list</span><span class="p">(</span>
    <span class="n">num_layers</span><span class="p">,</span>
    <span class="n">simulation_parameters</span><span class="p">,</span>
    <span class="n">freespace_distance</span><span class="p">,</span>
    <span class="n">freespace_method</span><span class="p">,</span>
    <span class="n">apertures</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">aperture_size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;encoder&#39;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Composes a list of elements for an encoder (with no Detector).</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_layers : int</span>
<span class="sd">        Number of layers in the system.</span>
<span class="sd">    simulation_parameters : SimulationParameters()</span>
<span class="sd">        A simulation parameters for a task.</span>
<span class="sd">    freespace_distance : float,</span>
<span class="sd">        A distance between phase layers in [m].</span>
<span class="sd">    freespace_method : str</span>
<span class="sd">        Propagation method for free spaces in a setup.</span>

<span class="sd">    apertures : bool</span>
<span class="sd">        If True, than before each DiffractiveLayer (and detector) we add a square aperture.</span>
<span class="sd">        Comment: there are strickt square apertures!</span>
<span class="sd">    aperture_size : tuple</span>
<span class="sd">        A size of square apertures.</span>

<span class="sd">    mode : str</span>
<span class="sd">        Takes values: &#39;encoder&#39; or &#39;decoder&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    elements_list : list(Element)</span>
<span class="sd">        List of Elements for an encoder/decoder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elements_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of elements</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;encoder&#39;</span><span class="p">:</span>
        <span class="n">use_slm</span> <span class="o">=</span> <span class="n">ENCODER_USE_SLM</span>
        <span class="n">init_phases</span> <span class="o">=</span> <span class="n">ENCODER_INIT_PHASES</span>
        <span class="k">if</span> <span class="n">use_slm</span><span class="p">:</span>
            <span class="n">slm_masks_shape</span> <span class="o">=</span> <span class="n">ENCODER_SLM_VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_slm_shapes&#39;</span><span class="p">]</span>
            <span class="n">slm_levels</span> <span class="o">=</span> <span class="n">ENCODER_SLM_VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_slm_levels&#39;</span><span class="p">]</span>
            <span class="n">slm_funcs</span> <span class="o">=</span> <span class="n">ENCODER_SLM_VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_slm_step_funcs&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;decoder&#39;</span><span class="p">:</span>
        <span class="n">use_slm</span> <span class="o">=</span> <span class="n">DECODER_USE_SLM</span>
        <span class="n">init_phases</span> <span class="o">=</span> <span class="n">DECODER_INIT_PHASES</span>
        <span class="k">if</span> <span class="n">use_slm</span><span class="p">:</span>
            <span class="n">slm_masks_shape</span> <span class="o">=</span> <span class="n">DECODER_SLM_VARIABLES</span><span class="p">[</span><span class="s1">&#39;decoder_slm_shapes&#39;</span><span class="p">]</span>
            <span class="n">slm_levels</span> <span class="o">=</span> <span class="n">DECODER_SLM_VARIABLES</span><span class="p">[</span><span class="s1">&#39;decoder_slm_levels&#39;</span><span class="p">]</span>
            <span class="n">slm_funcs</span> <span class="o">=</span> <span class="n">DECODER_SLM_VARIABLES</span><span class="p">[</span><span class="s1">&#39;decoder_slm_step_funcs&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">apertures</span><span class="p">:</span>  <span class="c1"># equal masks for all apertures (select a part in the middle)</span>
        <span class="n">aperture_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">aperture_size</span><span class="p">)</span>

        <span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">simulation_parameters</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span><span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">))</span>
        <span class="n">y_mask</span><span class="p">,</span> <span class="n">x_mask</span> <span class="o">=</span> <span class="n">aperture_mask</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">pad_top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y_nodes</span> <span class="o">-</span> <span class="n">y_mask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pad_bottom</span> <span class="o">=</span> <span class="n">y_nodes</span> <span class="o">-</span> <span class="n">pad_top</span> <span class="o">-</span> <span class="n">y_mask</span>
        <span class="n">pad_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_nodes</span> <span class="o">-</span> <span class="n">x_mask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pad_right</span> <span class="o">=</span> <span class="n">x_nodes</span> <span class="o">-</span> <span class="n">pad_left</span> <span class="o">-</span> <span class="n">x_mask</span>  <span class="c1"># params for transforms.Pad</span>

        <span class="c1"># padding transform to match aperture size with simulation parameters</span>
        <span class="n">aperture_mask</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">aperture_mask</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="n">pad_left</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">,</span> <span class="n">pad_top</span><span class="p">,</span> <span class="n">pad_bottom</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

    <span class="c1"># first FreeSpace layer before first DiffractiveLayer</span>
    <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">get_free_space</span><span class="p">(</span>
            <span class="n">simulation_parameters</span><span class="p">,</span>  <span class="c1"># simulation parameters for the notebook</span>
            <span class="n">freespace_distance</span><span class="p">,</span>  <span class="c1"># in [m]</span>
            <span class="n">freespace_method</span><span class="o">=</span><span class="n">freespace_method</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># compose the architecture</span>
    <span class="k">for</span> <span class="n">ind_layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>

        <span class="c1"># add strickt square Aperture</span>
        <span class="k">if</span> <span class="n">apertures</span><span class="p">:</span>
            <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">Aperture</span><span class="p">(</span>
                    <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">simulation_parameters</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">aperture_mask</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------PHASE LAYER</span>
        <span class="k">if</span> <span class="n">use_slm</span><span class="p">:</span>  <span class="c1"># add a phase layer (SLM or DiffractiveLayer)</span>
            <span class="c1"># add SLM (learnable phase mask)</span>
            <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">get_const_slm_layer</span><span class="p">(</span>
                    <span class="n">simulation_parameters</span><span class="p">,</span>
                    <span class="n">mask_shape</span><span class="o">=</span><span class="n">slm_masks_shape</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">phase_value</span><span class="o">=</span><span class="n">init_phases</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">num_levels</span><span class="o">=</span><span class="n">slm_levels</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">step_func</span><span class="o">=</span><span class="n">slm_funcs</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">max_phase</span><span class="o">=</span><span class="n">MAX_PHASE</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add DiffractiveLayer (learnable phase mask)</span>
            <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">get_const_phase_layer</span><span class="p">(</span>
                    <span class="n">simulation_parameters</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">init_phases</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">max_phase</span><span class="o">=</span><span class="n">MAX_PHASE</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># -----------------------------------------------------------------------</span>

        <span class="c1"># add FreeSpace</span>
        <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">get_free_space</span><span class="p">(</span>
                <span class="n">simulation_parameters</span><span class="p">,</span>  <span class="c1"># simulation parameters for the notebook</span>
                <span class="n">freespace_distance</span><span class="p">,</span>  <span class="c1"># in [m]</span>
                <span class="n">freespace_method</span><span class="o">=</span><span class="n">freespace_method</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">elements_list</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="3.1.3.-Autoencoder-(bidirectional-encoder-decoder)-class">
<h2>3.1.3. Autoencoder (bidirectional encoder-decoder) class<a class="headerlink" href="#3.1.3.-Autoencoder-(bidirectional-encoder-decoder)-class" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AutoencoderSymmetrical</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An autoencoder:</span>
<span class="sd">        .encode() - forward propagation through encoder elements</span>
<span class="sd">        .decode() - forward propagation through decoder elements</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sim_params</span><span class="p">:</span> <span class="n">SimulationParameters</span><span class="p">,</span>
        <span class="n">encoder_num_layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">decoder_num_layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">fs_distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">fs_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;AS&#39;</span><span class="p">,</span>
        <span class="n">encoder_elements_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">decoder_elements_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_default_device</span><span class="p">(),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sim_params : SimulationParameters</span>
<span class="sd">            Simulation parameters for the task.</span>
<span class="sd">        encoder_num_layers, decoder_num_layers : int</span>
<span class="sd">            Number of layers in encoder/decoder.</span>
<span class="sd">        fs_distance : float,</span>
<span class="sd">            A distance between phase layers in [m].</span>
<span class="sd">        fs_method : str</span>
<span class="sd">            Propagation method for free spaces in a setup.</span>
<span class="sd">        elements_list : list</span>
<span class="sd">            List of elements to compose an autoencoder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span> <span class="o">=</span> <span class="n">sim_params</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span>
            <span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># height and width for a wavefronts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs_method</span> <span class="o">=</span> <span class="n">fs_method</span>

        <span class="c1"># ENCODER</span>
        <span class="k">if</span> <span class="n">encoder_elements_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">encoder_elements_list</span> <span class="o">=</span> <span class="n">get_elements_list</span><span class="p">(</span>
                <span class="n">encoder_num_layers</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="p">,</span>
                <span class="n">fs_distance</span><span class="p">,</span>
                <span class="n">fs_method</span><span class="p">,</span>
                <span class="n">apertures</span><span class="o">=</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;use_apertures&#39;</span><span class="p">],</span>
                <span class="n">aperture_size</span><span class="o">=</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;aperture_size&#39;</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;encoder&#39;</span>
            <span class="p">)</span>  <span class="c1"># no Detector here!</span>

        <span class="c1"># self.encoder_elements = encoder_elements_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">encoder_elements_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__device</span><span class="p">)</span>

        <span class="c1"># DECODER</span>
        <span class="k">if</span> <span class="n">decoder_elements_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decoder_elements_list</span> <span class="o">=</span> <span class="n">get_elements_list</span><span class="p">(</span>
                <span class="n">decoder_num_layers</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="p">,</span>
                <span class="n">fs_distance</span><span class="p">,</span>
                <span class="n">fs_method</span><span class="p">,</span>
                <span class="n">apertures</span><span class="o">=</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;use_apertures&#39;</span><span class="p">],</span>
                <span class="n">aperture_size</span><span class="o">=</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;aperture_size&#39;</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;decoder&#39;</span><span class="p">,</span>  <span class="c1"># DECODER is a mirror image of ENCODER!</span>
            <span class="p">)</span>  <span class="c1"># no Detector here!</span>

        <span class="c1"># self.decoder_elements = decoder_elements_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">decoder_elements_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__device</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavefront_in</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward propagation through the autoencoder - encode an image wavefront (input).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wavefront_encoded : Wavefront</span>
<span class="sd">            An encoded input wavefront.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">wavefront_in</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavefront_encoded</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backward propagation through the autoencoder - decode an wncoded image.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wavefront_decoded : Wavefront</span>
<span class="sd">            A decoded wavefront.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">wavefront_encoded</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stepwise_propagation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_wavefront</span><span class="p">:</span> <span class="n">Wavefront</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;encode&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that consistently applies forward method of each element of ENCODER/DECODER</span>
<span class="sd">        to an input wavefront.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_wavefront : torch.Tensor</span>
<span class="sd">            A wavefront that enters the optical network.</span>
<span class="sd">        mode : str</span>
<span class="sd">            Specify a mode &#39;encode&#39; or &#39;decode&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            A string that represents a scheme of a propagation through a setup.</span>
<span class="sd">        list(torch.Tensor)</span>
<span class="sd">            A list of an input wavefront evolution</span>
<span class="sd">            during a propagation through a setup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">this_wavefront</span> <span class="o">=</span> <span class="n">input_wavefront</span>
        <span class="c1"># list of wavefronts while propagation of an initial wavefront through the system</span>
        <span class="n">steps_wavefront</span> <span class="o">=</span> <span class="p">[</span><span class="n">this_wavefront</span><span class="p">]</span>  <span class="c1"># input wavefront is a zeroth step</span>

        <span class="n">optical_scheme</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># string that represents a linear optical setup (schematic)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;encode&#39;</span><span class="p">:</span>
            <span class="n">net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;decode&#39;</span><span class="p">:</span>
            <span class="n">net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span>

        <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ind_element</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
            <span class="c1"># for visualization in a console</span>
            <span class="n">element_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">optical_scheme</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-(</span><span class="si">{</span><span class="n">ind_element</span><span class="si">}</span><span class="s1">)-&gt; [</span><span class="si">{</span><span class="n">ind_element</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">element_name</span><span class="si">}</span><span class="s1">] &#39;</span>

            <span class="k">if</span> <span class="n">ind_element</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">optical_scheme</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-(</span><span class="si">{</span><span class="n">ind_element</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">)-&gt;&#39;</span>

            <span class="c1"># element forward</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">this_wavefront</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">this_wavefront</span><span class="p">)</span>

            <span class="n">steps_wavefront</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_wavefront</span><span class="p">)</span>  <span class="c1"># add a wavefront to list of steps</span>

        <span class="k">return</span> <span class="n">optical_scheme</span><span class="p">,</span> <span class="n">steps_wavefront</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavefront_in</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wavefront_in: Wavefront(&#39;bs&#39;, &#39;H&#39;, &#39;W&#39;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        amplitudes_encoded, amplitudes_decoded : torch.Tensor</span>
<span class="sd">            Amplitudes of encoded and decoded wavefronts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavefront_in</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># if a batch is an input</span>
            <span class="n">batch_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">wavefront_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># encode</span>
        <span class="n">wavefront_encoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">wavefront_in</span><span class="p">)</span>
        <span class="c1"># decode from intencity!</span>
        <span class="k">if</span> <span class="n">PRESERVE_PHASE</span><span class="p">:</span>
            <span class="n">wavefront_decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">wavefront_encoded</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wavefront_encoded_no_phase</span> <span class="o">=</span> <span class="n">wavefront_encoded</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>
            <span class="n">wavefront_decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">wavefront_encoded_no_phase</span><span class="p">)</span>

        <span class="c1"># results to calculate loss</span>
        <span class="n">amplitudes_encoded</span> <span class="o">=</span> <span class="n">wavefront_encoded</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="n">amplitudes_decoded</span> <span class="o">=</span> <span class="n">wavefront_decoded</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">amplitudes_encoded</span><span class="p">,</span> <span class="n">amplitudes_decoded</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="3.2.-An-untrained-autoencoder">
<h3>3.2. An untrained autoencoder<a class="headerlink" href="#3.2.-An-untrained-autoencoder" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_autoencoder</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">AutoencoderSymmetrical</span><span class="p">(</span>
        <span class="n">sim_params</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>
        <span class="n">encoder_num_layers</span><span class="o">=</span><span class="n">NUM_ENCODER_LAYERS</span><span class="p">,</span>
        <span class="n">decoder_num_layers</span><span class="o">=</span><span class="n">NUM_DECODER_LAYERS</span><span class="p">,</span>
        <span class="n">fs_distance</span><span class="o">=</span><span class="n">FS_DISTANCE</span><span class="p">,</span>
        <span class="n">fs_method</span><span class="o">=</span><span class="n">FS_METHOD</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.-Training-of-the-network">
<h3>4. Training of the network<a class="headerlink" href="#4.-Training-of-the-network" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DEVICE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;DEVICE&#39;</span><span class="p">]</span>  <span class="c1"># &#39;mps&#39; is not support a CrossEntropyLoss</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
    <span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="n">DEVICE</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;cpu&#39;
</pre></div></div>
</div>
</section>
</section>
<section id="4.1.-Prepare-some-stuff-for-training">
<h2>4.1. Prepare some stuff for training<a class="headerlink" href="#4.1.-Prepare-some-stuff-for-training" title="Link to this heading"></a></h2>
<p>Citation from <a class="reference external" href="https://arxiv.org/pdf/2409.20346">[1]</a>:</p>
<blockquote>
<div><p>During each training iteration, a mini-batch composed of <span class="math notranslate nohighlight">\(128\)</span> randomly selected images was input to the model.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_bs</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;train_batch_size&#39;</span><span class="p">]</span>  <span class="c1"># a batch size for training set</span>
<span class="n">val_bs</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;val_batch_size&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_wf_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">mnist_wf_train_ds</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">train_bs</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">test_wf_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">mnist_wf_test_ds</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">val_bs</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<p>Citations from methods of <a class="reference external" href="https://www.nature.com/articles/s41566-021-00796-w#Sec4">[1]</a>:</p>
<blockquote>
<div><p>For all three architectures, the learning rate was set to <span class="math notranslate nohighlight">\(0.01\)</span>, with a training batch size of … <span class="math notranslate nohighlight">\(20\)</span> for the D-RNN.</p>
</div></blockquote>
<blockquote>
<div><p>We adopt a stochastic gradient descent algorithm, that is, the adaptive moment estimation (Adam) optimizer …</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LR</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;adam_lr&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_adam_optimizer</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>  <span class="c1"># NETWORK PARAMETERS!</span>
        <span class="n">lr</span><span class="o">=</span><span class="n">LR</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<p>From <a class="reference external" href="https://www.nature.com/articles/s41566-021-00796-w#Sec4">[1]</a>:</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\mathcal{L}_\text{OAE} = \mathcal{L}_\text{Rec}+\gamma_{En} \mathcal{L}_{En} +\gamma_{eff}\mathcal{L}_{eff}\]</div>
<p>Here, <span class="math notranslate nohighlight">\(\mathcal{L}_\text{Rec}\)</span> represents the reconstruction error between input images and corresponding decoded images, and is defined as:</p>
<div class="math notranslate nohighlight">
\[\mathcal{L}_\text{Rec} = \mathcal{L}_\text{MSE} \left( I(x,y), O_{De}(x,y) \right)
=E \left[ \left| \sigma_1 I(x,y) - \sigma_2 O_{De}(x,y) \right|^2 \right],\]</div>
<div class="math notranslate nohighlight">
\[\sigma_1=\frac{1}{\sum\limits_{(x,y)} I(x,y)},\]</div>
<div class="math notranslate nohighlight">
\[\sigma_2 = \sigma_1 \frac{\sum\limits_{(x,y)} I(x,y) O_{De}(x,y) }{\sum\limits_{(x,y)} |O_{De}(x,y)|^2 },\]</div>
<p>where <span class="math notranslate nohighlight">\(E[\cdot]\)</span> is the average operator, <span class="math notranslate nohighlight">\(I(x,y)\)</span> stands for input image and <span class="math notranslate nohighlight">\(O_{De}(x,y)\)</span> stands for decoded image. <span class="math notranslate nohighlight">\(\sigma_1\)</span> and <span class="math notranslate nohighlight">\(\sigma_2\)</span> are parameters that eliminate the error due to diffractive energy loss.</p>
</div></blockquote>
<blockquote>
<div><p><span class="math notranslate nohighlight">\(\mathcal{L}_{En}\)</span> is a regularization term designed to maximize the concentration of energy in the target encoding region, which can be expressed as:</p>
<div class="math notranslate nohighlight">
\[\mathcal{L}_{En} =
-\ln\left(
\frac{\sum\limits_{(x,y)} |M(x,y)O_{En}(x,y)|^2 }{\sum\limits_{(x,y)} |O_{En}(x,y)|^2 }
\right),\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}M(x,y)=
\begin{cases}
1,\;(x,y) \in \text{encoding region} \\
0,\; \text{otherwise}
\end{cases}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(O_{En}(x,y)\)</span> represents the encoder output. <span class="math notranslate nohighlight">\(M(x,y)\)</span>, a region mask function that defines the shape of encoding patterns, guides the output to align with the target shape by providing a prior shape distribution, similar to the prior probability distribution in the electronic VAE model.</p>
<p><span class="math notranslate nohighlight">\(\mathcal{L}_{Eff}\)</span> is another regulation term that controls the bidirectional diffraction efficiency. For SOAE and its extended models, we simply used the reconstruction efficiency to constrain the model weights. The equation can be expressed as follows:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathcal{L}_{Eff} =
\begin{cases}
-\ln \left( \frac{\eta_R}{\eta_{Th}} \right), \; \eta_R &lt; \eta_{Th} \\
0,\; \eta_R \geq \eta_{Th}
\end{cases}\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\eta_R=\frac{ \sum\limits_{(x,y)} |O_{De}(x,y)|^2 }{ \sum\limits_{(x,y)} |I(x,y)|^2 }\]</div>
</div></blockquote>
<blockquote>
<div><p>… with <span class="math notranslate nohighlight">\(\eta_{Th}\)</span> in equation … being <span class="math notranslate nohighlight">\(4\%\)</span></p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ETA_TH</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;eta_th&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<blockquote>
<div><p>The encoding region of tiny SOAE and MOAE models are both a square with a side length of <span class="math notranslate nohighlight">\(8\)</span>, resulting in a compression ratio of <span class="math notranslate nohighlight">\(16\)</span>.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">REGION_MASK_SIZE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoding_region_size&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">REGION_MASK</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">REGION_MASK_SIZE</span><span class="p">)</span>  <span class="c1"># M(x,y)</span>

<span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span><span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">))</span>
<span class="n">y_mask</span><span class="p">,</span> <span class="n">x_mask</span> <span class="o">=</span> <span class="n">REGION_MASK_SIZE</span>
<span class="n">pad_top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y_nodes</span> <span class="o">-</span> <span class="n">y_mask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pad_bottom</span> <span class="o">=</span> <span class="n">y_nodes</span> <span class="o">-</span> <span class="n">pad_top</span> <span class="o">-</span> <span class="n">y_mask</span>
<span class="n">pad_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_nodes</span> <span class="o">-</span> <span class="n">x_mask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pad_right</span> <span class="o">=</span> <span class="n">x_nodes</span> <span class="o">-</span> <span class="n">pad_left</span> <span class="o">-</span> <span class="n">x_mask</span>  <span class="c1"># params for transforms.Pad</span>

<span class="c1"># padding transform to match aperture size with simulation parameters</span>
<span class="n">REGION_MASK</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
    <span class="nb">input</span><span class="o">=</span><span class="n">REGION_MASK</span><span class="p">,</span>
    <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="n">pad_left</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">,</span> <span class="n">pad_top</span><span class="p">,</span> <span class="n">pad_bottom</span><span class="p">),</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="mi">0</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;M(x,y) shape: (</span><span class="si">{</span><span class="n">REGION_MASK</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">REGION_MASK</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of nonzero (ones) elements: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">REGION_MASK</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
M(x,y) shape: (160, 160)
Number of nonzero (ones) elements: 400
</pre></div></div>
</div>
<blockquote>
<div><p>… <span class="math notranslate nohighlight">\(\gamma_{En}\)</span> and <span class="math notranslate nohighlight">\(\gamma_{Eff}\)</span> in equation (4) for training SOAE model and its extensions, as well as DSOAE model were respectively set to <span class="math notranslate nohighlight">\(5\times 10^{-5}\)</span> and <span class="math notranslate nohighlight">\(0.1\)</span> …</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GAMMA_EN</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;gamma_en&#39;</span><span class="p">]</span>
<span class="n">GAMMA_EFF</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;gamma_eff&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;gamma_rec&#39;</span> <span class="ow">in</span> <span class="n">VARIABLES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">GAMMA_REC</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;gamma_rec&#39;</span><span class="p">]</span>  <span class="c1"># to make losses of the same order</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">GAMMA_REC</span> <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">CustomLossFunc</span><span class="p">(</span><span class="n">input_image</span><span class="p">,</span> <span class="n">encoded_image_amp</span><span class="p">,</span> <span class="n">decoded_image_amp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates an error function as was used in the article [1].</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    input_image : Wavefront</span>
<span class="sd">        Input wavefront constructed from an image (or a batch of images!).</span>
<span class="sd">    encoded_image_amp : Wavefront (~torch.Tensor)</span>
<span class="sd">        A result of encoding (forward propagation through autoencoder) of an input image - amplitudes!</span>
<span class="sd">    decoded_image_amp : Wavefront (~ torch.Tensor)</span>
<span class="sd">        A result of decoding (backward propagation through autoencoder) of an encoded image - amplitudes!</span>

<span class="sd">    Comment: first dimension is responsible for a batch size!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># if a batch is an input</span>
        <span class="n">batch_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="n">input_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">batch_flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span><span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">))</span>
    <span class="n">number_of_layer_neurons</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">w</span>
    <span class="c1"># TODO: is the error calculates by amplitudes or by intensities?</span>
    <span class="n">input_image_amp</span> <span class="o">=</span> <span class="n">input_image</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

    <span class="c1"># the reconstruction error - L_Rec</span>
    <span class="n">sigma_1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">input_image_amp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">sigma_2</span> <span class="o">=</span> <span class="n">sigma_1</span> <span class="o">*</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">input_image_amp</span> <span class="o">*</span> <span class="n">decoded_image_amp</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
        <span class="p">(</span><span class="n">decoded_image_amp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">batch_flag</span><span class="p">:</span>
        <span class="n">sigma_1</span> <span class="o">=</span> <span class="n">sigma_1</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sigma_2</span> <span class="o">=</span> <span class="n">sigma_2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">l_rec</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">sigma_1</span> <span class="o">*</span> <span class="n">input_image_amp</span> <span class="o">-</span>
                <span class="n">sigma_2</span> <span class="o">*</span> <span class="n">decoded_image_amp</span>
            <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">number_of_layer_neurons</span>  <span class="c1"># DO WE NEED THIS DIVISION?!</span>
    <span class="p">)</span>

    <span class="c1"># regularization term - L_En</span>
    <span class="n">l_en</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="p">((</span><span class="n">REGION_MASK</span> <span class="o">*</span> <span class="n">encoded_image_amp</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
        <span class="p">(</span><span class="n">encoded_image_amp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># another regulation term - L_Eff</span>
    <span class="n">eta_r</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">decoded_image_amp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
        <span class="p">(</span><span class="n">input_image_amp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">batch_flag</span><span class="p">:</span>
        <span class="n">l_eff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">eta_r</span> <span class="o">&lt;</span> <span class="n">ETA_TH</span><span class="p">,</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eta_r</span> <span class="o">/</span> <span class="n">ETA_TH</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">l_eff</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">eta_r</span> <span class="o">/</span> <span class="n">ETA_TH</span><span class="p">)</span> <span class="k">if</span> <span class="n">eta_r</span> <span class="o">&lt;</span> <span class="n">ETA_TH</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="c1"># complete loss</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">GAMMA_REC</span> <span class="o">*</span> <span class="n">l_rec</span> <span class="o">+</span> <span class="n">GAMMA_EN</span> <span class="o">*</span> <span class="n">l_en</span> <span class="o">+</span> <span class="n">GAMMA_EFF</span> <span class="o">*</span> <span class="n">l_eff</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">l_rec</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">l_en</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">l_eff</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="n">loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">CustomLossFunc</span>
<span class="n">loss_func_name</span> <span class="o">=</span> <span class="s1">&#39;custom loss&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">autoencoder_train</span><span class="p">(</span>
    <span class="n">autoencoder</span><span class="p">,</span> <span class="n">wavefronts_dataloader</span><span class="p">,</span>
    <span class="n">loss_func</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">show_process</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to train `AutoencoderBidirectional`</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        autoencoder : torch.nn.Module</span>
<span class="sd">            Autoencoder which is an encoder in one direction and a decoder in another.</span>
<span class="sd">        wavefronts_dataloader : torch.utils.data.DataLoader</span>
<span class="sd">            A loader (by batches) for the train dataset of wavefronts.</span>
<span class="sd">        loss_func :</span>
<span class="sd">            Loss function for such an autoencoder.</span>
<span class="sd">        optimizer: torch.optim</span>
<span class="sd">            Optimizer...</span>
<span class="sd">        device : str</span>
<span class="sd">            Device to computate on...</span>
<span class="sd">        show_process : bool</span>
<span class="sd">            Flag to show (or not) a progress bar.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        batches_loss_parts : list[list]</span>
<span class="sd">            Parts of the custom loss!</span>
<span class="sd">        batches_losses : list[float]</span>
<span class="sd">            Losses for each batch in an epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">autoencoder</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># activate &#39;train&#39; mode of a model</span>
    <span class="n">batches_losses</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store loss for each batch</span>
    <span class="n">batches_loss_parts</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store accuracy for each batch</span>

    <span class="n">correct_preds</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ind_batch</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">batch_wavefronts</span><span class="p">,</span> <span class="n">batch_labels</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">wavefronts_dataloader</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">wavefronts_dataloader</span><span class="p">),</span>
        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">show_process</span>
    <span class="p">):</span>  <span class="c1"># go by batches</span>
        <span class="c1"># batch_wavefronts - input wavefronts, batch_labels - labels</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_wavefronts</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">batch_wavefronts</span> <span class="o">=</span> <span class="n">batch_wavefronts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># batch_labels = batch_labels.to(device)</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="c1"># forward of an autoencoder</span>
        <span class="n">encoded_image_amp</span><span class="p">,</span> <span class="n">decoded_image_amp</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="p">(</span><span class="n">batch_wavefronts</span><span class="p">)</span>

        <span class="n">loss_parts</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">batch_wavefronts</span><span class="p">,</span> <span class="n">encoded_image_amp</span><span class="p">,</span> <span class="n">decoded_image_amp</span><span class="p">)</span>

        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># accumulate losses and accuracies for batches</span>
        <span class="n">batches_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">batches_loss_parts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">part</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">loss_parts</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">batches_loss_parts</span><span class="p">,</span> <span class="n">batches_losses</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">autoencoder_validate</span><span class="p">(</span>
    <span class="n">autoencoder</span><span class="p">,</span> <span class="n">wavefronts_dataloader</span><span class="p">,</span>
    <span class="n">loss_func</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">show_process</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to validate `AutoencoderBidirectional`</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        autoencoder : torch.nn.Module</span>
<span class="sd">            Autoencoder which is an encoder in one direction and a decoder in another.</span>
<span class="sd">        wavefronts_dataloader : torch.utils.data.DataLoader</span>
<span class="sd">            A loader (by batches) for the train dataset of wavefronts.</span>
<span class="sd">        loss_func :</span>
<span class="sd">            Loss function for such an autoencoder.</span>
<span class="sd">        device : str</span>
<span class="sd">            Device to computate on...</span>
<span class="sd">        show_process : bool</span>
<span class="sd">            Flag to show (or not) a progress bar.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        batches_loss_parts : list[list]</span>
<span class="sd">            Parts of the custom loss!</span>
<span class="sd">        batches_losses : list[float]</span>
<span class="sd">            Losses for each batch in an epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">autoencoder</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># activate &#39;eval&#39; mode of a model</span>
    <span class="n">batches_losses</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store loss for each batch</span>
    <span class="n">batches_loss_parts</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store accuracy for each batch</span>

    <span class="n">correct_preds</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">batch_wavefronts</span><span class="p">,</span> <span class="n">batch_labels</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">wavefronts_dataloader</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">wavefronts_dataloader</span><span class="p">),</span>
        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">show_process</span>
    <span class="p">):</span>  <span class="c1"># go by batches</span>
        <span class="c1"># batch_wavefronts - input wavefronts, batch_labels - labels</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_wavefronts</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">batch_wavefronts</span> <span class="o">=</span> <span class="n">batch_wavefronts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># batch_labels = batch_labels.to(device)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">encoded_image_amp</span><span class="p">,</span> <span class="n">decoded_image_amp</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="p">(</span><span class="n">batch_wavefronts</span><span class="p">)</span>
            <span class="n">loss_parts</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">batch_wavefronts</span><span class="p">,</span> <span class="n">encoded_image_amp</span><span class="p">,</span> <span class="n">decoded_image_amp</span><span class="p">)</span>

        <span class="c1"># accumulate losses and accuracies for batches</span>
        <span class="n">batches_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">batches_loss_parts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">part</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">loss_parts</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">batches_loss_parts</span><span class="p">,</span> <span class="n">batches_losses</span>
</pre></div>
</div>
</div>
<section id="4.2.-Training-of-the-optical-network">
<h3>4.2. Training of the optical network<a class="headerlink" href="#4.2.-Training-of-the-optical-network" title="Link to this heading"></a></h3>
</section>
</section>
<section id="4.2.1.-Before-training">
<h2>4.2.1. Before training<a class="headerlink" href="#4.2.1.-Before-training" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Comment: not tested for `cuda`!</span>
<span class="n">SIM_PARAMS</span> <span class="o">=</span> <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">autoencoder_no_train</span> <span class="o">=</span> <span class="n">get_autoencoder</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/giyuu/science-phd/git-projects/SVETlANNa/svetlanna/elements/free_space.py:152: UserWarning: Aliasing problems may occur in the AS method. Consider reducing the distance or increasing the Nx*dx product.
  warn(
/Users/giyuu/science-phd/git-projects/SVETlANNa/svetlanna/elements/free_space.py:158: UserWarning: Aliasing problems may occur in the AS method. Consider reducing the distance or increasing the Ny*dy product.
  warn(
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_func_power</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># FOR OUTPUT!</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_loss_parts_0</span><span class="p">,</span> <span class="n">test_losses_0</span> <span class="o">=</span> <span class="n">autoencoder_validate</span><span class="p">(</span>
    <span class="n">autoencoder_no_train</span><span class="p">,</span>  <span class="c1"># optical recurrent network composed in 3.</span>
    <span class="n">test_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of training set</span>
    <span class="n">loss_func</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
    <span class="n">show_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># evaluate the model</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s1">&#39;Results before training on TEST set:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">test_losses_0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>

<span class="c1"># LOSS PARTS</span>
<span class="n">l_rec_0</span><span class="p">,</span> <span class="n">l_en_0</span><span class="p">,</span> <span class="n">l_eff_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">test_loss_parts_0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">g_rec * L_rec = </span><span class="si">{</span><span class="n">GAMMA_REC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_rec_0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">g_en * L_en = </span><span class="si">{</span><span class="n">GAMMA_EN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_en_0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">g_eff * L_eff = </span><span class="si">{</span><span class="n">GAMMA_EFF</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_eff_0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:34&lt;00:00,  2.28it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Results before training on TEST set:
        custom loss : 8.371190 * 1e-5
                g_rec * L_rec = 5.337000 * 1e-5
                g_en * L_en = 3.034190 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.2.2.-Training">
<h2>4.2.2. Training<a class="headerlink" href="#4.2.2.-Training" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_epochs</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;number_of_epochs&#39;</span><span class="p">]</span>
<span class="n">print_each</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># print each n&#39;th epoch info</span>

<span class="n">loss_func_power</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># for good output loss multiplies by 10 ** (n)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Recreate a system to restart training!</span>
<span class="c1"># Comment: not tested for `cuda`!</span>
<span class="n">SIM_PARAMS</span> <span class="o">=</span> <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">autoencoder_to_train</span> <span class="o">=</span> <span class="n">get_autoencoder</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

<span class="c1"># Linc optimizer to a recreated net!</span>
<span class="n">optimizer_train</span> <span class="o">=</span> <span class="n">get_adam_optimizer</span><span class="p">(</span><span class="n">autoencoder_to_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scheduler</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># sheduler for a lr tuning during training</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">losses_parts_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;l_rec&#39;</span><span class="p">,</span> <span class="s1">&#39;l_en&#39;</span><span class="p">,</span> <span class="s1">&#39;l_eff&#39;</span><span class="p">]</span>  <span class="c1"># ORDER IS SPECIFIED IN CustomFunc return!</span>
<span class="n">losses_coeffs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;l_rec&#39;</span><span class="p">:</span> <span class="n">GAMMA_REC</span><span class="p">,</span> <span class="s1">&#39;l_en&#39;</span><span class="p">:</span> <span class="n">GAMMA_EN</span><span class="p">,</span> <span class="s1">&#39;l_eff&#39;</span><span class="p">:</span> <span class="n">GAMMA_EFF</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_epochs_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_epochs_loss_parts</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">losses_parts_names</span><span class="p">}</span>

<span class="n">val_epochs_losses</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store losses of each epoch</span>
<span class="n">val_epochs_loss_parts</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">losses_parts_names</span><span class="p">}</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">98</span><span class="p">)</span>  <span class="c1"># for reproducability?</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch #</span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">: &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># TRAIN</span>
    <span class="n">start_train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># start time of the epoch (train)</span>
    <span class="n">train_loss_parts</span><span class="p">,</span> <span class="n">train_losses</span> <span class="o">=</span> <span class="n">autoencoder_train</span><span class="p">(</span>
        <span class="n">autoencoder_to_train</span><span class="p">,</span>  <span class="c1"># optical network composed in 3.</span>
        <span class="n">train_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of training set</span>
        <span class="n">loss_func</span><span class="p">,</span>
        <span class="n">optimizer_train</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
        <span class="n">show_process</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># train the model</span>
    <span class="n">mean_train_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span>
    <span class="n">train_l_rec</span><span class="p">,</span> <span class="n">train_l_en</span><span class="p">,</span> <span class="n">train_l_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_loss_parts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># train info</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training results&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">mean_train_loss</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="p">(</span><span class="n">loss_func_power</span><span class="p">)</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">g_rec * L_rec = </span><span class="si">{</span><span class="n">GAMMA_REC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">train_l_rec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">g_en * L_en = </span><span class="si">{</span><span class="n">GAMMA_EN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">train_l_en</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">g_eff * L_eff = </span><span class="si">{</span><span class="n">GAMMA_EFF</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">train_l_eff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">------------   </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_train_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>

    <span class="c1"># VALIDATION</span>
    <span class="n">start_val_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># start time of the epoch (validation)</span>
    <span class="n">val_loss_parts</span><span class="p">,</span> <span class="n">val_losses</span> <span class="o">=</span> <span class="n">autoencoder_validate</span><span class="p">(</span>
        <span class="n">autoencoder_to_train</span><span class="p">,</span>  <span class="c1"># optical network composed in 3.</span>
        <span class="n">test_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of validation set</span>
        <span class="n">loss_func</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
        <span class="n">show_process</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># evaluate the model</span>
    <span class="n">mean_val_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val_losses</span><span class="p">)</span>
    <span class="n">val_l_rec</span><span class="p">,</span> <span class="n">val_l_en</span><span class="p">,</span> <span class="n">val_l_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val_loss_parts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># validation info</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validation results&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1"> * 1e</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">mean_val_loss</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="p">(</span><span class="n">loss_func_power</span><span class="p">)</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">g_rec * L_rec = </span><span class="si">{</span><span class="n">GAMMA_REC</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">val_l_rec</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">g_en * L_en = </span><span class="si">{</span><span class="n">GAMMA_EN</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">val_l_en</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">g_eff * L_eff = </span><span class="si">{</span><span class="n">GAMMA_EFF</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">val_l_eff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">loss_func_power</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1"> * 1e-</span><span class="si">{</span><span class="n">loss_func_power</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">------------   </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_val_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scheduler</span><span class="p">:</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">mean_val_loss</span><span class="p">)</span>

    <span class="c1"># save losses</span>
    <span class="n">train_epochs_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_train_loss</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">losses_parts_names</span><span class="p">,</span> <span class="p">[</span><span class="n">train_l_rec</span><span class="p">,</span> <span class="n">train_l_en</span><span class="p">,</span> <span class="n">train_l_eff</span><span class="p">]):</span>
        <span class="n">train_epochs_loss_parts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="n">val_epochs_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_val_loss</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">losses_parts_names</span><span class="p">,</span> <span class="p">[</span><span class="n">val_l_rec</span><span class="p">,</span> <span class="n">val_l_en</span><span class="p">,</span> <span class="n">val_l_eff</span><span class="p">]):</span>
        <span class="n">val_epochs_loss_parts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Epoch #1:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [09:13&lt;00:00,  1.18s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 5.676445 * 1e-5
                g_rec * L_rec = 4.524684 * 1e-5
                g_en * L_en = 1.151761 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   553.78 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:44&lt;00:00,  1.77it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 4.826706
                g_rec * L_rec = 3.981955 * 1e-5
                g_en * L_en = 0.844751 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   44.75 s
Epoch #5:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [09:22&lt;00:00,  1.20s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 4.030463 * 1e-5
                g_rec * L_rec = 3.315819 * 1e-5
                g_en * L_en = 0.714645 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   562.91 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:43&lt;00:00,  1.82it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.856242
                g_rec * L_rec = 3.168086 * 1e-5
                g_en * L_en = 0.688156 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   43.35 s
Epoch #10:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [09:41&lt;00:00,  1.24s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.756154 * 1e-5
                g_rec * L_rec = 3.074222 * 1e-5
                g_en * L_en = 0.681933 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   582.00 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:45&lt;00:00,  1.75it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.625069
                g_rec * L_rec = 2.961636 * 1e-5
                g_en * L_en = 0.663434 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   45.20 s
Epoch #15:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [08:50&lt;00:00,  1.13s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.652713 * 1e-5
                g_rec * L_rec = 2.982698 * 1e-5
                g_en * L_en = 0.670015 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   530.13 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:42&lt;00:00,  1.87it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.530050
                g_rec * L_rec = 2.876574 * 1e-5
                g_en * L_en = 0.653476 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   42.32 s
Epoch #20:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [08:35&lt;00:00,  1.10s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.593646 * 1e-5
                g_rec * L_rec = 2.930112 * 1e-5
                g_en * L_en = 0.663534 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   515.93 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:35&lt;00:00,  2.25it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.472647
                g_rec * L_rec = 2.827161 * 1e-5
                g_en * L_en = 0.645485 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   35.11 s
Epoch #25:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:48&lt;00:00,  1.00it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.554895 * 1e-5
                g_rec * L_rec = 2.895163 * 1e-5
                g_en * L_en = 0.659732 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   468.38 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.16it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.441596
                g_rec * L_rec = 2.797544 * 1e-5
                g_en * L_en = 0.644052 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.56 s
Epoch #30:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:47&lt;00:00,  1.00it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.527783 * 1e-5
                g_rec * L_rec = 2.870117 * 1e-5
                g_en * L_en = 0.657666 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   467.56 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.16it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.414059
                g_rec * L_rec = 2.773360 * 1e-5
                g_en * L_en = 0.640698 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.55 s
Epoch #35:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:46&lt;00:00,  1.01it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.506301 * 1e-5
                g_rec * L_rec = 2.850291 * 1e-5
                g_en * L_en = 0.656011 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   466.44 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.17it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.388355
                g_rec * L_rec = 2.749171 * 1e-5
                g_en * L_en = 0.639184 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.43 s
Epoch #40:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:47&lt;00:00,  1.00it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.489515 * 1e-5
                g_rec * L_rec = 2.834854 * 1e-5
                g_en * L_en = 0.654661 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   467.65 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.16it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.379840
                g_rec * L_rec = 2.739617 * 1e-5
                g_en * L_en = 0.640223 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.57 s
Epoch #45:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:46&lt;00:00,  1.00it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.475550 * 1e-5
                g_rec * L_rec = 2.821671 * 1e-5
                g_en * L_en = 0.653878 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   466.79 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.16it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.362566
                g_rec * L_rec = 2.725667 * 1e-5
                g_en * L_en = 0.636899 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.50 s
Epoch #50:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:49&lt;00:00,  1.00s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.463909 * 1e-5
                g_rec * L_rec = 2.810879 * 1e-5
                g_en * L_en = 0.653030 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   469.12 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.15it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.357945
                g_rec * L_rec = 2.720305 * 1e-5
                g_en * L_en = 0.637640 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.81 s
Epoch #55:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:45&lt;00:00,  1.01it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.453883 * 1e-5
                g_rec * L_rec = 2.801488 * 1e-5
                g_en * L_en = 0.652395 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   465.95 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.16it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.342818
                g_rec * L_rec = 2.705650 * 1e-5
                g_en * L_en = 0.637168 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.50 s
Epoch #60:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:46&lt;00:00,  1.01it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.444665 * 1e-5
                g_rec * L_rec = 2.792452 * 1e-5
                g_en * L_en = 0.652213 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   466.61 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.17it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.333549
                g_rec * L_rec = 2.696184 * 1e-5
                g_en * L_en = 0.637365 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.48 s
Epoch #65:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:48&lt;00:00,  1.00it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.436591 * 1e-5
                g_rec * L_rec = 2.784726 * 1e-5
                g_en * L_en = 0.651865 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   468.73 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.16it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.330884
                g_rec * L_rec = 2.692881 * 1e-5
                g_en * L_en = 0.638003 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.60 s
Epoch #70:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:49&lt;00:00,  1.00s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.429498 * 1e-5
                g_rec * L_rec = 2.777646 * 1e-5
                g_en * L_en = 0.651852 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   469.53 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:37&lt;00:00,  2.13it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.320256
                g_rec * L_rec = 2.683382 * 1e-5
                g_en * L_en = 0.636874 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   37.14 s
Epoch #75:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [07:52&lt;00:00,  1.01s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.422733 * 1e-5
                g_rec * L_rec = 2.771069 * 1e-5
                g_en * L_en = 0.651663 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   472.83 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:36&lt;00:00,  2.15it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.323554
                g_rec * L_rec = 2.684794 * 1e-5
                g_en * L_en = 0.638760 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   36.82 s
Epoch #80:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 469/469 [09:11&lt;00:00,  1.18s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        custom loss: 3.416787 * 1e-5
                g_rec * L_rec = 2.765276 * 1e-5
                g_en * L_en = 0.651512 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   551.17 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:42&lt;00:00,  1.88it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        custom loss * 1e5: 3.306052
                g_rec * L_rec = 2.669409 * 1e-5
                g_en * L_en = 0.636643 * 1e-5
                g_eff * L_eff = 0.000000 * 1e-5
        ------------   42.07 s
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># learning curve</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_epochs_losses</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val_epochs_losses</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">)</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">loss_func_name</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="c1"># ax0.set_ylim([0.42 * 1e-5, 0.9 * 1e-5])</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_121_0.png" src="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_121_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># learning curve</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">losses_parts_names</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_epochs_loss_parts</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val_epochs_loss_parts</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_123_0.png" src="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_123_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cols</span> <span class="o">=</span> <span class="n">NUM_ENCODER_LAYERS</span>  <span class="c1"># number of columns for DiffractiveLayer&#39;s masks visualization</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># plot wavefronts phase</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>
<span class="n">ind_diff_layer</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">net_type</span> <span class="o">=</span> <span class="s1">&#39;encoder&#39;</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gist_stern&#39;</span>  <span class="c1"># &#39;gist_stern&#39; &#39;rainbow&#39;</span>

<span class="n">net_to_plot</span> <span class="o">=</span> <span class="n">autoencoder_to_train</span><span class="o">.</span><span class="n">encoder</span> <span class="k">if</span> <span class="n">net_type</span> <span class="o">==</span> <span class="s1">&#39;encoder&#39;</span> <span class="k">else</span> <span class="n">autoencoder_to_train</span><span class="o">.</span><span class="n">decoder</span>

<span class="k">for</span> <span class="n">ind_layer</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">net_to_plot</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">elements</span><span class="o">.</span><span class="n">DiffractiveLayer</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">elements</span><span class="o">.</span><span class="n">SpatialLightModulator</span><span class="p">):</span>
        <span class="c1"># plot masks for Diffractive layers</span>
        <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_diff_layer</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">][</span><span class="n">ind_diff_layer</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_diff_layer</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>

        <span class="c1"># ax_this.set_title(titles[ind_module])</span>

        <span class="n">trained_mask</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="n">phase_mask_this</span> <span class="o">=</span> <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">trained_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=MAX_PHASE</span>
        <span class="p">)</span>
        <span class="n">ind_diff_layer</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">APERTURES</span><span class="p">:</span>  <span class="c1"># select only a part within apertures!</span>
            <span class="n">x_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">DETECTOR_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">y_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">DETECTOR_SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">x_frame</span><span class="p">,</span> <span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">x_frame</span><span class="p">,</span> <span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">y_frame</span><span class="p">,</span> <span class="n">y_frame</span><span class="p">])</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.87</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">phase_mask_this</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_126_0.png" src="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_126_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># array with all losses</span>
<span class="n">all_lasses_header</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
    <span class="s1">&#39;train_l_rec&#39;</span><span class="p">,</span> <span class="s1">&#39;train_l_en&#39;</span><span class="p">,</span> <span class="s1">&#39;train_l_eff&#39;</span><span class="p">,</span> <span class="s1">&#39;loss_train&#39;</span><span class="p">,</span>
    <span class="s1">&#39;val_l_rec&#39;</span><span class="p">,</span> <span class="s1">&#39;val_l_en&#39;</span><span class="p">,</span> <span class="s1">&#39;val_l_eff&#39;</span><span class="p">,</span> <span class="s1">&#39;loss_val&#39;</span><span class="p">,</span>
<span class="p">])</span>
<span class="n">all_losses_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">train_epochs_loss_parts</span><span class="p">[</span><span class="s1">&#39;l_rec&#39;</span><span class="p">],</span> <span class="n">train_epochs_loss_parts</span><span class="p">[</span><span class="s1">&#39;l_en&#39;</span><span class="p">],</span> <span class="n">train_epochs_loss_parts</span><span class="p">[</span><span class="s1">&#39;l_eff&#39;</span><span class="p">],</span> <span class="n">train_epochs_losses</span><span class="p">,</span>
        <span class="n">val_epochs_loss_parts</span><span class="p">[</span><span class="s1">&#39;l_rec&#39;</span><span class="p">],</span> <span class="n">val_epochs_loss_parts</span><span class="p">[</span><span class="s1">&#39;l_en&#39;</span><span class="p">],</span> <span class="n">val_epochs_loss_parts</span><span class="p">[</span><span class="s1">&#39;l_eff&#39;</span><span class="p">],</span> <span class="n">val_epochs_losses</span>
    <span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># filepath to save the model</span>
<span class="n">model_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/autoencoder_net.pth&#39;</span>
<span class="c1"># filepath to save losses</span>
<span class="n">losses_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/training_curves.csv&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># saving model</span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">autoencoder_to_train</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_filepath</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># saving losses</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
    <span class="n">losses_filepath</span><span class="p">,</span> <span class="n">all_losses_array</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">all_lasses_header</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="4.4.-Examples-of-encoding/decoding">
<h3>4.4. Examples of encoding/decoding<a class="headerlink" href="#4.4.-Examples-of-encoding/decoding" title="Link to this heading"></a></h3>
</section>
</section>
<section id="4.4.1.-Select-a-sample-to-encode/decode">
<h2>4.4.1. Select a sample to encode/decode<a class="headerlink" href="#4.4.1.-Select-a-sample-to-encode/decode" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[108]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_test_examples</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">78</span><span class="p">)</span>
<span class="n">test_examples_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_wf_test_ds</span><span class="p">)),</span> <span class="n">n_test_examples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[109]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_test_examples</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_test_examples</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ind_test</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">test_examples_ids</span><span class="p">):</span>
    <span class="n">test_wavefront</span><span class="p">,</span> <span class="n">test_target</span> <span class="o">=</span> <span class="n">mnist_wf_test_ds</span><span class="p">[</span><span class="n">ind_test</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_test</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_wavefront</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

    <span class="c1"># ax.set_xticks([])</span>
    <span class="c1"># ax.set_yticks([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_141_0.png" src="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_141_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.4.2.-Encode/decode-an-example">
<h2>4.4.2. Encode/decode an example<a class="headerlink" href="#4.4.2.-Encode/decode-an-example" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">encode_and_decode</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">input_wf</span><span class="p">,</span> <span class="n">use_encoder_aperture</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># if use_encoder_aperture is True - apply strickt square aperture to encoded image</span>
    <span class="c1"># aperture is defined as REGION_MASK, that was used in loss!</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="c1"># ENCODE</span>
        <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_wf</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PRESERVE_PHASE</span><span class="p">:</span>
            <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">encoded_image</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>  <span class="c1"># reset phases before decoding!</span>
        <span class="k">if</span> <span class="n">use_encoder_aperture</span><span class="p">:</span>
            <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">encoded_image</span> <span class="o">*</span> <span class="n">REGION_MASK</span>  <span class="c1"># apply aperture for encoded image</span>

        <span class="c1"># DECODE</span>
        <span class="n">decoded_image</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoded_image</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PRESERVE_PHASE</span><span class="p">:</span>
            <span class="n">decoded_image</span> <span class="o">=</span> <span class="n">decoded_image</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>  <span class="c1"># reset phases before decoding!</span>

    <span class="k">return</span> <span class="n">encoded_image</span><span class="p">,</span> <span class="n">decoded_image</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[110]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_lines</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># image / encoded / decoded</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_lines</span><span class="p">,</span> <span class="n">n_test_examples</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_test_examples</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_lines</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>

<span class="n">to_plot</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span>  <span class="c1"># &lt;--- chose what to plot</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span>  <span class="c1"># choose colormaps</span>
<span class="n">use_encoder_aperture</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">max_amp</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># upper limits for colorplots</span>
<span class="n">max_phase</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>

<span class="k">for</span> <span class="n">ind_ex</span><span class="p">,</span> <span class="n">ind_test</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_examples_ids</span><span class="p">):</span>
    <span class="n">ax_image</span><span class="p">,</span> <span class="n">ax_encoded</span><span class="p">,</span> <span class="n">ax_decoded</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span>

    <span class="n">test_wavefront</span><span class="p">,</span> <span class="n">test_target</span> <span class="o">=</span> <span class="n">mnist_wf_test_ds</span><span class="p">[</span><span class="n">ind_test</span><span class="p">]</span>

    <span class="n">ax_image</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;id=</span><span class="si">{</span><span class="n">ind_test</span><span class="si">}</span><span class="s1"> [</span><span class="si">{</span><span class="n">test_target</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
        <span class="n">ax_image</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">test_wavefront</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_amp</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
        <span class="n">ax_image</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">test_wavefront</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_phase</span>
        <span class="p">)</span>

    <span class="n">encoded_this</span><span class="p">,</span> <span class="n">decoded_this</span> <span class="o">=</span> <span class="n">encode_and_decode</span><span class="p">(</span>
        <span class="n">autoencoder_to_train</span><span class="p">,</span> <span class="n">test_wavefront</span><span class="p">,</span> <span class="n">use_encoder_aperture</span>
    <span class="p">)</span>

    <span class="n">ax_encoded</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;encoded&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">encoded_this</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_amp</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">encoded_this</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_phase</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">use_encoder_aperture</span><span class="p">:</span>  <span class="c1"># select only a part within apertures!</span>
        <span class="n">x_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">REGION_MASK_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">REGION_MASK_SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">x_frame</span><span class="p">,</span> <span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">x_frame</span><span class="p">])</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">y_frame</span><span class="p">,</span> <span class="n">y_frame</span><span class="p">])</span>

    <span class="n">ax_decoded</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;decoded&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
        <span class="n">ax_decoded</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">decoded_this</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_amp</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
        <span class="n">ax_decoded</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">decoded_this</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_phase</span>
        <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_148_0.png" src="../../_images/examples_notebook_diff_networks_examples_08_autoencoder_148_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="05_reservoir_mackey_glass.html" class="btn btn-neutral float-left" title="Reservoir computing for time series prediction of Mackey-Glass sequence" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="09_convolutional_4f.html" class="btn btn-neutral float-right" title="Convolutional Diffractive Network" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, CompPhysLab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>