

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Feed-forward Diffractive Optical Neural Network for MNIST task &mdash; SVETlANNa 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Reservoir computing for time series prediction of Mackey-Glass sequence" href="05_reservoir_mackey_glass.html" />
    <link rel="prev" title="Examples of diffractive optical networks" href="../../network_examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SVETlANNa
              <img src="../../_static/logo.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../physics.html">Physical Basis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Command reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../freeprop_examples.html">Examples of solving forward light propagation problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../phase_retrieval_examples.html">Examples of phase retrieval algorithms</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../network_examples.html">Examples of diffractive optical networks</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Feed-forward Diffractive Optical Neural Network for MNIST task</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Imports">Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#2.1.-MNIST-Dataset">2.1. MNIST Dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#2.1.1.-Train/Test-datasets-of-images">2.1.1. Train/Test datasets of images</a></li>
<li class="toctree-l4"><a class="reference internal" href="#2.1.2.-Train/Test-datasets-of-wavefronts">2.1.2. Train/Test datasets of wavefronts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.-Architecture">3.1. Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.1.-List-of-Elements">3.1.1. List of Elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.2.-Compose-LinearOpticalSetup">3.1.2. Compose <code class="docutils literal notranslate"><span class="pre">LinearOpticalSetup</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.3-Detector-processor">3.1.3 Detector processor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.1.1.-DataLoader's">4.1.1. <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>’s</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.1.2.-Optimizer-and-loss-function">4.1.2. Optimizer and loss function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.1.3.-Training-and-evaluation-loops">4.1.3. Training and evaluation loops</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.2.1.-Before-training">4.2.1. Before training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.2.2.-Training">4.2.2. Training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Learning-curves">Learning curves</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Saving">Saving</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.2.3.-Trained-masks">4.2.3. Trained masks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.2.4.-Applying-the-model-to-an-unknown-data-(test)">4.2.4. Applying the model to an unknown data (test)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.2.5.-Example-of-classification-for-a-random-wavefront-(propagation-through)">4.2.5. Example of classification for a random wavefront (propagation through)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="05_reservoir_mackey_glass.html">Reservoir computing for time series prediction of Mackey-Glass sequence</a></li>
<li class="toctree-l3"><a class="reference internal" href="08_autoencoder.html">Diffractive Autoencoder for MNIST classification task</a></li>
<li class="toctree-l3"><a class="reference internal" href="09_convolutional_4f.html">Convolutional Diffractive Network</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SVETlANNa</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../examples.html">Examples</a></li>
          <li class="breadcrumb-item"><a href="../../network_examples.html">Examples of diffractive optical networks</a></li>
      <li class="breadcrumb-item active">Feed-forward Diffractive Optical Neural Network for MNIST task</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/examples_notebook/diff_networks_examples/03_mnist_experiments.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Feed-forward-Diffractive-Optical-Neural-Network-for-MNIST-task">
<h1>Feed-forward Diffractive Optical Neural Network for MNIST task<a class="headerlink" href="#Feed-forward-Diffractive-Optical-Neural-Network-for-MNIST-task" title="Link to this heading"></a></h1>
<p>In that example notebook we will make some experiments^ based on a n opticel network architecture proposed in <a class="reference external" href="https://www.science.org/doi/10.1126/science.aat8084">the article</a>.</p>
<section id="Imports">
<h2>Imports<a class="headerlink" href="#Imports" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">transforms</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterpolationMode</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># our library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationParameters</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">BoundedParameter</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># our library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna</span><span class="w"> </span><span class="kn">import</span> <span class="n">Wavefront</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna</span><span class="w"> </span><span class="kn">import</span> <span class="n">elements</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.setup</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearOpticalSetup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.detector</span><span class="w"> </span><span class="kn">import</span> <span class="n">Detector</span><span class="p">,</span> <span class="n">DetectorProcessorClf</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToWavefront</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># datasets of wavefronts</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.wf_datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetOfWavefronts</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.wf_datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">IlluminatedApertureDataset</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1"># %config InlineBackend.figure_format = &#39;retina&#39;</span>
</pre></div>
</div>
</div>
<section id="0.-Experiment-parameters">
<h3>0. Experiment parameters<a class="headerlink" href="#0.-Experiment-parameters" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">working_frequency</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="mf">1e12</span> <span class="c1"># [Hz]</span>
<span class="n">C_CONST</span> <span class="o">=</span> <span class="mi">299_792_458</span>  <span class="c1"># [m / s]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EXP_NUMBER</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EXP_CONDITIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># SIMULATION PARAMS</span>
    <span class="s1">&#39;wavelength&#39;</span>  <span class="p">:</span> <span class="n">C_CONST</span> <span class="o">/</span> <span class="n">working_frequency</span><span class="p">,</span>  <span class="c1"># [m]</span>
    <span class="s1">&#39;layer_size_m&#39;</span><span class="p">:</span> <span class="mi">8</span> <span class="o">*</span> <span class="mf">1e-2</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># [m] - x and y sizes are equal!</span>
    <span class="s1">&#39;layer_nodes&#39;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">3</span><span class="p">),</span>  <span class="c1"># 100,</span>
    <span class="c1"># TOOLS</span>
    <span class="s1">&#39;tensorboard&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># to use tensorboard or not!</span>
    <span class="c1"># DATASET</span>
    <span class="s1">&#39;digit_resize&#39;</span> <span class="p">:</span> <span class="mi">17</span><span class="p">,</span>  <span class="c1"># the actual digit size after resize (in nodes)</span>
    <span class="s1">&#39;ds_apertures&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># if dataset is created with diigit-shaped apertures (True) or with direct modulation (False)</span>
        <span class="c1"># must be specified if &#39;ds_apertures&#39; == False, values: &#39;amp&#39;, &#39;phase&#39; or &#39;both&#39;</span>
    <span class="s1">&#39;ds_modulation&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># must be specified if &#39;ds_apertures&#39; == True</span>
    <span class="s1">&#39;gauss_waist_radius&#39;</span><span class="p">:</span> <span class="mf">2e-2</span><span class="p">,</span>  <span class="c1"># [m] - gaussian beam for dataset creation</span>
    <span class="s1">&#39;distance_to_aperture&#39;</span><span class="p">:</span> <span class="mf">3e-2</span><span class="p">,</span>  <span class="c1"># [m]</span>
    <span class="c1"># SETUP</span>
    <span class="s1">&#39;propagator&#39;</span><span class="p">:</span> <span class="s1">&#39;AS&#39;</span><span class="p">,</span>  <span class="c1"># FreeSpase propagation method: &#39;AS&#39; or &#39;fresnel&#39; (also needed for dataset with apertures)</span>
        <span class="c1"># diffractive layers</span>
    <span class="s1">&#39;n_diff_layers&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># number of diffractive layers</span>
    <span class="s1">&#39;diff_layer_max_phase&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>  <span class="c1"># maximal phase for each DiffractiveLayer</span>
    <span class="s1">&#39;diff_layer_mask_init&#39;</span><span class="p">:</span> <span class="s1">&#39;const&#39;</span><span class="p">,</span>  <span class="c1"># initialization of DiffractiveLayer masks: &#39;const&#39; or &#39;random&#39;</span>
    <span class="s1">&#39;diff_layers_seeds&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>  <span class="c1"># if &#39;random&#39;: seed to generate seeds to init all masks!</span>
        <span class="c1"># free space</span>
    <span class="s1">&#39;layers_distance&#39;</span><span class="p">:</span> <span class="mf">3e-2</span><span class="p">,</span>  <span class="c1"># [m], distance between layers</span>
        <span class="c1"># apertures</span>
    <span class="s1">&#39;add_apertures&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># if True - adds square apertures (in the middle) before each diffractive layer</span>
    <span class="s1">&#39;apertures_size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>  <span class="c1"># size of additional apertures in a setup</span>
        <span class="c1"># detector</span>
    <span class="s1">&#39;detector_zones&#39;</span><span class="p">:</span> <span class="s1">&#39;segments&#39;</span><span class="p">,</span>  <span class="c1"># form of a detector zones: &#39;squares&#39; or &#39;circles&#39; or &#39;strips&#39;</span>
    <span class="s1">&#39;detector_transpose&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># transpose detector or not (makes &#39;strips&#39; horizontal instead of vertical)</span>
    <span class="c1"># TRAINING PROCESS</span>
    <span class="s1">&#39;train_bs&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">&#39;val_bs&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>  <span class="c1"># batch sizes</span>
    <span class="s1">&#39;train_split_seed&#39;</span><span class="p">:</span> <span class="mi">178</span><span class="p">,</span>  <span class="c1"># seed for a data split on train/validation</span>
    <span class="s1">&#39;epochs&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import SummaryWriter from tensorboard</span>

<span class="k">if</span> <span class="s1">&#39;tensorboard&#39;</span> <span class="ow">in</span> <span class="n">EXP_CONDITIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;tensorboard&#39;</span><span class="p">]:</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.tensorboard</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummaryWriter</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">today_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)</span>

<span class="n">RESULTS_FOLDER</span> <span class="o">=</span> <span class="p">(</span>
    <span class="sa">f</span><span class="s1">&#39;models/03_mnist_experiments/</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s1">_experiment_</span><span class="si">{</span><span class="n">EXP_NUMBER</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>

<span class="n">RESULTS_FOLDER</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;models/03_mnist_experiments/13-12-2024_experiment_01&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">RESULTS_FOLDER</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">RESULTS_FOLDER</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save experiment conditions</span>
<span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">EXP_CONDITIONS</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/conditions.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># OR read conditions from file:</span>
<span class="c1"># EXP_CONDITIONS = json.load(open(f&#39;{RESULTS_FOLDER}/conditions.json))</span>
<span class="c1"># print(EXP_CONDITIONS)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="1.-Simulation-parameters">
<h3>1. Simulation parameters<a class="headerlink" href="#1.-Simulation-parameters" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">working_wavelength</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>  <span class="c1"># [m]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;lambda = </span><span class="si">{</span><span class="n">working_wavelength</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e6</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> um&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
lambda = 749.481 um
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># physical size of each layer (from the article) - (8 x 8) [cm]</span>
<span class="n">x_layer_size_m</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;layer_size_m&#39;</span><span class="p">]</span>  <span class="c1"># [m]</span>
<span class="n">y_layer_size_m</span> <span class="o">=</span> <span class="n">x_layer_size_m</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of neurons in simulation</span>
<span class="n">x_layer_nodes</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;layer_nodes&#39;</span><span class="p">]</span>
<span class="n">y_layer_nodes</span> <span class="o">=</span> <span class="n">x_layer_nodes</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer size (neurons): </span><span class="si">{</span><span class="n">x_layer_nodes</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">y_layer_nodes</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">x_layer_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_layer_nodes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Layer size (neurons): 150 x 150 = 22500
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neuron_size</span> <span class="o">=</span> <span class="n">x_layer_size_m</span> <span class="o">/</span> <span class="n">x_layer_nodes</span>  <span class="c1"># [m]  increase two times!</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Neuron size = </span><span class="si">{</span><span class="n">neuron_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e6</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> um&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Neuron size = 800.000 um
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simulation parameters for the rest of the notebook</span>

<span class="n">SIM_PARAMS</span> <span class="o">=</span> <span class="n">SimulationParameters</span><span class="p">(</span>
    <span class="n">axes</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">x_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x_layer_nodes</span><span class="p">),</span>
        <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">y_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_layer_nodes</span><span class="p">),</span>
        <span class="s1">&#39;wavelength&#39;</span><span class="p">:</span> <span class="n">working_wavelength</span><span class="p">,</span>  <span class="c1"># only one wavelength!</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="2.-Dataset-preparation-(Data-Engineer)">
<h3>2. Dataset preparation (Data Engineer)<a class="headerlink" href="#2.-Dataset-preparation-(Data-Engineer)" title="Link to this heading"></a></h3>
</section>
</section>
<section id="2.1.-MNIST-Dataset">
<h2>2.1. <a class="reference external" href="https://www.kaggle.com/datasets/hojjatk/mnist-dataset">MNIST Dataset</a><a class="headerlink" href="#2.1.-MNIST-Dataset" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize a directory for a dataset</span>
<span class="n">MNIST_DATA_FOLDER</span> <span class="o">=</span> <span class="s1">&#39;./data&#39;</span>  <span class="c1"># folder to store data</span>
</pre></div>
</div>
</div>
</section>
<section id="2.1.1.-Train/Test-datasets-of-images">
<h2>2.1.1. Train/Test datasets of images<a class="headerlink" href="#2.1.1.-Train/Test-datasets-of-images" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TRAIN (images)</span>
<span class="n">mnist_train_ds</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="n">MNIST_DATA_FOLDER</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># for train dataset</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TEST (images)</span>
<span class="n">mnist_test_ds</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="n">MNIST_DATA_FOLDER</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># for test dataset</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test data : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_test_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Train data: 60000
Test data : 10000
</pre></div></div>
</div>
</section>
<section id="2.1.2.-Train/Test-datasets-of-wavefronts">
<h2>2.1.2. Train/Test datasets of wavefronts<a class="headerlink" href="#2.1.2.-Train/Test-datasets-of-wavefronts" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DS_WITH_APERTURES</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;ds_apertures&#39;</span><span class="p">]</span>
<span class="c1"># if True we use IlluminatedApertureDataset to create datasets of Wavefronts</span>
<span class="c1"># else - DatasetOfWavefronts</span>
<span class="n">DS_WITH_APERTURES</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select modulation type for DatasetOfWavefronts if DS_WITH_APERTURES == False</span>
<span class="n">MODULATION_TYPE</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;ds_modulation&#39;</span><span class="p">]</span>  <span class="c1"># &#39;phase&#39;, &#39;amp&#39;, &#39;amp&amp;phase&#39;</span>

<span class="c1"># select method and distance for a FreeSpace in IlluminatedApertureDataset</span>
<span class="n">DS_METHOD</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;propagator&#39;</span><span class="p">]</span>
<span class="n">DS_DISTANCE</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;distance_to_aperture&#39;</span><span class="p">]</span>  <span class="c1"># [m]</span>

<span class="n">DS_BEAM</span> <span class="o">=</span> <span class="n">Wavefront</span><span class="o">.</span><span class="n">gaussian_beam</span><span class="p">(</span>
    <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>
    <span class="n">waist_radius</span><span class="o">=</span><span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;gauss_waist_radius&#39;</span><span class="p">],</span>  <span class="c1"># [m]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># image resize to match SimulationParameters</span>
<span class="n">resize_y</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;digit_resize&#39;</span><span class="p">]</span>
<span class="n">resize_x</span> <span class="o">=</span> <span class="n">resize_y</span>  <span class="c1"># shape for transforms.Resize</span>

<span class="n">pad_top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">resize_y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pad_bottom</span> <span class="o">=</span> <span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">pad_top</span> <span class="o">-</span> <span class="n">resize_y</span>
<span class="n">pad_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">resize_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pad_right</span> <span class="o">=</span> <span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">pad_left</span> <span class="o">-</span> <span class="n">resize_x</span>  <span class="c1"># params for transforms.Pad</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compose all transforms for DatasetOfWavefronts</span>
<span class="n">image_transform_for_ds</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
  <span class="p">[</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span>
          <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">resize_y</span><span class="p">,</span> <span class="n">resize_x</span><span class="p">),</span>
          <span class="n">interpolation</span><span class="o">=</span><span class="n">InterpolationMode</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">,</span>
      <span class="p">),</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">Pad</span><span class="p">(</span>
          <span class="n">padding</span><span class="o">=</span><span class="p">(</span>
              <span class="n">pad_left</span><span class="p">,</span>  <span class="c1"># left padding</span>
              <span class="n">pad_top</span><span class="p">,</span>  <span class="c1"># top padding</span>
              <span class="n">pad_right</span><span class="p">,</span>  <span class="c1"># right padding</span>
              <span class="n">pad_bottom</span>  <span class="c1"># bottom padding</span>
          <span class="p">),</span>
          <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
      <span class="p">),</span>  <span class="c1"># padding to match sizes!</span>
      <span class="n">ToWavefront</span><span class="p">(</span><span class="n">modulation_type</span><span class="o">=</span><span class="n">MODULATION_TYPE</span><span class="p">)</span>  <span class="c1"># &lt;- select modulation type!!!</span>
  <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># compose all transforms for IlluminatedApertureDataset</span>
<span class="n">image_to_aperture</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
  <span class="p">[</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span>
          <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">resize_y</span><span class="p">,</span> <span class="n">resize_x</span><span class="p">),</span>
          <span class="n">interpolation</span><span class="o">=</span><span class="n">InterpolationMode</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">,</span>
      <span class="p">),</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">Pad</span><span class="p">(</span>
          <span class="n">padding</span><span class="o">=</span><span class="p">(</span>
              <span class="n">pad_left</span><span class="p">,</span>  <span class="c1"># left padding</span>
              <span class="n">pad_top</span><span class="p">,</span>  <span class="c1"># top padding</span>
              <span class="n">pad_right</span><span class="p">,</span>  <span class="c1"># right padding</span>
              <span class="n">pad_bottom</span>  <span class="c1"># bottom padding</span>
          <span class="p">),</span>
          <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
      <span class="p">),</span>  <span class="c1"># padding to match sizes!</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TRAIN dataset of WAVEFRONTS</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">DS_WITH_APERTURES</span><span class="p">:</span>
    <span class="n">mnist_wf_train_ds</span> <span class="o">=</span> <span class="n">DatasetOfWavefronts</span><span class="p">(</span>
        <span class="n">init_ds</span><span class="o">=</span><span class="n">mnist_train_ds</span><span class="p">,</span>  <span class="c1"># dataset of images</span>
        <span class="n">transformations</span><span class="o">=</span><span class="n">image_transform_for_ds</span><span class="p">,</span>  <span class="c1"># image transformation</span>
        <span class="n">sim_params</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>  <span class="c1"># simulation parameters</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">mnist_wf_train_ds</span> <span class="o">=</span> <span class="n">IlluminatedApertureDataset</span><span class="p">(</span>
        <span class="n">init_ds</span><span class="o">=</span><span class="n">mnist_train_ds</span><span class="p">,</span>  <span class="c1"># dataset of images</span>
        <span class="n">transformations</span><span class="o">=</span><span class="n">image_to_aperture</span><span class="p">,</span>  <span class="c1"># image transformation</span>
        <span class="n">sim_params</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>  <span class="c1"># simulation parameters</span>
        <span class="n">beam_field</span><span class="o">=</span><span class="n">DS_BEAM</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">DS_DISTANCE</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">DS_METHOD</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TEST dataset of WAVEFRONTS</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">DS_WITH_APERTURES</span><span class="p">:</span>
    <span class="n">mnist_wf_test_ds</span> <span class="o">=</span> <span class="n">DatasetOfWavefronts</span><span class="p">(</span>
        <span class="n">init_ds</span><span class="o">=</span><span class="n">mnist_test_ds</span><span class="p">,</span>  <span class="c1"># dataset of images</span>
        <span class="n">transformations</span><span class="o">=</span><span class="n">image_transform_for_ds</span><span class="p">,</span>  <span class="c1"># image transformation</span>
        <span class="n">sim_params</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>  <span class="c1"># simulation parameters</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">mnist_wf_test_ds</span> <span class="o">=</span> <span class="n">IlluminatedApertureDataset</span><span class="p">(</span>
        <span class="n">init_ds</span><span class="o">=</span><span class="n">mnist_test_ds</span><span class="p">,</span>  <span class="c1"># dataset of images</span>
        <span class="n">transformations</span><span class="o">=</span><span class="n">image_to_aperture</span><span class="p">,</span>  <span class="c1"># image transformation</span>
        <span class="n">sim_params</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>  <span class="c1"># simulation parameters</span>
        <span class="n">beam_field</span><span class="o">=</span><span class="n">DS_BEAM</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">DS_DISTANCE</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">DS_METHOD</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_wf_train_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test data : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_wf_test_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Train data: 60000
Test data : 10000
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot several EXAMPLES from TRAIN dataset</span>
<span class="n">n_examples</span><span class="o">=</span> <span class="mi">4</span>  <span class="c1"># number of examples to plot</span>
<span class="c1"># choosing indecies of images (from train) to plot</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">78</span><span class="p">)</span>
<span class="n">train_examples_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_ds</span><span class="p">)),</span> <span class="n">n_examples</span><span class="p">)</span>

<span class="n">all_examples_wavefronts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;hot&#39;</span>

<span class="n">n_lines</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_lines</span><span class="p">,</span> <span class="n">n_examples</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_examples</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_lines</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ind_ex</span><span class="p">,</span> <span class="n">ind_train</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_examples_ids</span><span class="p">):</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">mnist_train_ds</span><span class="p">[</span><span class="n">ind_train</span><span class="p">]</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;id=</span><span class="si">{</span><span class="n">ind_train</span><span class="si">}</span><span class="s1"> [</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

    <span class="n">wavefront</span><span class="p">,</span> <span class="n">wf_label</span> <span class="o">=</span> <span class="n">mnist_wf_train_ds</span><span class="p">[</span><span class="n">ind_train</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wavefront</span><span class="p">,</span> <span class="n">Wavefront</span><span class="p">)</span>

    <span class="n">all_examples_wavefronts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wavefront</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;$|WF|^2$&#39;</span><span class="p">)</span>
    <span class="c1"># here we can plot intensity for a wavefront</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">wavefront</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;phase of $WF$&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">wavefront</span><span class="o">.</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
    <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_51_0.png" src="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_51_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="3.-Optical-network">
<h3>3. Optical network<a class="headerlink" href="#3.-Optical-network" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_OF_DIFF_LAYERS</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;n_diff_layers&#39;</span><span class="p">]</span>  <span class="c1"># number of diffractive layers</span>
<span class="n">FREE_SPACE_DISTANCE</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;layers_distance&#39;</span><span class="p">]</span>  <span class="c1"># [m]</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="3.1.-Architecture">
<h2>3.1. Architecture<a class="headerlink" href="#3.1.-Architecture" title="Link to this heading"></a></h2>
</section>
<section id="3.1.1.-List-of-Elements">
<h2>3.1.1. List of Elements<a class="headerlink" href="#3.1.1.-List-of-Elements" title="Link to this heading"></a></h2>
<blockquote>
<div><p>To help with the 3D-printing and fabrication of the <span class="math notranslate nohighlight">\(D^2NN\)</span> design, a sigmoid function was used to limit the phase value of each neuron to <span class="math notranslate nohighlight">\(0-2π\)</span> and <span class="math notranslate nohighlight">\(0-π\)</span>, for imaging and classifier networks, respectively.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAX_PHASE</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;diff_layer_max_phase&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.for_setup</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_const_free_space</span><span class="p">,</span> <span class="n">get_random_diffractive_layer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">functional</span>
</pre></div>
</div>
</div>
<p>Function to construct a list of elements:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WE WILL ADD APERTURES BEFORE EACH DIFFRACTIVE LAYER OF THE SIZE:</span>
<span class="n">ADD_APERTURES</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;add_apertures&#39;</span><span class="p">]</span>
<span class="n">APERTURE_SZ</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;apertures_size&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_elements_list</span><span class="p">(</span>
    <span class="n">num_layers</span><span class="p">,</span>
    <span class="n">simulation_parameters</span><span class="p">:</span> <span class="n">SimulationParameters</span><span class="p">,</span>
    <span class="n">freespace_method</span><span class="p">,</span>
    <span class="n">masks_seeds</span><span class="p">,</span>
    <span class="n">apertures</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">aperture_size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Composes a list of elements for setup.</span>
<span class="sd">        Optical system: FS|DL|FS|...|FS|DL|FS|Detector</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_layers : int</span>
<span class="sd">        Number of layers in the system.</span>
<span class="sd">    simulation_parameters : SimulationParameters()</span>
<span class="sd">        A simulation parameters for a task.</span>
<span class="sd">    freespace_method : str</span>
<span class="sd">        Propagation method for free spaces in a setup.</span>
<span class="sd">    masks_seeds : torch.Tensor()</span>
<span class="sd">        Torch tensor of random seeds to generate masks for diffractive layers.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    elements_list : list(Element)</span>
<span class="sd">        List of Elements for an optical setup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elements_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of elements</span>

    <span class="k">if</span> <span class="n">apertures</span><span class="p">:</span>  <span class="c1"># equal masks for all apertures (select a part in the middle)</span>
        <span class="n">aperture_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">aperture_size</span><span class="p">)</span>

        <span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">simulation_parameters</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span><span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">))</span>
        <span class="n">y_mask</span><span class="p">,</span> <span class="n">x_mask</span> <span class="o">=</span> <span class="n">aperture_mask</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">pad_top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y_nodes</span> <span class="o">-</span> <span class="n">y_mask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pad_bottom</span> <span class="o">=</span> <span class="n">y_nodes</span> <span class="o">-</span> <span class="n">pad_top</span> <span class="o">-</span> <span class="n">y_mask</span>
        <span class="n">pad_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_nodes</span> <span class="o">-</span> <span class="n">x_mask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pad_right</span> <span class="o">=</span> <span class="n">x_nodes</span> <span class="o">-</span> <span class="n">pad_left</span> <span class="o">-</span> <span class="n">x_mask</span>  <span class="c1"># params for transforms.Pad</span>

        <span class="c1"># padding transform to match aperture size with simulation parameters</span>
        <span class="n">aperture_mask</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">aperture_mask</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="n">pad_left</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">,</span> <span class="n">pad_top</span><span class="p">,</span> <span class="n">pad_bottom</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

    <span class="c1"># compose architecture</span>
    <span class="k">for</span> <span class="n">ind_layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ind_layer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># first FreeSpace layer before first DiffractiveLayer</span>
            <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">get_const_free_space</span><span class="p">(</span>
                    <span class="n">simulation_parameters</span><span class="p">,</span>  <span class="c1"># simulation parameters for the notebook</span>
                    <span class="n">FREE_SPACE_DISTANCE</span><span class="p">,</span>  <span class="c1"># in [m]</span>
                    <span class="n">freespace_method</span><span class="o">=</span><span class="n">freespace_method</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># add aperture before each diffractive layer</span>
        <span class="k">if</span> <span class="n">apertures</span><span class="p">:</span>
            <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">Aperture</span><span class="p">(</span>
                    <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">simulation_parameters</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">aperture_mask</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># add DiffractiveLayer</span>
        <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">get_random_diffractive_layer</span><span class="p">(</span>
                <span class="n">simulation_parameters</span><span class="p">,</span>  <span class="c1"># simulation parameters for the notebook</span>
                <span class="n">mask_seed</span><span class="o">=</span><span class="n">masks_seeds</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="n">max_phase</span><span class="o">=</span><span class="n">MAX_PHASE</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># add FreeSpace</span>
        <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">get_const_free_space</span><span class="p">(</span>
                <span class="n">simulation_parameters</span><span class="p">,</span>  <span class="c1"># simulation parameters for the notebook</span>
                <span class="n">FREE_SPACE_DISTANCE</span><span class="p">,</span>  <span class="c1"># in [m]</span>
                <span class="n">freespace_method</span><span class="o">=</span><span class="n">freespace_method</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># add Detector in the end of the system!</span>
    <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Detector</span><span class="p">(</span>
            <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">simulation_parameters</span><span class="p">,</span>
            <span class="n">func</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span>  <span class="c1"># detector that returns intensity</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">elements_list</span>
</pre></div>
</div>
</div>
<p>Constants for a setup initialization:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FREESPACE_METHOD</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;propagator&#39;</span><span class="p">]</span> <span class="c1"># TODO: &#39;AS&#39; returns nan&#39;s?</span>

<span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;diff_layer_mask_init&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
    <span class="n">MASKS_SEEDS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
        <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">NUM_OF_DIFF_LAYERS</span><span class="p">,),</span>
        <span class="n">generator</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;diff_layers_seeds&#39;</span><span class="p">])</span>
        <span class="c1"># to generate the same set of initial masks</span>
    <span class="p">)</span>  <span class="c1"># for the same random generation</span>

<span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;diff_layer_mask_init&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;const&#39;</span><span class="p">:</span>
    <span class="n">MASKS_SEEDS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">NUM_OF_DIFF_LAYERS</span><span class="p">,))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># constant masks init</span>

<span class="n">MASKS_SEEDS</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.5708, 1.5708, 1.5708, 1.5708, 1.5708])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="3.1.2.-Compose-LinearOpticalSetup">
<h2>3.1.2. Compose <code class="docutils literal notranslate"><span class="pre">LinearOpticalSetup</span></code><a class="headerlink" href="#3.1.2.-Compose-LinearOpticalSetup" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_setup</span><span class="p">(</span>
    <span class="n">simulation_parameters</span><span class="p">,</span>
    <span class="n">num_layers</span><span class="p">,</span>
    <span class="n">apertures</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">aperture_size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an optical setup. Recreates all elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elements_list</span> <span class="o">=</span> <span class="n">get_elements_list</span><span class="p">(</span>
        <span class="n">num_layers</span><span class="p">,</span>
        <span class="n">simulation_parameters</span><span class="p">,</span>
        <span class="n">FREESPACE_METHOD</span><span class="p">,</span>
        <span class="n">MASKS_SEEDS</span><span class="p">,</span>
        <span class="n">apertures</span><span class="o">=</span><span class="n">apertures</span><span class="p">,</span>
        <span class="n">aperture_size</span><span class="o">=</span><span class="n">aperture_size</span>
    <span class="p">)</span>  <span class="c1"># recreate a list of elements</span>

    <span class="k">return</span> <span class="n">LinearOpticalSetup</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="n">elements_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lin_optical_setup</span> <span class="o">=</span> <span class="n">get_setup</span><span class="p">(</span>
    <span class="n">SIM_PARAMS</span><span class="p">,</span>
    <span class="n">NUM_OF_DIFF_LAYERS</span><span class="p">,</span>
    <span class="n">apertures</span><span class="o">=</span><span class="n">ADD_APERTURES</span><span class="p">,</span>
    <span class="n">aperture_size</span><span class="o">=</span><span class="n">APERTURE_SZ</span>
<span class="p">)</span>
<span class="c1"># Comment: Lin - a surname of the first author of the article</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Sequential(
  (0): FreeSpace()
  (1): Aperture()
  (2): DiffractiveLayer()
  (3): FreeSpace()
  (4): Aperture()
  (5): DiffractiveLayer()
  (6): FreeSpace()
  (7): Aperture()
  (8): DiffractiveLayer()
  (9): FreeSpace()
  (10): Aperture()
  (11): DiffractiveLayer()
  (12): FreeSpace()
  (13): Aperture()
  (14): DiffractiveLayer()
  (15): FreeSpace()
  (16): Detector()
)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">example_wf</span> <span class="o">=</span> <span class="n">mnist_wf_train_ds</span><span class="p">[</span><span class="mi">128</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mnist_wf_train_ds</span><span class="p">[</span><span class="mi">128</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">setup_scheme</span><span class="p">,</span> <span class="n">wavefronts</span> <span class="o">=</span> <span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">stepwise_forward</span><span class="p">(</span><span class="n">example_wf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">setup_scheme</span><span class="p">)</span>  <span class="c1"># prints propagation scheme</span>

<span class="n">n_cols</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># number of columns to plot all wavefronts during propagation</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">to_plot</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span>  <span class="c1"># &lt;--- chose what to plot</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span>  <span class="c1"># choose colormaps</span>
<span class="n">detector_cmap</span> <span class="o">=</span> <span class="s1">&#39;hot&#39;</span>

<span class="c1"># create a figure with subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>

<span class="c1"># turn off unecessary axes</span>
<span class="k">for</span> <span class="n">ind_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ind_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
        <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_row</span><span class="p">][</span><span class="n">ind_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ind_row</span> <span class="o">*</span> <span class="n">n_cols</span> <span class="o">+</span> <span class="n">ind_col</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavefronts</span><span class="p">):</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="c1"># plot wavefronts</span>
<span class="k">for</span> <span class="n">ind_wf</span><span class="p">,</span> <span class="n">wavefront</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wavefronts</span><span class="p">):</span>
    <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_wf</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">][</span><span class="n">ind_wf</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
        <span class="c1"># plot angle for each wavefront, because intensities pictures are indistinguishable from each other</span>
        <span class="k">if</span> <span class="n">ind_wf</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavefronts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Phase for $WF_{&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_wf</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;}$&#39;</span><span class="p">)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">wavefront</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># (not a wavefront!)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Detector phase ($WF_{&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_wf</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;})$&#39;</span><span class="p">)</span>
            <span class="c1"># Detector has no phase!</span>

    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
        <span class="c1"># plot angle for each wavefront, because intensities pictures are indistinguishable from each other</span>
        <span class="k">if</span> <span class="n">ind_wf</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavefronts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intensity for $WF_{&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_wf</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;}$&#39;</span><span class="p">)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">wavefront</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="c1"># vmin=0, vmax=max_intensity  # uncomment to make the same limits</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Detector output (not a wavefront!)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Detector Intensity ($WF_{&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_wf</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;})$&#39;</span><span class="p">)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">wavefront</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">detector_cmap</span><span class="p">,</span>
                <span class="c1"># vmin=0, vmax=max_intensity  # uncomment to make the same limits</span>
            <span class="p">)</span>

    <span class="c1"># Comment: Detector output is Tensor! It has no methods of Wavefront (like .phase or .intensity)!</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-(0)-&gt; [1. FreeSpace] -(1)-&gt; [2. Aperture] -(2)-&gt; [3. DiffractiveLayer] -(3)-&gt; [4. FreeSpace] -(4)-&gt; [5. Aperture] -(5)-&gt; [6. DiffractiveLayer] -(6)-&gt; [7. FreeSpace] -(7)-&gt; [8. Aperture] -(8)-&gt; [9. DiffractiveLayer] -(9)-&gt; [10. FreeSpace] -(10)-&gt; [11. Aperture] -(11)-&gt; [12. DiffractiveLayer] -(12)-&gt; [13. FreeSpace] -(13)-&gt; [14. Aperture] -(14)-&gt; [15. DiffractiveLayer] -(15)-&gt; [16. FreeSpace] -(16)-&gt; [17. Detector] -(17)-&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_75_1.png" src="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_75_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="3.1.3-Detector-processor">
<h2>3.1.3 Detector processor<a class="headerlink" href="#3.1.3-Detector-processor" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">number_of_classes</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">src.detector_segmentation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">detector_segmentation</span>
<span class="c1"># Functions to segment detector: squares_mnist, circles, angular_segments</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ADD_APERTURES</span> <span class="ow">or</span> <span class="n">APERTURE_SZ</span><span class="p">:</span>
    <span class="n">y_detector_nodes</span><span class="p">,</span> <span class="n">x_detector_nodes</span> <span class="o">=</span> <span class="n">APERTURE_SZ</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">y_detector_nodes</span><span class="p">,</span> <span class="n">x_detector_nodes</span> <span class="o">=</span> <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span><span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ADD_APERTURES</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">detector_squares_mask</span> <span class="o">=</span> <span class="n">detector_segmentation</span><span class="o">.</span><span class="n">squares_mnist</span><span class="p">(</span>
    <span class="n">y_detector_nodes</span><span class="p">,</span> <span class="n">x_detector_nodes</span><span class="p">,</span>  <span class="c1"># size of a detector or an aperture (in the middle of detector)</span>
    <span class="n">SIM_PARAMS</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">detector_circles_mask</span> <span class="o">=</span> <span class="n">detector_segmentation</span><span class="o">.</span><span class="n">circles</span><span class="p">(</span>
    <span class="n">y_detector_nodes</span><span class="p">,</span> <span class="n">x_detector_nodes</span><span class="p">,</span>  <span class="c1"># size of a detector or an aperture (in the middle of detector)</span>
    <span class="n">number_of_classes</span><span class="p">,</span>
    <span class="n">SIM_PARAMS</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">detector_angles_mask</span> <span class="o">=</span> <span class="n">detector_segmentation</span><span class="o">.</span><span class="n">angular_segments</span><span class="p">(</span>
    <span class="n">y_detector_nodes</span><span class="p">,</span> <span class="n">x_detector_nodes</span><span class="p">,</span>  <span class="c1"># size of a detector or an aperture (in the middle of detector)</span>
    <span class="n">number_of_classes</span><span class="p">,</span>
    <span class="n">SIM_PARAMS</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CIRCLES_ZONES</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;detector_zones&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;circles&#39;</span>
<span class="n">CIRCLES_ZONES</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
False
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;detector_zones&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;circles&#39;</span><span class="p">:</span>
    <span class="n">selected_mask</span> <span class="o">=</span> <span class="n">detector_circles_mask</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;circles selected!&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;detector_zones&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;squares&#39;</span><span class="p">:</span>
    <span class="n">selected_mask</span> <span class="o">=</span> <span class="n">detector_squares_mask</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;squares selected!&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;detector_zones&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;segments&#39;</span><span class="p">:</span>
    <span class="n">selected_mask</span> <span class="o">=</span> <span class="n">detector_angles_mask</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;angular segments selected!&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;detector_zones&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;strips&#39;</span><span class="p">:</span>
    <span class="n">selected_mask</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;strips selected!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
angular segments selected!
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">detector_processor</span> <span class="o">=</span> <span class="n">DetectorProcessorClf</span><span class="p">(</span>
    <span class="n">num_classes</span><span class="o">=</span><span class="n">number_of_classes</span><span class="p">,</span>
    <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>
    <span class="n">segmented_detector</span><span class="o">=</span><span class="n">selected_mask</span><span class="p">,</span>  <span class="c1"># choose a mask!</span>
    <span class="n">segments_zone_size</span><span class="o">=</span><span class="n">APERTURE_SZ</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;detector_transpose&#39;</span> <span class="ow">in</span> <span class="n">EXP_CONDITIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;detector_transpose&#39;</span><span class="p">]:</span>
        <span class="n">detector_processor</span><span class="o">.</span><span class="n">segmented_detector</span> <span class="o">=</span> <span class="n">detector_processor</span><span class="o">.</span><span class="n">segmented_detector</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Detector segments&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">detector_processor</span><span class="o">.</span><span class="n">segmented_detector</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_95_0.png" src="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_95_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ZONES_HIGHLIGHT_COLOR</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
<span class="n">ZONES_LW</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">selected_detector_mask</span> <span class="o">=</span> <span class="n">detector_processor</span><span class="o">.</span><span class="n">segmented_detector</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_zones_patches</span><span class="p">(</span><span class="n">detector_mask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of patches to draw zones in final visualisation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zones_patches</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;detector_zones&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;circles&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ind_class</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_classes</span><span class="p">):</span>
            <span class="c1"># use `circles_radiuses`, `x_layer_size_m`, `x_layer_nodes`</span>
            <span class="n">rad_this</span> <span class="o">=</span> <span class="p">(</span><span class="n">circles_radiuses</span><span class="p">[</span><span class="n">ind_class</span><span class="p">]</span> <span class="o">/</span> <span class="n">x_layer_size_m</span> <span class="o">*</span> <span class="n">x_layer_nodes</span><span class="p">)</span>

            <span class="n">zone_circ</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x_layer_nodes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_layer_nodes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">rad_this</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">ZONES_LW</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="n">ZONES_HIGHLIGHT_COLOR</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>
            <span class="p">)</span>

            <span class="n">zones_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone_circ</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;detector_zones&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;segments&#39;</span><span class="p">:</span>
            <span class="n">class_segment_angle</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">number_of_classes</span>
            <span class="n">len_lines_nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_layer_nodes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">idx_y</span><span class="p">,</span> <span class="n">idx_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">detector_mask</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">zone_rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">idx_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">,</span> <span class="n">idx_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">),</span>
                <span class="n">idx_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">delta</span><span class="p">,</span> <span class="n">idx_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">delta</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">ZONES_LW</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="n">ZONES_HIGHLIGHT_COLOR</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>
            <span class="p">)</span>
            <span class="n">zones_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone_rect</span><span class="p">)</span>

            <span class="n">ang</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_layer_nodes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_layer_nodes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind_class</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_classes</span><span class="p">):</span>
                <span class="n">path_line</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">),</span>
                        <span class="p">(</span>
                            <span class="n">x_center</span> <span class="o">+</span> <span class="n">len_lines_nodes</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">),</span>
                            <span class="n">y_center</span> <span class="o">+</span> <span class="n">len_lines_nodes</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">],</span>
                    <span class="p">[</span>
                        <span class="n">Path</span><span class="o">.</span><span class="n">MOVETO</span><span class="p">,</span>
                        <span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">bound_line</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">PathPatch</span><span class="p">(</span>
                    <span class="n">path_line</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                    <span class="n">lw</span><span class="o">=</span><span class="n">ZONES_LW</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="n">ZONES_HIGHLIGHT_COLOR</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">zones_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bound_line</span><span class="p">)</span>

                <span class="n">ang</span> <span class="o">+=</span> <span class="n">class_segment_angle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.5</span>

            <span class="k">for</span> <span class="n">ind_class</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_classes</span><span class="p">):</span>
                <span class="n">idx_y</span><span class="p">,</span> <span class="n">idx_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">detector_mask</span> <span class="o">==</span> <span class="n">ind_class</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">zone_rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">idx_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">,</span> <span class="n">idx_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">),</span>
                    <span class="n">idx_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">delta</span><span class="p">,</span> <span class="n">idx_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">delta</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="n">ZONES_LW</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="n">ZONES_HIGHLIGHT_COLOR</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>
                <span class="p">)</span>

                <span class="n">zones_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone_rect</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">zones_patches</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="4.-Training-of-the-network">
<h3>4. Training of the network<a class="headerlink" href="#4.-Training-of-the-network" title="Link to this heading"></a></h3>
<p>Variables at the moment</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lin_optical_setup</span></code> : <code class="docutils literal notranslate"><span class="pre">LinearOpticalSetup</span></code> – a linear optical network composed of Elements</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">detector_processor</span></code> : <code class="docutils literal notranslate"><span class="pre">DetectorProcessorClf</span></code> – this layer process an image from the detector and calculates probabilities of belonging to classes.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="c1"># if DEVICE == torch.device(&#39;cpu&#39;):</span>
<span class="c1">#     DEVICE = torch.device(&#39;mps&#39; if torch.backends.mps.is_available() else &#39;cpu&#39;)</span>

<span class="n">DEVICE</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
device(type=&#39;cpu&#39;)
</pre></div></div>
</div>
</section>
<section id="4.1.-Prepare-some-stuff-for-training">
<h3>4.1. Prepare some stuff for training<a class="headerlink" href="#4.1.-Prepare-some-stuff-for-training" title="Link to this heading"></a></h3>
</section>
</section>
<section id="4.1.1.-DataLoader's">
<h2>4.1.1. <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>’s<a class="headerlink" href="#4.1.1.-DataLoader's" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_bs</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;train_bs&#39;</span><span class="p">]</span>  <span class="c1"># a batch size for training set</span>
<span class="n">val_bs</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;val_bs&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<blockquote>
<div><p>Forthis task, phase-only transmission masks weredesigned by training a five-layer <span class="math notranslate nohighlight">\(D^2 NN\)</span> with <span class="math notranslate nohighlight">\(55000\)</span> images (<span class="math notranslate nohighlight">\(5000\)</span> validation images) from theMNIST (Modified National Institute of Stan-dards and Technology) handwritten digit data-base.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mnist_wf_train_ds</span>
<span class="n">train_wf_ds</span><span class="p">,</span> <span class="n">val_wf_ds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">mnist_wf_train_ds</span><span class="p">,</span>
    <span class="n">lengths</span><span class="o">=</span><span class="p">[</span><span class="mi">55000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">],</span>  <span class="c1"># sizes from the article</span>
    <span class="n">generator</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;train_split_seed&#39;</span><span class="p">])</span>  <span class="c1"># for reproducibility</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_wf_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">train_wf_ds</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">train_bs</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># num_workers=2,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">val_wf_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">val_wf_ds</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">val_bs</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># num_workers=2,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.1.2.-Optimizer-and-loss-function">
<h2>4.1.2. Optimizer and loss function<a class="headerlink" href="#4.1.2.-Optimizer-and-loss-function" title="Link to this heading"></a></h2>
<p>Info from <a class="reference external" href="https://www.science.org/doi/suppl/10.1126/science.aat8084/suppl_file/aat8084-lin-sm-rev-3.pdf">a supplementary material</a> for MNIST classification:</p>
<blockquote>
<div><p>We used the stochastic gradient descent algorithm, Adam, to back-propagate the errors and update the layers of the network to minimize the loss function.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer_clf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
    <span class="n">params</span><span class="o">=</span><span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>  <span class="c1"># NETWORK PARAMETERS!</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_func_clf</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">loss_func_name</span> <span class="o">=</span> <span class="s1">&#39;CE loss&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.1.3.-Training-and-evaluation-loops">
<h2>4.1.3. Training and evaluation loops<a class="headerlink" href="#4.1.3.-Training-and-evaluation-loops" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">src.clf_loops</span><span class="w"> </span><span class="kn">import</span> <span class="n">onn_train_clf</span><span class="p">,</span> <span class="n">onn_validate_clf</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="4.2.-Training-of-the-optical-network">
<h3>4.2. Training of the optical network<a class="headerlink" href="#4.2.-Training-of-the-optical-network" title="Link to this heading"></a></h3>
</section>
</section>
<section id="4.2.1.-Before-training">
<h2>4.2.1. Before training<a class="headerlink" href="#4.2.1.-Before-training" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cols</span> <span class="o">=</span> <span class="n">NUM_OF_DIFF_LAYERS</span>  <span class="c1"># number of columns for DiffractiveLayer&#39;s masks visualization</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">lin_architecture_elements_list</span> <span class="o">=</span> <span class="n">get_elements_list</span><span class="p">(</span>
    <span class="n">NUM_OF_DIFF_LAYERS</span><span class="p">,</span>
    <span class="n">SIM_PARAMS</span><span class="p">,</span>
    <span class="n">FREESPACE_METHOD</span><span class="p">,</span>
    <span class="n">MASKS_SEEDS</span><span class="p">,</span>
    <span class="n">apertures</span><span class="o">=</span><span class="n">ADD_APERTURES</span><span class="p">,</span>
    <span class="n">aperture_size</span><span class="o">=</span><span class="n">APERTURE_SZ</span>
<span class="p">)</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gist_stern&#39;</span>

<span class="c1"># plot wavefronts phase</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>
<span class="n">ind_diff_layer</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">ind_layer</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lin_architecture_elements_list</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">elements</span><span class="o">.</span><span class="n">DiffractiveLayer</span><span class="p">):</span>  <span class="c1"># plot masks for Diffractive layers</span>
        <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_diff_layer</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">][</span><span class="n">ind_diff_layer</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_diff_layer</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>

        <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_layer</span><span class="si">}</span><span class="s1">. DiffractiveLayer&#39;</span><span class="p">)</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">MAX_PHASE</span>
        <span class="p">)</span>

        <span class="n">ind_diff_layer</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_120_0.png" src="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_120_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lin_optical_setup</span> <span class="o">=</span> <span class="n">get_setup</span><span class="p">(</span>
    <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span>
    <span class="n">NUM_OF_DIFF_LAYERS</span><span class="p">,</span>
    <span class="n">apertures</span><span class="o">=</span><span class="n">ADD_APERTURES</span><span class="p">,</span>
    <span class="n">aperture_size</span><span class="o">=</span><span class="n">APERTURE_SZ</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

<span class="n">SIM_PARAMS</span> <span class="o">=</span> <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>  <span class="c1"># IMPORTANT!</span>
<span class="n">detector_processor</span> <span class="o">=</span> <span class="n">detector_processor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_wf_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">mnist_wf_test_ds</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># num_workers=2,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># data loader for a test MNIST data</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_losses_0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">test_accuracy_0</span> <span class="o">=</span> <span class="n">onn_validate_clf</span><span class="p">(</span>
    <span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="p">,</span>  <span class="c1"># optical network composed in 3.</span>
    <span class="n">test_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of training set</span>
    <span class="n">detector_processor</span><span class="p">,</span>  <span class="c1"># detector processor</span>
    <span class="n">loss_func_clf</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
    <span class="n">show_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># evaluate the model</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s1">&#39;Results before training on TEST set:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">test_losses_0</span><span class="p">)</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Accuracy : </span><span class="si">{</span><span class="p">(</span><span class="n">test_accuracy_0</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;0.1f</span><span class="si">}</span><span class="s1"> %&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████████████████████████████████| 1000/1000 [00:19&lt;00:00, 50.14it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Results before training on TEST set:
        CE loss : 2.304648
        Accuracy : 9.7 %
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.2.2.-Training">
<h2>4.2.2. Training<a class="headerlink" href="#4.2.2.-Training" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[111]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_epochs</span> <span class="o">=</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;epochs&#39;</span><span class="p">]</span>
<span class="n">print_each</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># print each n&#39;th epoch info</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[112]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scheduler</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># sheduler for a lr tuning during training</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[113]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Recreate a system to restart training!</span>

<span class="n">lin_optical_setup</span> <span class="o">=</span> <span class="n">get_setup</span><span class="p">(</span>
    <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span>
    <span class="n">NUM_OF_DIFF_LAYERS</span><span class="p">,</span>
    <span class="n">apertures</span><span class="o">=</span><span class="n">ADD_APERTURES</span><span class="p">,</span>
    <span class="n">aperture_size</span><span class="o">=</span><span class="n">APERTURE_SZ</span>
<span class="p">)</span>

<span class="c1"># Linc optimizer to a recreated net!</span>
<span class="n">optimizer_clf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
    <span class="n">params</span><span class="o">=</span><span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span>  <span class="c1"># NETWORK PARAMETERS!</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[114]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[114]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Sequential(
  (0): FreeSpace()
  (1): Aperture()
  (2): DiffractiveLayer()
  (3): FreeSpace()
  (4): Aperture()
  (5): DiffractiveLayer()
  (6): FreeSpace()
  (7): Aperture()
  (8): DiffractiveLayer()
  (9): FreeSpace()
  (10): Aperture()
  (11): DiffractiveLayer()
  (12): FreeSpace()
  (13): Aperture()
  (14): DiffractiveLayer()
  (15): FreeSpace()
  (16): Detector()
)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[115]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

<span class="n">SIM_PARAMS</span> <span class="o">=</span> <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>  <span class="c1"># IMPORTANT!</span>
<span class="n">detector_processor</span> <span class="o">=</span> <span class="n">detector_processor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>  <span class="c1"># detector processor also must be on device!</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[116]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tensorboard writer</span>
<span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;tensorboard&#39;</span><span class="p">]:</span>
    <span class="c1"># TODO: A custom name for a run?</span>
    <span class="n">tensorboard_writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tensorboard writer created!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Tensorboard writer created!
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[117]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_epochs_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">val_epochs_losses</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store losses of each epoch</span>

<span class="n">train_epochs_acc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">val_epochs_acc</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store accuracies</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">98</span><span class="p">)</span>  <span class="c1"># for reproducability?</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch #</span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">: &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># TRAIN</span>
    <span class="n">start_train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># start time of the epoch (train)</span>
    <span class="n">train_losses</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">train_accuracy</span> <span class="o">=</span> <span class="n">onn_train_clf</span><span class="p">(</span>
        <span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="p">,</span>  <span class="c1"># optical network composed in 3.</span>
        <span class="n">train_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of training set</span>
        <span class="n">detector_processor</span><span class="p">,</span>  <span class="c1"># detector processor</span>
        <span class="n">loss_func_clf</span><span class="p">,</span>
        <span class="n">optimizer_clf</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
        <span class="n">show_process</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># train the model</span>
    <span class="n">mean_train_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># train info</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training results&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">mean_train_loss</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Accuracy : </span><span class="si">{</span><span class="p">(</span><span class="n">train_accuracy</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;0.1f</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">------------   </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_train_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>

    <span class="c1"># VALIDATION</span>
    <span class="n">start_val_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># start time of the epoch (validation)</span>
    <span class="n">val_losses</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">onn_validate_clf</span><span class="p">(</span>
        <span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="p">,</span>  <span class="c1"># optical network composed in 3.</span>
        <span class="n">val_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of validation set</span>
        <span class="n">detector_processor</span><span class="p">,</span>  <span class="c1"># detector processor</span>
        <span class="n">loss_func_clf</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
        <span class="n">show_process</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># evaluate the model</span>
    <span class="n">mean_val_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val_losses</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># validation info</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validation results&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">mean_val_loss</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Accuracy : </span><span class="si">{</span><span class="p">(</span><span class="n">val_accuracy</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;0.1f</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">------------   </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_val_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scheduler</span><span class="p">:</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">mean_val_loss</span><span class="p">)</span>

    <span class="c1"># ---------------------------------------------------- TENSORBOARD SECTION</span>
    <span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;tensorboard&#39;</span><span class="p">]:</span>
        <span class="c1">#exprimentation tracking section: tensorboard</span>
        <span class="n">tensorboard_writer</span><span class="o">.</span><span class="n">add_scalars</span><span class="p">(</span>
            <span class="n">main_tag</span><span class="o">=</span><span class="s2">&quot;Loss&quot;</span><span class="p">,</span>
            <span class="n">tag_scalar_dict</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="n">mean_train_loss</span><span class="p">,</span>
                <span class="s2">&quot;val_loss&quot;</span><span class="p">:</span> <span class="n">mean_val_loss</span><span class="p">,</span>
                <span class="s2">&quot;train_accuracy&quot;</span><span class="p">:</span> <span class="n">train_accuracy</span><span class="p">,</span>
                <span class="s2">&quot;val_accuracy&quot;</span><span class="p">:</span> <span class="n">val_accuracy</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">global_step</span><span class="o">=</span><span class="n">epoch</span>
        <span class="p">)</span>

        <span class="c1"># image of SLM at each epoch</span>
        <span class="n">diff_layer_number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="p">:</span>
            <span class="c1"># save masks for Diffractive layers after each epoch</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">elements</span><span class="o">.</span><span class="n">DiffractiveLayer</span><span class="p">):</span>
                <span class="n">mask_np</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                <span class="c1"># TODO: Figure to add?</span>
                <span class="c1"># fig_this, ax_this =  plt.subplots(1, 1, figsize=(5, 4))</span>
                <span class="c1"># im_this = ax_this.imshow(</span>
                <span class="c1">#     layer.mask.detach().numpy(), cmap=cmap,</span>
                <span class="c1">#     vmin=0, vmax=MAX_PHASE</span>
                <span class="c1"># )</span>
                <span class="c1"># cbar_this = fig.colorbar(im_this)</span>
                <span class="c1"># im_this.set_clim(0, MAX_PHASE)</span>

                <span class="c1"># WRITE</span>
                <span class="n">tensorboard_writer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;DiffractiveLayer_</span><span class="si">{</span><span class="n">diff_layer_number</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">mask_np</span><span class="p">,</span>
                    <span class="n">global_step</span><span class="o">=</span><span class="n">epoch</span>
                <span class="p">)</span>
                <span class="n">diff_layer_number</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">-&gt; tensorboarded&#39;</span><span class="p">)</span>
    <span class="c1"># ---------------------------------------------------- TENSORBOARD SECTION</span>

    <span class="c1"># save losses</span>
    <span class="n">train_epochs_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_train_loss</span><span class="p">)</span>
    <span class="n">val_epochs_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_val_loss</span><span class="p">)</span>
    <span class="c1"># seve accuracies</span>
    <span class="n">train_epochs_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_accuracy</span><span class="p">)</span>
    <span class="n">val_epochs_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_accuracy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Epoch #1:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [05:09&lt;00:00, 22.18it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 2.026149
        Accuracy : 69.7 %
        ------------   309.92 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:16&lt;00:00, 15.28it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.976295
        Accuracy : 76.0 %
        ------------   16.36 s
        -&gt; tensorboarded
Epoch #2:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [05:25&lt;00:00, 21.11it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 1.954368
        Accuracy : 78.8 %
        ------------   325.61 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:17&lt;00:00, 14.38it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.944904
        Accuracy : 78.9 %
        ------------   17.38 s
        -&gt; tensorboarded
Epoch #3:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [05:15&lt;00:00, 21.78it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 1.932177
        Accuracy : 80.4 %
        ------------   315.66 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:18&lt;00:00, 13.83it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.927474
        Accuracy : 80.7 %
        ------------   18.08 s
        -&gt; tensorboarded
Epoch #4:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [06:05&lt;00:00, 18.79it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 1.919771
        Accuracy : 81.1 %
        ------------   365.97 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:19&lt;00:00, 12.67it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.918410
        Accuracy : 81.6 %
        ------------   19.74 s
        -&gt; tensorboarded
Epoch #5:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [06:09&lt;00:00, 18.63it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 1.911985
        Accuracy : 81.5 %
        ------------   369.08 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:21&lt;00:00, 11.77it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.911945
        Accuracy : 81.1 %
        ------------   21.25 s
        -&gt; tensorboarded
Epoch #6:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [06:21&lt;00:00, 18.02it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 1.906370
        Accuracy : 81.9 %
        ------------   381.45 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:19&lt;00:00, 12.72it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.906746
        Accuracy : 82.1 %
        ------------   19.66 s
        -&gt; tensorboarded
Epoch #7:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [06:52&lt;00:00, 16.68it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 1.902148
        Accuracy : 82.1 %
        ------------   412.09 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:20&lt;00:00, 12.10it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.901731
        Accuracy : 81.5 %
        ------------   20.67 s
        -&gt; tensorboarded
Epoch #8:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [06:38&lt;00:00, 17.25it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 1.899022
        Accuracy : 82.0 %
        ------------   398.52 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:19&lt;00:00, 12.82it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.900397
        Accuracy : 80.5 %
        ------------   19.51 s
        -&gt; tensorboarded
Epoch #9:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [07:19&lt;00:00, 15.64it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 1.896814
        Accuracy : 82.2 %
        ------------   439.46 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:20&lt;00:00, 12.49it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.898544
        Accuracy : 82.6 %
        ------------   20.02 s
        -&gt; tensorboarded
Epoch #10:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|█████████████████████████████████████████████████████████████████████████████| 6875/6875 [06:51&lt;00:00, 16.70it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        CE loss : 1.894883
        Accuracy : 82.3 %
        ------------   411.80 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████████████████████████████████████| 250/250 [00:17&lt;00:00, 14.02it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        CE loss : 1.896155
        Accuracy : 81.4 %
        ------------   17.83 s
        -&gt; tensorboarded
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[120]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">EXP_CONDITIONS</span><span class="p">[</span><span class="s1">&#39;tensorboard&#39;</span><span class="p">]:</span>
    <span class="n">tensorboard_writer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">tensorboard_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run tensorboard</span>
<span class="c1"># !tensorboard --logdir=runs</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="Learning-curves">
<h2>Learning curves<a class="headerlink" href="#Learning-curves" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[121]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">train_epochs_losses</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">val_epochs_losses</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">train_epochs_acc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">val_epochs_acc</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">loss_func_name</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_144_0.png" src="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_144_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[122]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># array with all losses</span>
<span class="c1"># TODO: make with PANDAS?</span>
<span class="n">all_lasses_header</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">loss_func_name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_train&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">loss_func_name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_val&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accuracy_train&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy_val&#39;</span>
<span class="p">])</span>
<span class="n">all_losses_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="n">train_epochs_losses</span><span class="p">,</span> <span class="n">val_epochs_losses</span><span class="p">,</span> <span class="n">train_epochs_acc</span><span class="p">,</span> <span class="n">val_epochs_acc</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="Saving">
<h2>Saving<a class="headerlink" href="#Saving" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[123]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RESULTS_FOLDER</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[123]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;models/03_mnist_experiments/13-12-2024_experiment_01&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[124]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">RESULTS_FOLDER</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">RESULTS_FOLDER</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[125]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># filepath to save the model</span>
<span class="n">model_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/optical_setup_net.pth&#39;</span>
<span class="c1"># filepath to save losses</span>
<span class="n">losses_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/training_curves.csv&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[126]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># saving model</span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_filepath</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[127]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># saving losses</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
    <span class="n">losses_filepath</span><span class="p">,</span> <span class="n">all_losses_array</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">all_lasses_header</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.2.3.-Trained-masks">
<h2>4.2.3. Trained masks<a class="headerlink" href="#4.2.3.-Trained-masks" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[128]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cols</span> <span class="o">=</span> <span class="n">NUM_OF_DIFF_LAYERS</span>  <span class="c1"># number of columns for DiffractiveLayer&#39;s masks visualization</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># plot wavefronts phase</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>
<span class="n">ind_diff_layer</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gist_stern&#39;</span>

<span class="k">for</span> <span class="n">ind_layer</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lin_optical_setup</span><span class="o">.</span><span class="n">net</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">elements</span><span class="o">.</span><span class="n">DiffractiveLayer</span><span class="p">):</span>  <span class="c1"># plot masks for Diffractive layers</span>
        <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_diff_layer</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">][</span><span class="n">ind_diff_layer</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_diff_layer</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>

        <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_layer</span><span class="si">}</span><span class="s1">. DiffractiveLayer&#39;</span><span class="p">)</span>

        <span class="n">trained_mask</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="c1"># mask_seed = MASKS_SEEDS[ind_diff_layer].item()</span>
        <span class="c1"># random_mask = torch.rand(</span>
        <span class="c1">#     size=(sim_params.y_nodes, sim_params.x_nodes),</span>
        <span class="c1">#     generator=torch.Generator().manual_seed(mask_seed)</span>
        <span class="c1"># ) * (MAX_PHASE)</span>

        <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">trained_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">MAX_PHASE</span>
        <span class="p">)</span>
        <span class="n">ind_diff_layer</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_156_0.png" src="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_156_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.2.4.-Applying-the-model-to-an-unknown-data-(test)">
<h2>4.2.4. Applying the model to an unknown data (test)<a class="headerlink" href="#4.2.4.-Applying-the-model-to-an-unknown-data-(test)" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[129]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># list of all saved models</span>
<span class="n">dir_models</span> <span class="o">=</span> <span class="s1">&#39;models/03_mnist_experiments&#39;</span>

<span class="n">filepathes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_models</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsdecode</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pth&quot;</span><span class="p">):</span>
        <span class="n">filepathes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">filepathes</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
.DS_Store
09-12-2024_experiment_01
13-12-2024_experiment_01
22-11-2024_experiment_01
22-11-2024_experiment_02
22-11-2024_experiment_03
27-11-2024_experiment_01
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[130]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># filepath to save the model</span>
<span class="n">load_model_subfolder</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;13-12-2024_experiment_</span><span class="si">{</span><span class="n">EXP_NUMBER</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="n">load_model_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dir_models</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">load_model_subfolder</span><span class="si">}</span><span class="s1">/optical_setup_net.pth&#39;</span>

<span class="n">load_model_filepath</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[130]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;models/03_mnist_experiments/13-12-2024_experiment_01/optical_setup_net.pth&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[131]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># experiment conditions</span>
<span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/conditions.json&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[131]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;wavelength&#39;: 0.000749481145,
 &#39;layer_size_m&#39;: 0.12,
 &#39;layer_nodes&#39;: 150,
 &#39;tensorboard&#39;: True,
 &#39;digit_resize&#39;: 17,
 &#39;ds_apertures&#39;: True,
 &#39;ds_modulation&#39;: None,
 &#39;gauss_waist_radius&#39;: 0.02,
 &#39;distance_to_aperture&#39;: 0.03,
 &#39;propagator&#39;: &#39;AS&#39;,
 &#39;n_diff_layers&#39;: 5,
 &#39;diff_layer_max_phase&#39;: 3.141592653589793,
 &#39;diff_layer_mask_init&#39;: &#39;const&#39;,
 &#39;diff_layers_seeds&#39;: 123,
 &#39;layers_distance&#39;: 0.03,
 &#39;add_apertures&#39;: True,
 &#39;apertures_size&#39;: [50, 50],
 &#39;detector_zones&#39;: &#39;segments&#39;,
 &#39;detector_transpose&#39;: False,
 &#39;train_bs&#39;: 8,
 &#39;val_bs&#39;: 20,
 &#39;train_split_seed&#39;: 178,
 &#39;epochs&#39;: 10}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[132]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup to load weights</span>
<span class="n">optical_setup_loaded</span> <span class="o">=</span> <span class="n">get_setup</span><span class="p">(</span>
    <span class="n">SIM_PARAMS</span><span class="p">,</span>
    <span class="n">NUM_OF_DIFF_LAYERS</span><span class="p">,</span>
    <span class="n">apertures</span><span class="o">=</span><span class="n">ADD_APERTURES</span><span class="p">,</span>
    <span class="n">aperture_size</span><span class="o">=</span><span class="n">APERTURE_SZ</span>
<span class="p">)</span>

<span class="c1"># LOAD WEIGHTS</span>
<span class="n">optical_setup_loaded</span><span class="o">.</span><span class="n">net</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">load_model_filepath</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/mt/0w6nmsr119bb2g4h4xrv9p6m0000gn/T/ipykernel_98211/3316892598.py:10: FutureWarning: You are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don&#39;t have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.
  optical_setup_loaded.net.load_state_dict(torch.load(load_model_filepath))
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[132]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;All keys matched successfully&gt;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[133]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_losses_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">test_accuracy_1</span> <span class="o">=</span> <span class="n">onn_validate_clf</span><span class="p">(</span>
    <span class="n">optical_setup_loaded</span><span class="o">.</span><span class="n">net</span><span class="p">,</span>  <span class="c1"># optical network with loaded weights</span>
    <span class="n">test_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of training set</span>
    <span class="n">detector_processor</span><span class="p">,</span>  <span class="c1"># detector processor</span>
    <span class="n">loss_func_clf</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
    <span class="n">show_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># evaluate the model</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s1">&#39;Results after training on TEST set:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">test_losses_1</span><span class="p">)</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Accuracy : </span><span class="si">{</span><span class="p">(</span><span class="n">test_accuracy_1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;0.1f</span><span class="si">}</span><span class="s1"> %&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████████████████████████████████| 1000/1000 [00:32&lt;00:00, 30.32it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Results after training on TEST set:
        CE loss : 1.889739
        Accuracy : 82.3 %
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.2.5.-Example-of-classification-for-a-random-wavefront-(propagation-through)">
<h2>4.2.5. Example of classification for a random wavefront (propagation through)<a class="headerlink" href="#4.2.5.-Example-of-classification-for-a-random-wavefront-(propagation-through)" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[134]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot an image</span>
<span class="c1"># &#39;1&#39; - 3214, good (1318, )</span>
<span class="c1"># &#39;4&#39; - 6152, good (1985, )</span>
<span class="c1"># &#39;5&#39; - (5134, )</span>
<span class="c1"># &#39;6&#39; - 123, good</span>
<span class="c1"># &#39;8&#39; - 128, good (1124, 8105)</span>
<span class="c1"># &#39;0&#39; - 3, good</span>
<span class="n">ind_test</span> <span class="o">=</span> <span class="mi">6152</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;hot&#39;</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">test_wavefront</span><span class="p">,</span> <span class="n">test_target</span> <span class="o">=</span> <span class="n">mnist_wf_test_ds</span><span class="p">[</span><span class="n">ind_test</span><span class="p">]</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;intensity (id=</span><span class="si">{</span><span class="n">ind_test</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_wavefront</span><span class="o">.</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;phase&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">test_wavefront</span><span class="o">.</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_167_0.png" src="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_167_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[135]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_target</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[135]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
4
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[136]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># propagation of the example through the trained network</span>
<span class="n">setup_scheme</span><span class="p">,</span> <span class="n">test_wavefronts</span> <span class="o">=</span> <span class="n">optical_setup_loaded</span><span class="o">.</span><span class="n">stepwise_forward</span><span class="p">(</span><span class="n">test_wavefront</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[137]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">setup_scheme</span><span class="p">)</span>  <span class="c1"># prints propagation scheme</span>

<span class="n">n_cols</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># number of columns to plot all wavefronts during propagation</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">optical_setup_loaded</span><span class="o">.</span><span class="n">net</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">to_plot</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span>  <span class="c1"># &lt;--- chose what to plot</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span>  <span class="c1"># choose colormaps</span>
<span class="n">detector_cmap</span> <span class="o">=</span> <span class="s1">&#39;hot&#39;</span>

<span class="c1"># create a figure with subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>

<span class="c1"># turn off unecessary axes</span>
<span class="k">for</span> <span class="n">ind_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_rows</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ind_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
        <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_row</span><span class="p">][</span><span class="n">ind_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ind_row</span> <span class="o">*</span> <span class="n">n_cols</span> <span class="o">+</span> <span class="n">ind_col</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavefronts</span><span class="p">):</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="c1"># plot wavefronts</span>
<span class="k">for</span> <span class="n">ind_wf</span><span class="p">,</span> <span class="n">wavefront</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_wavefronts</span><span class="p">):</span>
    <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_wf</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">][</span><span class="n">ind_wf</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
        <span class="c1"># plot angle for each wavefront, because intensities pictures are indistinguishable from each other</span>
        <span class="k">if</span> <span class="n">ind_wf</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavefronts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Phase for $WF_{&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_wf</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;}$&#39;</span><span class="p">)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">wavefront</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">phase</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># (not a wavefront!)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Detector phase ($WF_{&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_wf</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;})$&#39;</span><span class="p">)</span>
            <span class="c1"># Detector has no phase!</span>

    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
        <span class="c1"># plot angle for each wavefront, because intensities pictures are indistinguishable from each other</span>
        <span class="k">if</span> <span class="n">ind_wf</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavefronts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intensity for $WF_{&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_wf</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;}$&#39;</span><span class="p">)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">wavefront</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="c1"># vmin=0, vmax=max_intensity  # uncomment to make the same limits</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Detector output (not a wavefront!)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Detector Intensity ($WF_{&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_wf</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;})$&#39;</span><span class="p">)</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">wavefront</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">detector_cmap</span><span class="p">,</span>
                <span class="c1"># vmin=0, vmax=max_intensity  # uncomment to make the same limits</span>
            <span class="p">)</span>

    <span class="c1"># Comment: Detector output is Tensor! It has no methods of Wavefront (like .phase or .intensity)!</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-(0)-&gt; [1. FreeSpace] -(1)-&gt; [2. Aperture] -(2)-&gt; [3. DiffractiveLayer] -(3)-&gt; [4. FreeSpace] -(4)-&gt; [5. Aperture] -(5)-&gt; [6. DiffractiveLayer] -(6)-&gt; [7. FreeSpace] -(7)-&gt; [8. Aperture] -(8)-&gt; [9. DiffractiveLayer] -(9)-&gt; [10. FreeSpace] -(10)-&gt; [11. Aperture] -(11)-&gt; [12. DiffractiveLayer] -(12)-&gt; [13. FreeSpace] -(13)-&gt; [14. Aperture] -(14)-&gt; [15. DiffractiveLayer] -(15)-&gt; [16. FreeSpace] -(16)-&gt; [17. Detector] -(17)-&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_172_1.png" src="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_172_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[138]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a figure with subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax_this</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">))</span>

<span class="c1"># Detector output (not a wavefront!)</span>
<span class="n">ax_this</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Detector Intensity ($WF_{&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_wf</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;})$&#39;</span><span class="p">)</span>
<span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">test_wavefronts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span>
    <span class="c1"># vmin=0, vmax=1  # uncomment to make the same limits</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">get_zones_patches</span><span class="p">(</span><span class="n">selected_detector_mask</span><span class="p">):</span>
    <span class="c1"># add zone&#39;s patches to the axis</span>
    <span class="c1"># zone_copy = copy(zone)</span>
    <span class="n">ax_this</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_173_0.png" src="../../_images/examples_notebook_diff_networks_examples_03_mnist_experiments_173_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[139]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get probabilities of an example classification</span>
<span class="n">test_probas</span> <span class="o">=</span> <span class="n">detector_processor</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">test_wavefronts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_probas</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">prob</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0 : 0.85%
1 : 4.22%
2 : 5.14%
3 : 1.11%
4 : 64.29%
5 : 2.39%
6 : 1.11%
7 : 1.32%
8 : 0.70%
9 : 18.87%
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../network_examples.html" class="btn btn-neutral float-left" title="Examples of diffractive optical networks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="05_reservoir_mackey_glass.html" class="btn btn-neutral float-right" title="Reservoir computing for time series prediction of Mackey-Glass sequence" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, CompPhysLab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>