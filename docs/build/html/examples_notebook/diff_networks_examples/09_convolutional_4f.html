

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Convolutional Diffractive Network &mdash; SVETlANNa 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Diffractive Autoencoder for MNIST classification task" href="08_autoencoder.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SVETlANNa
              <img src="../../_static/logo.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../physics.html">Physical Basis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Command reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../freeprop_examples.html">Examples of solving forward light propagation problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../phase_retrieval_examples.html">Examples of phase retrieval algorithms</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../network_examples.html">Examples of diffractive optical networks</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="03_mnist_experiments.html">Feed-forward Diffractive Optical Neural Network for MNIST task</a></li>
<li class="toctree-l3"><a class="reference internal" href="05_reservoir_mackey_glass.html">Reservoir computing for time series prediction of Mackey-Glass sequence</a></li>
<li class="toctree-l3"><a class="reference internal" href="08_autoencoder.html">Diffractive Autoencoder for MNIST classification task</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Convolutional Diffractive Network</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Imports">Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#2.1.1.-Load-Train-and-Test-datasets-of-images">2.1.1. Load Train and Test datasets of images</a></li>
<li class="toctree-l4"><a class="reference internal" href="#2.1.2.-Create-Train-and-Test-datasets-of-wavefronts">2.1.2. Create Train and Test datasets of wavefronts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.1.-Function-to-return-4f-system">3.1.1. Function to return 4f system</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.2.-Mask-for-a-DiffractiveLayer-placed-in-a-Fourier-plane">3.1.2. Mask for a <code class="docutils literal notranslate"><span class="pre">DiffractiveLayer</span></code> placed in a Fourier plane</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.3.-Convolution-Layer-(4f-system)">3.1.3. Convolution Layer (4f system)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.2.1.-Functions-to-get-new-elements">3.2.1. Functions to get new elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.2.2.-Elements-list">3.2.2. Elements list</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.3.1.-Model-Class">3.3.1. Model Class</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.3.2.-Empty-model">3.3.2. Empty model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#3.1.4-Detector-processor-(to-calculate-accuracies-only)">3.1.4 Detector processor (to calculate accuracies only)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.1.1.-DataLoader's">4.1.1. <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>’s</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.1.2.-Optimizer-and-loss-function">4.1.2. Optimizer and loss function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.1.3.-Training-and-evaluation-loops">4.1.3. Training and evaluation loops</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.2.1.-Before-training">4.2.1. Before training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.2.2.-Training">4.2.2. Training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.4.1.-Select-a-sample-to-encode/decode">4.4.1. Select a sample to encode/decode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4.4.2.-Encode/decode-an-example">4.4.2. Encode/decode an example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SVETlANNa</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../examples.html">Examples</a></li>
          <li class="breadcrumb-item"><a href="../../network_examples.html">Examples of diffractive optical networks</a></li>
      <li class="breadcrumb-item active">Convolutional Diffractive Network</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/examples_notebook/diff_networks_examples/09_convolutional_4f.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Convolutional-Diffractive-Network">
<h1>Convolutional Diffractive Network<a class="headerlink" href="#Convolutional-Diffractive-Network" title="Link to this heading"></a></h1>
<p>This notebook is based on the article “Optical Diffractive Convolutional Neural Networks Implemented in an All-Optical Way” <a class="reference external" href="https://www.mdpi.com/1424-8220/23/12/5749">[1]</a>.</p>
<blockquote>
<div><p>… combining the 4f system as an optical convolutional layer and the diffractive networks</p>
</div></blockquote>
<section id="Imports">
<h2>Imports<a class="headerlink" href="#Imports" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import warnings</span>
<span class="c1"># warnings.simplefilter(&quot;always&quot;)  # always show warnings!</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">functional</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">transforms</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterpolationMode</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># our library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimulationParameters</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConstrainedParameter</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># our library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna</span><span class="w"> </span><span class="kn">import</span> <span class="n">Wavefront</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna</span><span class="w"> </span><span class="kn">import</span> <span class="n">elements</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.detector</span><span class="w"> </span><span class="kn">import</span> <span class="n">Detector</span><span class="p">,</span> <span class="n">DetectorProcessorClf</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">svetlanna.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToWavefront</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.wf_datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatasetOfWavefronts</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1"># %config InlineBackend.figure_format = &#39;retina&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">today_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y_%H-%M&#39;</span><span class="p">)</span>  <span class="c1"># date for a results folder name</span>
<span class="n">today_date</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;11-04-2025_00-38&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define all necessery variables for that notebook</span>
<span class="n">VARIABLES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># FILEPATHES</span>
    <span class="s1">&#39;data_path&#39;</span><span class="p">:</span> <span class="s1">&#39;./data&#39;</span><span class="p">,</span>  <span class="c1"># folder which will be created (if not exists) to load/store Weizmann dataset</span>
    <span class="s1">&#39;results_path&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;models/convolutional/conv_exp_</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="c1"># filepath to save results!</span>

    <span class="c1"># GENERAL SETTINGS - SECTION 1 of the notebook</span>
    <span class="s1">&#39;wavelength&#39;</span><span class="p">:</span> <span class="mi">750</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>  <span class="c1"># working wavelength, in [m]</span>
    <span class="s1">&#39;neuron_size&#39;</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="mi">750</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">,</span>  <span class="c1"># size of a pixel for DiffractiveLayers, in [m]</span>
    <span class="s1">&#39;mesh_size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>  <span class="c1"># full size of a layer = numerical mesh</span>
        <span class="c1"># Comment: value from the article [1] - (200, 200)</span>

    <span class="s1">&#39;use_apertures&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># if we need to add apertures before each Diffractie layer</span>
        <span class="c1"># Comment: value from the article [1] - unknown</span>
    <span class="s1">&#39;aperture_size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>  <span class="c1"># size of each aperture = a detector square for classes zones</span>
        <span class="c1"># Comment: value from the article [1] - unknown</span>

    <span class="c1"># DATASET OF SUBSEQUENCES SETTINGS - SECTION 2 of the notebook</span>
    <span class="s1">&#39;resize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>  <span class="c1"># size to resize pictures to add 0th padding then (up to the mesh size)</span>
        <span class="c1"># Comment: value from the article: the input image of 28 * 28 pixels size</span>
    <span class="s1">&#39;modulation&#39;</span><span class="p">:</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span>  <span class="c1"># modulation type to make a wavefront from each picture mask (see 2.3.2.)</span>
        <span class="c1"># Comment: can be equal to `phase`, `amp` or `both`</span>

    <span class="c1"># NETWORK - SECTION 3 of the notebook</span>
    <span class="s1">&#39;max_phase&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>  <span class="c1"># maximal possible phase for each DiffractiveLayer</span>
    <span class="s1">&#39;free_space_method&#39;</span><span class="p">:</span> <span class="s1">&#39;AS&#39;</span><span class="p">,</span>  <span class="c1"># propagation method</span>
        <span class="c1"># Comment: can be &#39;AS&#39; or &#39;fresnel&#39;</span>
    <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="mf">1e-2</span><span class="p">,</span>  <span class="c1"># distance between diffractive layers</span>

    <span class="c1"># 4F-SYSTEM</span>
    <span class="s1">&#39;focal_length&#39;</span><span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="mf">1e-2</span><span class="p">,</span>  <span class="c1"># in [m]</span>
    <span class="s1">&#39;lens_radius&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
        <span class="c1"># Comment: if a lens radius is equal to torch.inf - analytical lens!</span>
    <span class="s1">&#39;learnable_kernel&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>

    <span class="c1"># DIFFRACTIVE LAYERS</span>
    <span class="s1">&#39;use_slm&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># use SLM (if True) or DiffractiveLayers (if False)</span>
    <span class="s1">&#39;num_layers&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;init_phases&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="c1"># value or a list of initial constant phases for DiffractiveLayers OR SLM</span>
    <span class="c1"># SLM settings - if &#39;use_slm&#39; == True</span>
        <span class="c1"># Comment: a size of each SLM is equal to SimulationParameters!</span>
    <span class="s1">&#39;slm_shapes&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)],</span>
        <span class="c1"># list of size &#39;encoder_num_layers&#39;</span>
    <span class="s1">&#39;slm_levels&#39;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
        <span class="c1"># value OR a list (len = &#39;encoder_num_layers&#39;) of numbers of levels for each SLM</span>
    <span class="s1">&#39;slm_step_funcs&#39;</span><span class="p">:</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span>  <span class="c1"># value OR a list of step function names</span>
        <span class="c1"># Comment: available stp functions names - &#39;linear&#39;</span>

    <span class="c1"># NETWORK LEARNING - SECTION 4 of the notebook</span>
    <span class="s1">&#39;calculate_accuracies&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># will be always True for CrossEnthropyLoss! (see 3.1.4.)</span>
        <span class="c1"># Comment: MSE loss used!</span>
    <span class="s1">&#39;DEVICE&#39;</span><span class="p">:</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span>  <span class="c1"># if `cuda` - we will check if it is available (see first cells of Sec. 4)</span>
    <span class="s1">&#39;train_batch_size&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>  <span class="c1"># batch sizes for training (see 4.1.1.)</span>
    <span class="s1">&#39;val_batch_size&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
        <span class="c1"># Comment: value from the article [1] - 64  # for both train and test?</span>
    <span class="s1">&#39;adam_lr&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>  <span class="c1"># learning rate for Adam optimizer (see 4.1.2.)</span>
        <span class="c1"># Comment: value from the article [1] - 0.01</span>
    <span class="s1">&#39;number_of_epochs&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>  <span class="c1"># number of epochs to train</span>
        <span class="c1"># Comment: value from the article [1] - 100-300 ?!</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># functions for SLM step (look documentation of SLM)</span>
<span class="n">SLM_STEPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RESULTS_FOLDER</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;results_path&#39;</span><span class="p">]</span>

<span class="c1"># create a directory to store results</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">RESULTS_FOLDER</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">RESULTS_FOLDER</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RESULTS_FOLDER</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;models/convolutional/conv_exp_11-04-2025_00-38&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save experiment conditions (VARIABLES dictionary)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/conditions.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">ensure_ascii</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="1.-Simulation-parameters">
<h3>1. Simulation parameters<a class="headerlink" href="#1.-Simulation-parameters" title="Link to this heading"></a></h3>
<p>Since in <a class="reference external" href="https://www.mdpi.com/1424-8220/23/12/5749">[1]</a> there are no details, we took physical parameters from another article <a class="reference external" href="https://ieeexplore.ieee.org/abstract/document/8732486">[2]</a>, which we used in some previous notebooks.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">working_wavelength</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>  <span class="c1"># [m] - like for MNIST</span>

<span class="n">c_const</span> <span class="o">=</span> <span class="mi">299_792_458</span>  <span class="c1"># [m / s]</span>
<span class="n">working_frequency</span> <span class="o">=</span> <span class="n">c_const</span> <span class="o">/</span> <span class="n">working_wavelength</span> <span class="c1"># [Hz]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;lambda    = </span><span class="si">{</span><span class="n">working_wavelength</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> mm&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;frequency = </span><span class="si">{</span><span class="n">working_frequency</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1e12</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> THz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
lambda    = 0.750 mm
frequency = 0.400 THz
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># neuron size (square)</span>
<span class="n">neuron_size</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;neuron_size&#39;</span><span class="p">]</span>  <span class="c1"># [m] - like for MNIST</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;neuron size = </span><span class="si">{</span><span class="n">neuron_size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> mm&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
neuron size = 0.375 mm
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">APERTURES</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;use_apertures&#39;</span><span class="p">]</span>  <span class="c1"># add apertures BEFORE each diffractive layer or not</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER_SIZE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;mesh_size&#39;</span><span class="p">]</span>  <span class="c1"># mesh size</span>
<span class="n">DETECTOR_SIZE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;aperture_size&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of neurons in simulation</span>
<span class="n">x_layer_nodes</span> <span class="o">=</span> <span class="n">LAYER_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y_layer_nodes</span> <span class="o">=</span> <span class="n">LAYER_SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Comment: Same size as proposed!</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer size (in neurons): </span><span class="si">{</span><span class="n">x_layer_nodes</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">y_layer_nodes</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">x_layer_nodes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y_layer_nodes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Layer size (in neurons): 200 x 200 = 40000
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># physical size of each layer</span>
<span class="n">x_layer_size_m</span> <span class="o">=</span> <span class="n">x_layer_nodes</span> <span class="o">*</span> <span class="n">neuron_size</span>  <span class="c1"># [m]</span>
<span class="n">y_layer_size_m</span> <span class="o">=</span> <span class="n">y_layer_nodes</span> <span class="o">*</span> <span class="n">neuron_size</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer size (in mm): </span><span class="si">{</span><span class="n">x_layer_size_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="w"> </span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">y_layer_size_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1e3</span><span class="w"> </span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Layer size (in mm): 75.000 x 75.000
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_LAYER_SIZE_M</span> <span class="o">=</span> <span class="n">x_layer_size_m</span>
<span class="n">Y_LAYER_SIZE_M</span> <span class="o">=</span> <span class="n">y_layer_size_m</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simulation parameters for the rest of the notebook</span>

<span class="n">SIM_PARAMS</span> <span class="o">=</span> <span class="n">SimulationParameters</span><span class="p">(</span>
    <span class="n">axes</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">x_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x_layer_nodes</span><span class="p">),</span>
        <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">y_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_layer_size_m</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y_layer_nodes</span><span class="p">),</span>
        <span class="s1">&#39;wavelength&#39;</span><span class="p">:</span> <span class="n">working_wavelength</span><span class="p">,</span>  <span class="c1"># only one wavelength!</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="2.-Dataset-preparation">
<h3>2. Dataset preparation<a class="headerlink" href="#2.-Dataset-preparation" title="Link to this heading"></a></h3>
</section>
<section id="2.1.-MNIST-Dataset">
<h3>2.1. <a class="reference external" href="https://www.kaggle.com/datasets/hojjatk/mnist-dataset">MNIST Dataset</a><a class="headerlink" href="#2.1.-MNIST-Dataset" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># initialize a directory for a dataset</span>
<span class="n">MNIST_DATA_FOLDER</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;data_path&#39;</span><span class="p">]</span>  <span class="c1"># folder to store data</span>

<span class="n">NUM_CLASSES</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="2.1.1.-Load-Train-and-Test-datasets-of-images">
<h2>2.1.1. Load Train and Test datasets of images<a class="headerlink" href="#2.1.1.-Load-Train-and-Test-datasets-of-images" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TRAIN (images)</span>
<span class="n">mnist_train_ds</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="n">MNIST_DATA_FOLDER</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># for train dataset</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TEST (images)</span>
<span class="n">mnist_test_ds</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="n">MNIST_DATA_FOLDER</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># for test dataset</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test data : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_test_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Train data: 60000
Test data : 10000
</pre></div></div>
</div>
</section>
<section id="2.1.2.-Create-Train-and-Test-datasets-of-wavefronts">
<h2>2.1.2. Create Train and Test datasets of wavefronts<a class="headerlink" href="#2.1.2.-Create-Train-and-Test-datasets-of-wavefronts" title="Link to this heading"></a></h2>
<blockquote>
<div><p>the input image of <span class="math notranslate nohighlight">\(28 \times 28\)</span> pixels size was expanded to <span class="math notranslate nohighlight">\(200 \times 200\)</span> with zero padding</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select modulation type</span>
<span class="n">MODULATION_TYPE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;modulation&#39;</span><span class="p">]</span>  <span class="c1"># using ONLY amplitude to encode each picture in a Wavefront!</span>
<span class="n">RESIZE_SHAPE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;resize&#39;</span><span class="p">]</span>  <span class="c1"># size to resize pictures to add 0th padding then (up to the mesh size)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resize_y</span> <span class="o">=</span> <span class="n">RESIZE_SHAPE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">resize_x</span> <span class="o">=</span> <span class="n">RESIZE_SHAPE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># shape for transforms.Resize</span>

<span class="c1"># paddings along OY</span>
<span class="n">pad_top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">resize_y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pad_bottom</span> <span class="o">=</span> <span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">pad_top</span> <span class="o">-</span> <span class="n">resize_y</span>
<span class="c1"># paddings along OX</span>
<span class="n">pad_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">resize_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pad_right</span> <span class="o">=</span> <span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">pad_left</span> <span class="o">-</span> <span class="n">resize_x</span>  <span class="c1"># params for transforms.Pad</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compose all transforms!</span>
<span class="n">image_transform_for_ds</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
  <span class="p">[</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span>
          <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">resize_y</span><span class="p">,</span> <span class="n">resize_x</span><span class="p">),</span>
          <span class="n">interpolation</span><span class="o">=</span><span class="n">InterpolationMode</span><span class="o">.</span><span class="n">NEAREST</span><span class="p">,</span>
      <span class="p">),</span>
      <span class="n">transforms</span><span class="o">.</span><span class="n">Pad</span><span class="p">(</span>
          <span class="n">padding</span><span class="o">=</span><span class="p">(</span>
              <span class="n">pad_left</span><span class="p">,</span>  <span class="c1"># left padding</span>
              <span class="n">pad_top</span><span class="p">,</span>  <span class="c1"># top padding</span>
              <span class="n">pad_right</span><span class="p">,</span>  <span class="c1"># right padding</span>
              <span class="n">pad_bottom</span>  <span class="c1"># bottom padding</span>
          <span class="p">),</span>
          <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
      <span class="p">),</span>  <span class="c1"># padding to match sizes!</span>
      <span class="n">ToWavefront</span><span class="p">(</span><span class="n">modulation_type</span><span class="o">=</span><span class="n">MODULATION_TYPE</span><span class="p">)</span>  <span class="c1"># &lt;- selected modulation type here!!!</span>
  <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">src.detector_segmentation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">detector_segmentation</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">number_of_classes</span> <span class="o">=</span> <span class="n">NUM_CLASSES</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">detector_segment_size</span> <span class="o">=</span> <span class="mf">6.4</span> <span class="o">*</span> <span class="n">working_wavelength</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># size of each segment in neurons</span>
<span class="n">x_segment_nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detector_segment_size</span> <span class="o">/</span> <span class="n">neuron_size</span><span class="p">)</span>
<span class="n">y_segment_nodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detector_segment_size</span> <span class="o">/</span> <span class="n">neuron_size</span><span class="p">)</span>
<span class="c1"># each segment of size = (y_segment_nodes, x_segment_nodes)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_boundary_nodes</span> <span class="o">=</span> <span class="n">y_segment_nodes</span> <span class="o">*</span> <span class="mi">12</span>
<span class="n">x_boundary_nodes</span> <span class="o">=</span> <span class="n">x_segment_nodes</span> <span class="o">*</span> <span class="mi">12</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DETECTOR_MASK</span> <span class="o">=</span> <span class="n">detector_segmentation</span><span class="o">.</span><span class="n">squares_mnist</span><span class="p">(</span>
    <span class="n">y_boundary_nodes</span><span class="p">,</span> <span class="n">x_boundary_nodes</span><span class="p">,</span>  <span class="c1"># size of a detector or an aperture (in the middle of detector)</span>
    <span class="n">SIM_PARAMS</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>To visualize detector zones (for further use)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ZONES_HIGHLIGHT_COLOR</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
<span class="n">ZONES_LW</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">selected_detector_mask</span> <span class="o">=</span> <span class="n">DETECTOR_MASK</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_zones_patches</span><span class="p">(</span><span class="n">detector_mask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of patches to draw zones in final visualisation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zones_patches</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#0.5</span>

    <span class="k">for</span> <span class="n">ind_class</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_classes</span><span class="p">):</span>
        <span class="n">idx_y</span><span class="p">,</span> <span class="n">idx_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">detector_mask</span> <span class="o">==</span> <span class="n">ind_class</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">zone_rect</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="n">idx_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">,</span> <span class="n">idx_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">),</span>
            <span class="n">idx_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">delta</span><span class="p">,</span> <span class="n">idx_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">delta</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">ZONES_LW</span><span class="p">,</span>
            <span class="n">edgecolor</span><span class="o">=</span><span class="n">ZONES_HIGHLIGHT_COLOR</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>
        <span class="p">)</span>

        <span class="n">zones_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone_rect</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">zones_patches</span>
</pre></div>
</div>
</div>
<p>Visualize mask</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Detector segments&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">selected_detector_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">get_zones_patches</span><span class="p">(</span><span class="n">selected_detector_mask</span><span class="p">):</span>
    <span class="c1"># add zone&#39;s patches to the axis</span>
    <span class="c1"># zone_copy = copy(zone)</span>
    <span class="n">ax0</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_62_0.png" src="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_62_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TRAIN dataset of WAVEFRONTS</span>
<span class="n">mnist_wf_train_ds</span> <span class="o">=</span> <span class="n">DatasetOfWavefronts</span><span class="p">(</span>
    <span class="n">init_ds</span><span class="o">=</span><span class="n">mnist_train_ds</span><span class="p">,</span>  <span class="c1"># dataset of images</span>
    <span class="n">transformations</span><span class="o">=</span><span class="n">image_transform_for_ds</span><span class="p">,</span>  <span class="c1"># image transformation</span>
    <span class="n">sim_params</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>  <span class="c1"># simulation parameters</span>
    <span class="n">target</span><span class="o">=</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span>
    <span class="n">detector_mask</span><span class="o">=</span><span class="n">DETECTOR_MASK</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TEST dataset of WAVEFRONTS</span>
<span class="n">mnist_wf_test_ds</span> <span class="o">=</span> <span class="n">DatasetOfWavefronts</span><span class="p">(</span>
    <span class="n">init_ds</span><span class="o">=</span><span class="n">mnist_test_ds</span><span class="p">,</span>  <span class="c1"># dataset of images</span>
    <span class="n">transformations</span><span class="o">=</span><span class="n">image_transform_for_ds</span><span class="p">,</span>  <span class="c1"># image transformation</span>
    <span class="n">sim_params</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>  <span class="c1"># simulation parameters</span>
    <span class="n">target</span><span class="o">=</span><span class="s1">&#39;detector&#39;</span><span class="p">,</span>
    <span class="n">detector_mask</span><span class="o">=</span><span class="n">DETECTOR_MASK</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Train data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Test data : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_test_ds</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Train data: 60000
Test data : 10000
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot several EXAMPLES from TRAIN dataset</span>
<span class="n">n_examples</span><span class="o">=</span> <span class="mi">4</span>  <span class="c1"># number of examples to plot</span>
<span class="c1"># choosing indecies of images (from train) to plot</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">78</span><span class="p">)</span>
<span class="n">train_examples_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_train_ds</span><span class="p">)),</span> <span class="n">n_examples</span><span class="p">)</span>

<span class="n">all_examples_wavefronts</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">n_lines</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_lines</span><span class="p">,</span> <span class="n">n_examples</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_examples</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_lines</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ind_ex</span><span class="p">,</span> <span class="n">ind_train</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_examples_ids</span><span class="p">):</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">mnist_train_ds</span><span class="p">[</span><span class="n">ind_train</span><span class="p">]</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;id=</span><span class="si">{</span><span class="n">ind_train</span><span class="si">}</span><span class="s1"> [</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

    <span class="n">wavefront</span><span class="p">,</span> <span class="n">target_image</span> <span class="o">=</span> <span class="n">mnist_wf_train_ds</span><span class="p">[</span><span class="n">ind_train</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wavefront</span><span class="p">,</span> <span class="n">Wavefront</span><span class="p">)</span>

    <span class="n">all_examples_wavefronts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wavefront</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;$|WF|^2$&#39;</span><span class="p">)</span>
    <span class="c1"># here we can plot intensity for a wavefront</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">wavefront</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Target image&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">target_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">get_zones_patches</span><span class="p">(</span><span class="n">selected_detector_mask</span><span class="p">):</span>
        <span class="c1"># add zone&#39;s patches to the axis</span>
        <span class="c1"># zone_copy = copy(zone)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">zone</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_68_0.png" src="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_68_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="3.-Diffractive-Network-with-Convolutional-Layer">
<h3>3. Diffractive Network with Convolutional Layer<a class="headerlink" href="#3.-Diffractive-Network-with-Convolutional-Layer" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FS_METHOD</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;free_space_method&#39;</span><span class="p">]</span>
<span class="n">FS_DISTANCE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>  <span class="c1"># [m] - distance between difractive layers</span>

<span class="n">MAX_PHASE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;max_phase&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="3.1.-Optical-Convolutional-Layer">
<h3>3.1. Optical Convolutional Layer<a class="headerlink" href="#3.1.-Optical-Convolutional-Layer" title="Link to this heading"></a></h3>
<p>See Figure 2 in <a class="reference external" href="https://www.mdpi.com/1424-8220/23/12/5749">[1]</a>!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FOCAL_LENGTH</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;focal_length&#39;</span><span class="p">]</span>
<span class="n">LENS_R</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;lens_radius&#39;</span><span class="p">]</span>

<span class="n">LEARN_CONV</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;learnable_kernel&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="3.1.1.-Function-to-return-4f-system">
<h2>3.1.1. Function to return 4f system<a class="headerlink" href="#3.1.1.-Function-to-return-4f-system" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_free_space</span><span class="p">(</span>
    <span class="n">freespace_sim_params</span><span class="p">,</span>
    <span class="n">freespace_distance</span><span class="p">,</span>  <span class="c1"># in [m]!</span>
    <span class="n">freespace_method</span><span class="o">=</span><span class="s1">&#39;AS&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns FreeSpace layer with a bounded distance parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">FreeSpace</span><span class="p">(</span>
        <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">freespace_sim_params</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">freespace_distance</span><span class="p">,</span>  <span class="c1"># distance is not learnable!</span>
        <span class="n">method</span><span class="o">=</span><span class="n">freespace_method</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_4f_convolutional_layer</span><span class="p">(</span>
    <span class="n">sim_params</span><span class="p">,</span>
    <span class="n">focal_length</span><span class="p">,</span>  <span class="c1"># in [m]</span>
    <span class="n">lens_radius</span><span class="p">,</span>  <span class="c1"># in [m]</span>
    <span class="n">convolutional_mask</span><span class="p">,</span>  <span class="c1"># mask from 0 to max_phase</span>
    <span class="n">learnable_mask</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># if a convolutional mask is learnable</span>
    <span class="n">max_phase</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="n">freespace_method</span><span class="o">=</span><span class="s1">&#39;AS&#39;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of elements for a 4f system with a Diffractive layer in a Fourier plane.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">learnable_mask</span><span class="p">:</span>
        <span class="n">diff_layer</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">DiffractiveLayer</span><span class="p">(</span>
            <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">sim_params</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">ConstrainedParameter</span><span class="p">(</span>
                <span class="n">convolutional_mask</span><span class="p">,</span>
                <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">max_value</span><span class="o">=</span><span class="n">max_phase</span>
            <span class="p">),</span>  <span class="c1"># HERE WE ARE USING CONSTRAINED PARAMETER!</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diff_layer</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">DiffractiveLayer</span><span class="p">(</span>
            <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">sim_params</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">convolutional_mask</span><span class="p">,</span>  <span class="c1"># mask is not changing during the training!</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">get_free_space</span><span class="p">(</span>
            <span class="n">sim_params</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">,</span> <span class="n">freespace_method</span>
        <span class="p">),</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">ThinLens</span><span class="p">(</span><span class="n">sim_params</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">,</span> <span class="n">lens_radius</span><span class="p">),</span>
        <span class="n">get_free_space</span><span class="p">(</span>
            <span class="n">sim_params</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">,</span> <span class="n">freespace_method</span>
        <span class="p">),</span>
        <span class="n">diff_layer</span><span class="p">,</span>  <span class="c1"># DiffractiveLayer in a Fourier plane!</span>
        <span class="n">get_free_space</span><span class="p">(</span>
            <span class="n">sim_params</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">,</span> <span class="n">freespace_method</span>
        <span class="p">),</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">ThinLens</span><span class="p">(</span><span class="n">sim_params</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">,</span> <span class="n">lens_radius</span><span class="p">),</span>
        <span class="n">get_free_space</span><span class="p">(</span>
            <span class="n">sim_params</span><span class="p">,</span> <span class="n">focal_length</span><span class="p">,</span> <span class="n">freespace_method</span>
        <span class="p">),</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="3.1.2.-Mask-for-a-DiffractiveLayer-placed-in-a-Fourier-plane">
<h2>3.1.2. Mask for a <code class="docutils literal notranslate"><span class="pre">DiffractiveLayer</span></code> placed in a Fourier plane<a class="headerlink" href="#3.1.2.-Mask-for-a-DiffractiveLayer-placed-in-a-Fourier-plane" title="Link to this heading"></a></h2>
<p>Citations from <a class="reference external" href="https://www.mdpi.com/1424-8220/23/12/5749">[1]</a></p>
<blockquote>
<div><p>In the convolution layer, <span class="math notranslate nohighlight">\(16\)</span> convolution kernels were discretized into a <span class="math notranslate nohighlight">\(4 \times 4\)</span> array and tiled into a <span class="math notranslate nohighlight">\(200 \times 200\)</span> size planar space, as shown in Figure 6.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">kernels.kernels</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate All 16 Kernels</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_16_kernels</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
    <span class="n">k3</span> <span class="o">=</span> <span class="n">predefined_3x3_kernels</span><span class="p">()</span>

    <span class="n">kernels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">gaussian_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
        <span class="n">gaussian_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span>
        <span class="n">laplacian_of_gaussian</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
        <span class="n">gabor_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">gabor_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span>
        <span class="n">gabor_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">gabor_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span>
        <span class="n">upscale_kernel</span><span class="p">(</span><span class="n">k3</span><span class="p">[</span><span class="s1">&#39;sobel_x&#39;</span><span class="p">],</span> <span class="n">size</span><span class="p">),</span>
        <span class="n">upscale_kernel</span><span class="p">(</span><span class="n">k3</span><span class="p">[</span><span class="s1">&#39;sobel_y&#39;</span><span class="p">],</span> <span class="n">size</span><span class="p">),</span>
        <span class="n">upscale_kernel</span><span class="p">(</span><span class="n">k3</span><span class="p">[</span><span class="s1">&#39;prewitt_x&#39;</span><span class="p">],</span> <span class="n">size</span><span class="p">),</span>
        <span class="n">upscale_kernel</span><span class="p">(</span><span class="n">k3</span><span class="p">[</span><span class="s1">&#39;prewitt_y&#39;</span><span class="p">],</span> <span class="n">size</span><span class="p">),</span>
        <span class="n">upscale_kernel</span><span class="p">(</span><span class="n">k3</span><span class="p">[</span><span class="s1">&#39;emboss&#39;</span><span class="p">],</span> <span class="n">size</span><span class="p">),</span>
        <span class="n">identity_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
        <span class="n">center_surround_edge_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">),</span>
        <span class="n">gabor_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span>
        <span class="n">gabor_kernel</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span>  <span class="c1"># shape: (16, 9, 9)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: Randomly mix kernels before arrangement!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">embed_equally_spaced_kernels</span><span class="p">(</span><span class="n">canvas_size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>

    <span class="n">spacing</span> <span class="o">=</span> <span class="p">(</span><span class="n">canvas_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">grid_size</span> <span class="o">*</span> <span class="n">kernel_size</span><span class="p">))</span> <span class="o">//</span> <span class="p">(</span><span class="n">grid_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># == 32</span>
    <span class="n">kernels</span> <span class="o">=</span> <span class="n">generate_16_kernels</span><span class="p">()</span>  <span class="c1"># (16, 9, 9)</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">canvas_size</span><span class="p">,</span> <span class="n">canvas_size</span><span class="p">))</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_size</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid_size</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">spacing</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">kernel_size</span> <span class="o">+</span> <span class="n">spacing</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">spacing</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">kernel_size</span> <span class="o">+</span> <span class="n">spacing</span><span class="p">)</span>
            <span class="n">canvas</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span> <span class="o">+</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span> <span class="o">+</span> <span class="n">kernel_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">canvas</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">KERNELS_MASK</span> <span class="o">=</span> <span class="n">embed_equally_spaced_kernels</span><span class="p">()</span> <span class="o">*</span> <span class="n">MAX_PHASE</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Convolutional DiffractiveLayer&#39;</span><span class="p">)</span>
<span class="n">ax0</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">KERNELS_MASK</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">MAX_PHASE</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_84_0.png" src="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_84_0.png" />
</div>
</div>
</section>
<section id="3.1.3.-Convolution-Layer-(4f-system)">
<h2>3.1.3. Convolution Layer (4f system)<a class="headerlink" href="#3.1.3.-Convolution-Layer-(4f-system)" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CONV_LAYER</span> <span class="o">=</span> <span class="n">get_4f_convolutional_layer</span><span class="p">(</span>
    <span class="n">SIM_PARAMS</span><span class="p">,</span>
    <span class="n">FOCAL_LENGTH</span><span class="p">,</span>  <span class="c1"># in [m]</span>
    <span class="n">LENS_R</span><span class="p">,</span>  <span class="c1"># in [m]</span>
    <span class="n">KERNELS_MASK</span><span class="p">,</span>  <span class="c1"># mask from 0 to max_phase</span>
    <span class="n">learnable_mask</span><span class="o">=</span><span class="n">LEARN_CONV</span><span class="p">,</span>  <span class="c1"># if a convolutional mask is learnable</span>
    <span class="n">max_phase</span><span class="o">=</span><span class="n">MAX_PHASE</span><span class="p">,</span>
    <span class="n">freespace_method</span><span class="o">=</span><span class="n">FS_METHOD</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="3.2.-Optical-Network-after-a-Convolutional-Layer">
<h3>3.2. Optical Network after a Convolutional Layer<a class="headerlink" href="#3.2.-Optical-Network-after-a-Convolutional-Layer" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">USE_SLM</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;use_slm&#39;</span><span class="p">]</span>
<span class="n">NUM_LAYERS</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;num_layers&#39;</span><span class="p">]</span>  <span class="c1"># number of diffractive layers</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;init_phases&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">INIT_PHASES</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;init_phases&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">INIT_PHASES</span> <span class="o">=</span> <span class="p">[</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;init_phases&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_LAYERS</span><span class="p">)]</span>


<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">INIT_PHASES</span><span class="p">)</span> <span class="o">==</span> <span class="n">NUM_LAYERS</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">USE_SLM</span><span class="p">:</span>
    <span class="n">SLM_VARIABLES</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slm_shapes&#39;</span><span class="p">,</span> <span class="s1">&#39;slm_levels&#39;</span><span class="p">,</span> <span class="s1">&#39;slm_step_funcs&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;slm_step_funcs&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># all SLM&#39;s have the same parameter</span>
                <span class="n">SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_LAYERS</span><span class="p">)]</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># for step functions!</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SLM_STEPS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># all SLM&#39;s have the same parameter</span>
                <span class="n">SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">SLM_STEPS</span><span class="p">[</span><span class="n">VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_LAYERS</span><span class="p">)]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">SLM_VARIABLES</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="n">NUM_LAYERS</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="3.2.1.-Functions-to-get-new-elements">
<h2>3.2.1. Functions to get new elements<a class="headerlink" href="#3.2.1.-Functions-to-get-new-elements" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># functions that return single elements for further architecture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_const_phase_layer</span><span class="p">(</span>
    <span class="n">sim_params</span><span class="p">:</span> <span class="n">SimulationParameters</span><span class="p">,</span>
    <span class="n">value</span><span class="p">,</span> <span class="n">max_phase</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns DiffractiveLayer with a constant phase mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_nodes</span><span class="p">,</span> <span class="n">y_nodes</span> <span class="o">=</span> <span class="n">sim_params</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span><span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">))</span>

    <span class="n">const_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span><span class="p">))</span> <span class="o">*</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">DiffractiveLayer</span><span class="p">(</span>
        <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">sim_params</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">ConstrainedParameter</span><span class="p">(</span>
            <span class="n">const_mask</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="n">max_phase</span>
        <span class="p">),</span>  <span class="c1"># HERE WE ARE USING CONSTRAINED PARAMETER!</span>
    <span class="p">)</span>  <span class="c1"># ATTENTION TO DOCUMENTATION!</span>


<span class="c1"># CHANGE ACCORDING TO THE DOCUMENTATION OF SLM!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_const_slm_layer</span><span class="p">(</span>
    <span class="n">sim_params</span><span class="p">:</span> <span class="n">SimulationParameters</span><span class="p">,</span>
    <span class="n">mask_shape</span><span class="p">,</span>
    <span class="n">phase_value</span><span class="p">,</span>
    <span class="n">num_levels</span><span class="p">,</span>
    <span class="n">step_func</span><span class="p">,</span>
    <span class="n">height_m</span><span class="o">=</span><span class="n">Y_LAYER_SIZE_M</span><span class="p">,</span>
    <span class="n">width_m</span><span class="o">=</span><span class="n">X_LAYER_SIZE_M</span><span class="p">,</span>
    <span class="n">max_phase</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns SpatialLightModulator with a constant phase mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">mask_shape</span>
    <span class="n">const_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span><span class="p">))</span> <span class="o">*</span> <span class="n">phase_value</span>

    <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="n">SpatialLightModulator</span><span class="p">(</span>
        <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">sim_params</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">ConstrainedParameter</span><span class="p">(</span>
            <span class="n">const_mask</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="n">max_phase</span>
        <span class="p">),</span>  <span class="c1"># HERE WE ARE USING CONSTRAINED PARAMETER!</span>
        <span class="n">height</span><span class="o">=</span><span class="n">height_m</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">width_m</span><span class="p">,</span>
        <span class="c1"># location=(0., 0.),  # by default</span>
        <span class="n">number_of_levels</span><span class="o">=</span><span class="n">num_levels</span><span class="p">,</span>
        <span class="n">step_function</span><span class="o">=</span><span class="n">step_func</span><span class="p">,</span>
        <span class="c1"># mode=&#39;nearest&#39;,  # by default it is &#39;nearest&#39;</span>
    <span class="p">)</span>  <span class="c1"># ATTENTION TO DOCUMENTATION!</span>
</pre></div>
</div>
</div>
</section>
<section id="3.2.2.-Elements-list">
<h2>3.2.2. Elements list<a class="headerlink" href="#3.2.2.-Elements-list" title="Link to this heading"></a></h2>
<p>Function to get a list of elements to reproduce an architecture:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_elements_list</span><span class="p">(</span>
    <span class="n">num_layers</span><span class="p">,</span>
    <span class="n">simulation_parameters</span><span class="p">,</span>
    <span class="n">freespace_distance</span><span class="p">,</span>
    <span class="n">freespace_method</span><span class="p">,</span>
    <span class="n">apertures</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">aperture_size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Composes a list of elements for an encoder (with no Detector).</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_layers : int</span>
<span class="sd">        Number of layers in the system.</span>
<span class="sd">    simulation_parameters : SimulationParameters()</span>
<span class="sd">        A simulation parameters for a task.</span>
<span class="sd">    freespace_distance : float,</span>
<span class="sd">        A distance between phase layers in [m].</span>
<span class="sd">    freespace_method : str</span>
<span class="sd">        Propagation method for free spaces in a setup.</span>

<span class="sd">    apertures : bool</span>
<span class="sd">        If True, than before each DiffractiveLayer (and detector) we add a square aperture.</span>
<span class="sd">        Comment: there are strickt square apertures!</span>
<span class="sd">    aperture_size : tuple</span>
<span class="sd">        A size of square apertures.</span>

<span class="sd">    mode : str</span>
<span class="sd">        Takes values: &#39;encoder&#39; or &#39;decoder&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    elements_list : list(Element)</span>
<span class="sd">        List of Elements for an encoder/decoder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elements_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of elements</span>

    <span class="n">use_slm</span> <span class="o">=</span> <span class="n">USE_SLM</span>
    <span class="n">init_phases</span> <span class="o">=</span> <span class="n">INIT_PHASES</span>
    <span class="k">if</span> <span class="n">use_slm</span><span class="p">:</span>
        <span class="n">slm_masks_shape</span> <span class="o">=</span> <span class="n">SLM_VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_slm_shapes&#39;</span><span class="p">]</span>
        <span class="n">slm_levels</span> <span class="o">=</span> <span class="n">SLM_VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_slm_levels&#39;</span><span class="p">]</span>
        <span class="n">slm_funcs</span> <span class="o">=</span> <span class="n">SLM_VARIABLES</span><span class="p">[</span><span class="s1">&#39;encoder_slm_step_funcs&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">apertures</span><span class="p">:</span>  <span class="c1"># equal masks for all apertures (select a part in the middle)</span>
        <span class="n">aperture_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">aperture_size</span><span class="p">)</span>

        <span class="n">y_nodes</span><span class="p">,</span> <span class="n">x_nodes</span> <span class="o">=</span> <span class="n">simulation_parameters</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span><span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">))</span>
        <span class="n">y_mask</span><span class="p">,</span> <span class="n">x_mask</span> <span class="o">=</span> <span class="n">aperture_mask</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">pad_top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y_nodes</span> <span class="o">-</span> <span class="n">y_mask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pad_bottom</span> <span class="o">=</span> <span class="n">y_nodes</span> <span class="o">-</span> <span class="n">pad_top</span> <span class="o">-</span> <span class="n">y_mask</span>
        <span class="n">pad_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x_nodes</span> <span class="o">-</span> <span class="n">x_mask</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pad_right</span> <span class="o">=</span> <span class="n">x_nodes</span> <span class="o">-</span> <span class="n">pad_left</span> <span class="o">-</span> <span class="n">x_mask</span>  <span class="c1"># params for transforms.Pad</span>

        <span class="c1"># padding transform to match aperture size with simulation parameters</span>
        <span class="n">aperture_mask</span> <span class="o">=</span> <span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">aperture_mask</span><span class="p">,</span>
            <span class="n">pad</span><span class="o">=</span><span class="p">(</span><span class="n">pad_left</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">,</span> <span class="n">pad_top</span><span class="p">,</span> <span class="n">pad_bottom</span><span class="p">),</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

    <span class="c1"># first FreeSpace layer before first DiffractiveLayer</span>
    <span class="c1"># after 4f-system already have a FreeSpace</span>

    <span class="c1"># compose the architecture</span>
    <span class="k">for</span> <span class="n">ind_layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_layers</span><span class="p">):</span>

        <span class="c1"># add strickt square Aperture</span>
        <span class="k">if</span> <span class="n">apertures</span><span class="p">:</span>
            <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">elements</span><span class="o">.</span><span class="n">Aperture</span><span class="p">(</span>
                    <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">simulation_parameters</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">aperture_mask</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------PHASE LAYER</span>
        <span class="k">if</span> <span class="n">use_slm</span><span class="p">:</span>  <span class="c1"># add a phase layer (SLM or DiffractiveLayer)</span>
            <span class="c1"># add SLM (learnable phase mask)</span>
            <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">get_const_slm_layer</span><span class="p">(</span>
                    <span class="n">simulation_parameters</span><span class="p">,</span>
                    <span class="n">mask_shape</span><span class="o">=</span><span class="n">slm_masks_shape</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">phase_value</span><span class="o">=</span><span class="n">init_phases</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">num_levels</span><span class="o">=</span><span class="n">slm_levels</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">step_func</span><span class="o">=</span><span class="n">slm_funcs</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">max_phase</span><span class="o">=</span><span class="n">MAX_PHASE</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># add DiffractiveLayer (learnable phase mask)</span>
            <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">get_const_phase_layer</span><span class="p">(</span>
                    <span class="n">simulation_parameters</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">init_phases</span><span class="p">[</span><span class="n">ind_layer</span><span class="p">],</span>
                    <span class="n">max_phase</span><span class="o">=</span><span class="n">MAX_PHASE</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># -----------------------------------------------------------------------</span>

        <span class="c1"># add FreeSpace</span>
        <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">get_free_space</span><span class="p">(</span>
                <span class="n">simulation_parameters</span><span class="p">,</span>  <span class="c1"># simulation parameters for the notebook</span>
                <span class="n">freespace_distance</span><span class="p">,</span>  <span class="c1"># in [m]</span>
                <span class="n">freespace_method</span><span class="o">=</span><span class="n">freespace_method</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># ---------------------------------------------------------------------------</span>
    <span class="c1"># add Detector in the end of the system!</span>
    <span class="n">elements_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Detector</span><span class="p">(</span>
            <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">simulation_parameters</span><span class="p">,</span>
            <span class="n">func</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span>  <span class="c1"># detector that returns intensity</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">elements_list</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="3.3.-Model-with-a-Convolutional-Layer-(4f-System)">
<h3>3.3. Model with a Convolutional Layer (4f System)<a class="headerlink" href="#3.3.-Model-with-a-Convolutional-Layer-(4f-System)" title="Link to this heading"></a></h3>
</section>
</section>
<section id="3.3.1.-Model-Class">
<h2>3.3.1. Model Class<a class="headerlink" href="#3.3.1.-Model-Class" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConvolutionalSystem</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple convolutional network with a 4f system as an optical convolutional layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sim_params</span><span class="p">:</span> <span class="n">SimulationParameters</span><span class="p">,</span>
        <span class="n">conv_layer_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">num_layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">fs_distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">fs_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;AS&#39;</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_default_device</span><span class="p">(),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sim_params : SimulationParameters</span>
<span class="sd">            Simulation parameters for the task.</span>
<span class="sd">        conv_layer_list : list</span>
<span class="sd">            List of Elements for a Convolutional layer (4f system).</span>
<span class="sd">        num_layers : int</span>
<span class="sd">            Number of DiffractiveLayer&#39;s after 4f-system.</span>
<span class="sd">        fs_distance : float,</span>
<span class="sd">            A distance between phase layers in [m].</span>
<span class="sd">        fs_method : str</span>
<span class="sd">            Propagation method for free spaces in a setup.</span>
<span class="sd">        elements_list : list</span>
<span class="sd">            List of elements to compose a network after a Convolutional Layer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span> <span class="o">=</span> <span class="n">sim_params</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="o">.</span><span class="n">axes_size</span><span class="p">(</span>
            <span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># height and width for a wavefronts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs_method</span> <span class="o">=</span> <span class="n">fs_method</span>

        <span class="c1"># CONVOLUTIONAL LAYER</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_layer_list</span> <span class="o">=</span> <span class="n">conv_layer_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">conv_layer_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__device</span><span class="p">)</span>

        <span class="c1"># NETWORK</span>
        <span class="n">elements_list</span> <span class="o">=</span> <span class="n">get_elements_list</span><span class="p">(</span>
            <span class="n">num_layers</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_params</span><span class="p">,</span>
            <span class="n">fs_distance</span><span class="p">,</span>
            <span class="n">fs_method</span><span class="p">,</span>
            <span class="n">apertures</span><span class="o">=</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;use_apertures&#39;</span><span class="p">],</span>
            <span class="n">aperture_size</span><span class="o">=</span><span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;aperture_size&#39;</span><span class="p">],</span>
        <span class="p">)</span>  <span class="c1"># Detector is here!</span>

        <span class="c1"># self.encoder_elements = encoder_elements_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">elements_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__device</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stepwise_propagation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_wavefront</span><span class="p">:</span> <span class="n">Wavefront</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;encode&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that consistently applies forward method of each element of</span>
<span class="sd">        Convolution Layer or the Network after Convolution</span>
<span class="sd">        to an `input_wavefront`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_wavefront : torch.Tensor</span>
<span class="sd">            A wavefront that enters the optical network.</span>
<span class="sd">        mode : str</span>
<span class="sd">            Specify a mode &#39;convolution&#39; or &#39;after convolution&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            A string that represents a scheme of a propagation through a setup.</span>
<span class="sd">        list(torch.Tensor)</span>
<span class="sd">            A list of an input wavefront evolution during a propagation through a setup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">this_wavefront</span> <span class="o">=</span> <span class="n">input_wavefront</span>
        <span class="c1"># list of wavefronts while propagation of an initial wavefront through the system</span>
        <span class="n">steps_wavefront</span> <span class="o">=</span> <span class="p">[</span><span class="n">this_wavefront</span><span class="p">]</span>  <span class="c1"># input wavefront is a zeroth step</span>

        <span class="n">optical_scheme</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># string that represents a linear optical setup (schematic)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;convolution&#39;</span><span class="p">:</span>
            <span class="n">net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_layer</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;after convolution&#39;</span><span class="p">:</span>
            <span class="n">net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span>

        <span class="n">net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ind_element</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
            <span class="c1"># for visualization in a console</span>
            <span class="n">element_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">optical_scheme</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-(</span><span class="si">{</span><span class="n">ind_element</span><span class="si">}</span><span class="s1">)-&gt; [</span><span class="si">{</span><span class="n">ind_element</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">element_name</span><span class="si">}</span><span class="s1">] &#39;</span>

            <span class="k">if</span> <span class="n">ind_element</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">net</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">optical_scheme</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;-(</span><span class="si">{</span><span class="n">ind_element</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">)-&gt;&#39;</span>

            <span class="c1"># element forward</span>
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="n">this_wavefront</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">this_wavefront</span><span class="p">)</span>

            <span class="n">steps_wavefront</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_wavefront</span><span class="p">)</span>  <span class="c1"># add a wavefront to list of steps</span>

        <span class="k">return</span> <span class="n">optical_scheme</span><span class="p">,</span> <span class="n">steps_wavefront</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavefront_in</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wavefront_in: Wavefront(&#39;bs&#39;, &#39;H&#39;, &#39;W&#39;)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        detector_image : torch.Tensor</span>
<span class="sd">            Image on a Detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavefront_in</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># if a batch is an input</span>
            <span class="n">batch_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">wavefront_in</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># convolutional layer</span>
        <span class="n">wavefront_after_convolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_layer</span><span class="p">(</span><span class="n">wavefront_in</span><span class="p">)</span>
        <span class="c1"># other layers</span>
        <span class="n">detector_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">wavefront_after_convolution</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">detector_image</span>
</pre></div>
</div>
</div>
</section>
<section id="3.3.2.-Empty-model">
<h2>3.3.2. Empty model<a class="headerlink" href="#3.3.2.-Empty-model" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_net</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">ConvolutionalSystem</span><span class="p">(</span>
        <span class="n">SIM_PARAMS</span><span class="p">,</span>
        <span class="n">CONV_LAYER</span><span class="p">,</span>
        <span class="n">NUM_LAYERS</span><span class="p">,</span>
        <span class="n">FS_DISTANCE</span><span class="p">,</span>
        <span class="n">FS_METHOD</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="3.4.-Detector-processor-(to-calculate-accuracies-only)">
<h3>3.4. Detector processor (to calculate accuracies only)<a class="headerlink" href="#3.4.-Detector-processor-(to-calculate-accuracies-only)" title="Link to this heading"></a></h3>
<p><strong>Comment:</strong> <code class="docutils literal notranslate"><span class="pre">DetectorProcessor</span></code> in our library is used to process an information on detector. For example, for the current task <code class="docutils literal notranslate"><span class="pre">DetectorProcessor</span></code> must return only 10 values (1 value per 1 class).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CALCULATE_ACCURACIES</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;calculate_accuracies&#39;</span><span class="p">]</span>
<span class="c1"># if False, accuracies will not be calculated!</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a DetectorProcessorOzcanClf object</span>
<span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
    <span class="n">detector_processor</span> <span class="o">=</span> <span class="n">DetectorProcessorClf</span><span class="p">(</span>
        <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="o">=</span><span class="n">NUM_CLASSES</span><span class="p">,</span>
        <span class="n">segmented_detector</span><span class="o">=</span><span class="n">DETECTOR_MASK</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">detector_processor</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="3.1.4-Detector-processor-(to-calculate-accuracies-only)">
<h2>3.1.4 Detector processor (to calculate accuracies only)<a class="headerlink" href="#3.1.4-Detector-processor-(to-calculate-accuracies-only)" title="Link to this heading"></a></h2>
<p><strong>Comment:</strong> <code class="docutils literal notranslate"><span class="pre">DetectorProcessor</span></code> in our library is used to process an information on detector. For example, for the current task <code class="docutils literal notranslate"><span class="pre">DetectorProcessor</span></code> must return only 10 values (1 value per 1 class).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CALCULATE_ACCURACIES</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;calculate_accuracies&#39;</span><span class="p">]</span>  <span class="c1"># if False, accuracies will not be calculated!</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a DetectorProcessorOzcanClf object</span>
<span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
    <span class="n">detector_processor</span> <span class="o">=</span> <span class="n">DetectorProcessorClf</span><span class="p">(</span>
        <span class="n">simulation_parameters</span><span class="o">=</span><span class="n">SIM_PARAMS</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="o">=</span><span class="n">NUM_CLASSES</span><span class="p">,</span>
        <span class="n">segmented_detector</span><span class="o">=</span><span class="n">DETECTOR_MASK</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">detector_processor</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="4.-Training-of-the-network">
<h3>4. Training of the network<a class="headerlink" href="#4.-Training-of-the-network" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DEVICE</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;DEVICE&#39;</span><span class="p">]</span>  <span class="c1"># &#39;mps&#39; is not support a CrossEntropyLoss</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
    <span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="n">DEVICE</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;cpu&#39;
</pre></div></div>
</div>
</section>
<section id="4.1.-Prepare-some-stuff-for-training">
<h3>4.1. Prepare some stuff for training<a class="headerlink" href="#4.1.-Prepare-some-stuff-for-training" title="Link to this heading"></a></h3>
</section>
</section>
<section id="4.1.1.-DataLoader's">
<h2>4.1.1. <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>’s<a class="headerlink" href="#4.1.1.-DataLoader's" title="Link to this heading"></a></h2>
<p>Citations from methods of <a class="reference external" href="https://www.nature.com/articles/s41566-021-00796-w#Sec4">[1]</a>:</p>
<blockquote>
<div><p>The batch size set for the training process was <span class="math notranslate nohighlight">\(64\)</span>.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_bs</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;train_batch_size&#39;</span><span class="p">]</span>  <span class="c1"># a batch size for training set</span>
<span class="n">val_bs</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;val_batch_size&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<blockquote>
<div><p>Forthis task, phase-only transmission masks weredesigned by training a five-layer <span class="math notranslate nohighlight">\(D^2 NN\)</span> with <span class="math notranslate nohighlight">\(55000\)</span> images (<span class="math notranslate nohighlight">\(5000\)</span> validation images) from theMNIST (Modified National Institute of Stan-dards and Technology) handwritten digit data-base.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mnist_wf_train_ds</span>
<span class="n">train_wf_ds</span><span class="p">,</span> <span class="n">val_wf_ds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">mnist_wf_train_ds</span><span class="p">,</span>
    <span class="n">lengths</span><span class="o">=</span><span class="p">[</span><span class="mi">55000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">],</span>  <span class="c1"># sizes from the article</span>
    <span class="n">generator</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">178</span><span class="p">)</span>  <span class="c1"># for reproducibility</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_wf_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">train_wf_ds</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">train_bs</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># num_workers=2,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">val_wf_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">val_wf_ds</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">val_bs</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># num_workers=2,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_wf_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">mnist_wf_test_ds</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">val_bs</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># num_workers=2,</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.1.2.-Optimizer-and-loss-function">
<h2>4.1.2. Optimizer and loss function<a class="headerlink" href="#4.1.2.-Optimizer-and-loss-function" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LR</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;adam_lr&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_adam_optimizer</span><span class="p">(</span><span class="n">net</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span>  <span class="c1"># NETWORK PARAMETERS!</span>
        <span class="n">lr</span><span class="o">=</span><span class="n">LR</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LOSS</span> <span class="o">=</span> <span class="s1">&#39;MSE&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">LOSS</span> <span class="o">==</span> <span class="s1">&#39;MSE&#39;</span><span class="p">:</span>
    <span class="n">loss_func_clf</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>  <span class="c1"># by default: reduction=&#39;mean&#39;</span>
    <span class="n">loss_func_name</span> <span class="o">=</span> <span class="s1">&#39;MSE&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.1.3.-Training-and-evaluation-loops">
<h2>4.1.3. Training and evaluation loops<a class="headerlink" href="#4.1.3.-Training-and-evaluation-loops" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[84]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">onn_train_mse</span><span class="p">(</span>
    <span class="n">optical_net</span><span class="p">,</span> <span class="n">wavefronts_dataloader</span><span class="p">,</span>
    <span class="n">detector_processor_clf</span><span class="p">,</span>  <span class="c1"># DETECTOR PROCESSOR needed for accuracies only!</span>
    <span class="n">loss_func</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">show_process</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to train `optical_net` (classification task)</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        optical_net : torch.nn.Module</span>
<span class="sd">            Neural Network composed of Elements.</span>
<span class="sd">        wavefronts_dataloader : torch.utils.data.DataLoader</span>
<span class="sd">            A loader (by batches) for the train dataset of wavefronts.</span>
<span class="sd">        detector_processor_clf : DetectorProcessorClf</span>
<span class="sd">            A processor of a detector image for a classification task, that returns `probabilities` of classes.</span>
<span class="sd">        loss_func :</span>
<span class="sd">            Loss function for a multi-class classification task.</span>
<span class="sd">        optimizer: torch.optim</span>
<span class="sd">            Optimizer...</span>
<span class="sd">        device : str</span>
<span class="sd">            Device to computate on...</span>
<span class="sd">        show_process : bool</span>
<span class="sd">            Flag to show (or not) a progress bar.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        batches_losses : list[float]</span>
<span class="sd">            Losses for each batch in an epoch.</span>
<span class="sd">        batches_accuracies : list[float]</span>
<span class="sd">            Accuracies for each batch in an epoch.</span>
<span class="sd">        epoch_accuracy : float</span>
<span class="sd">            Accuracy for an epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optical_net</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># activate &#39;train&#39; mode of a model</span>
    <span class="n">batches_losses</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store loss for each batch</span>
    <span class="n">batches_accuracies</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store accuracy for each batch</span>

    <span class="n">correct_preds</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">batch_wavefronts</span><span class="p">,</span> <span class="n">batch_targets</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">wavefronts_dataloader</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">wavefronts_dataloader</span><span class="p">),</span>
        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">show_process</span>
    <span class="p">):</span>  <span class="c1"># go by batches</span>
        <span class="c1"># batch_wavefronts - input wavefronts, batch_labels - labels</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_wavefronts</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">batch_wavefronts</span> <span class="o">=</span> <span class="n">batch_wavefronts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">batch_targets</span> <span class="o">=</span> <span class="n">batch_targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="c1"># forward of an optical network</span>
        <span class="n">detector_output</span> <span class="o">=</span> <span class="n">optical_net</span><span class="p">(</span><span class="n">batch_wavefronts</span><span class="p">)</span>

        <span class="c1"># calculate loss for a batch</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">detector_output</span><span class="p">,</span> <span class="n">batch_targets</span><span class="p">)</span>

        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># ACCURACY</span>
        <span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
            <span class="c1"># process a detector image</span>
            <span class="n">batch_labels</span> <span class="o">=</span> <span class="n">detector_processor_clf</span><span class="o">.</span><span class="n">batch_forward</span><span class="p">(</span><span class="n">batch_targets</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">batch_probas</span> <span class="o">=</span> <span class="n">detector_processor_clf</span><span class="o">.</span><span class="n">batch_forward</span><span class="p">(</span><span class="n">detector_output</span><span class="p">)</span>

            <span class="n">batch_correct_preds</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch_probas</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">batch_labels</span>
            <span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">correct_preds</span> <span class="o">+=</span> <span class="n">batch_correct_preds</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="n">batch_size</span>

        <span class="c1"># accumulate losses and accuracies for batches</span>
        <span class="n">batches_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
            <span class="n">batches_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_correct_preds</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batches_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
        <span class="n">epoch_accuracy</span> <span class="o">=</span> <span class="n">correct_preds</span> <span class="o">/</span> <span class="n">size</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">epoch_accuracy</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">return</span> <span class="n">batches_losses</span><span class="p">,</span> <span class="n">batches_accuracies</span><span class="p">,</span> <span class="n">epoch_accuracy</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">onn_validate_mse</span><span class="p">(</span>
    <span class="n">optical_net</span><span class="p">,</span> <span class="n">wavefronts_dataloader</span><span class="p">,</span>
    <span class="n">detector_processor_clf</span><span class="p">,</span>  <span class="c1"># DETECTOR PROCESSOR NEEDED!</span>
    <span class="n">loss_func</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span> <span class="n">show_process</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to validate `optical_net` (classification task)</span>
<span class="sd">    ...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        optical_net : torch.nn.Module</span>
<span class="sd">            Neural Network composed of Elements.</span>
<span class="sd">        wavefronts_dataloader : torch.utils.data.DataLoader</span>
<span class="sd">            A loader (by batches) for the train dataset of wavefronts.</span>
<span class="sd">        detector_processor_clf : DetectorProcessorClf</span>
<span class="sd">            A processor of a detector image for a classification task, that returns `probabilities` of classes.</span>
<span class="sd">        loss_func :</span>
<span class="sd">            Loss function for a multi-class classification task.</span>
<span class="sd">        device : str</span>
<span class="sd">            Device to computate on...</span>
<span class="sd">        show_process : bool</span>
<span class="sd">            Flag to show (or not) a progress bar.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        batches_losses : list[float]</span>
<span class="sd">            Losses for each batch in an epoch.</span>
<span class="sd">        batches_accuracies : list[float]</span>
<span class="sd">            Accuracies for each batch in an epoch.</span>
<span class="sd">        epoch_accuracy : float</span>
<span class="sd">            Accuracy for an epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">optical_net</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>  <span class="c1"># activate &#39;eval&#39; mode of a model</span>
    <span class="n">batches_losses</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store loss for each batch</span>
    <span class="n">batches_accuracies</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store accuracy for each batch</span>

    <span class="n">correct_preds</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">batch_wavefronts</span><span class="p">,</span> <span class="n">batch_targets</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">wavefronts_dataloader</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">wavefronts_dataloader</span><span class="p">),</span>
        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">show_process</span>
    <span class="p">):</span>  <span class="c1"># go by batches</span>
        <span class="c1"># batch_wavefronts - input wavefronts, batch_labels - labels</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_wavefronts</span><span class="o">.</span><span class="n">size</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">batch_wavefronts</span> <span class="o">=</span> <span class="n">batch_wavefronts</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">batch_targets</span> <span class="o">=</span> <span class="n">batch_targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">detector_outputs</span> <span class="o">=</span> <span class="n">optical_net</span><span class="p">(</span><span class="n">batch_wavefronts</span><span class="p">)</span>
            <span class="c1"># calculate loss for a batch</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">detector_outputs</span><span class="p">,</span> <span class="n">batch_targets</span><span class="p">)</span>

        <span class="c1"># ACCURACY</span>
        <span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
            <span class="c1"># process a detector image</span>
            <span class="n">batch_labels</span> <span class="o">=</span> <span class="n">detector_processor_clf</span><span class="o">.</span><span class="n">batch_forward</span><span class="p">(</span><span class="n">batch_targets</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">batch_probas</span> <span class="o">=</span> <span class="n">detector_processor_clf</span><span class="o">.</span><span class="n">batch_forward</span><span class="p">(</span><span class="n">detector_outputs</span><span class="p">)</span>

            <span class="n">batch_correct_preds</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch_probas</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">batch_labels</span>
            <span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">correct_preds</span> <span class="o">+=</span> <span class="n">batch_correct_preds</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="n">batch_size</span>

        <span class="c1"># accumulate losses and accuracies for batches</span>
        <span class="n">batches_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
            <span class="n">batches_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_correct_preds</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batches_accuracies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
        <span class="n">epoch_accuracy</span> <span class="o">=</span> <span class="n">correct_preds</span> <span class="o">/</span> <span class="n">size</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">epoch_accuracy</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">return</span> <span class="n">batches_losses</span><span class="p">,</span> <span class="n">batches_accuracies</span><span class="p">,</span> <span class="n">epoch_accuracy</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="4.2.-Training-of-the-optical-network">
<h3>4.2. Training of the optical network<a class="headerlink" href="#4.2.-Training-of-the-optical-network" title="Link to this heading"></a></h3>
</section>
</section>
<section id="4.2.1.-Before-training">
<h2>4.2.1. Before training<a class="headerlink" href="#4.2.1.-Before-training" title="Link to this heading"></a></h2>
<blockquote>
<div><p>a diffractive layer … neurons … were initialized with <span class="math notranslate nohighlight">\(\pi\)</span> for phase values and <span class="math notranslate nohighlight">\(1\)</span> for amplitude values …</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SIM_PARAMS</span> <span class="o">=</span> <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

<span class="n">untrained_net</span> <span class="o">=</span> <span class="n">get_net</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="k">if</span> <span class="n">detector_processor</span><span class="p">:</span>
    <span class="n">detector_processor</span> <span class="o">=</span> <span class="n">detector_processor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_losses_0</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">test_accuracy_0</span> <span class="o">=</span> <span class="n">onn_validate_mse</span><span class="p">(</span>
    <span class="n">untrained_net</span><span class="p">,</span>  <span class="c1"># optical network composed in 3.</span>
    <span class="n">test_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of training set</span>
    <span class="n">detector_processor</span><span class="p">,</span>  <span class="c1"># detector processor</span>
    <span class="n">loss_func_clf</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
    <span class="n">show_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>  <span class="c1"># evaluate the model</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s1">&#39;Results before training on TEST set:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">test_losses_0</span><span class="p">)</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Accuracy : </span><span class="si">{</span><span class="p">(</span><span class="n">test_accuracy_0</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;0.1f</span><span class="si">}</span><span class="s1"> %&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|██████████████████████████████████████████| 157/157 [00:38&lt;00:00,  4.10it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Results before training on TEST set:
        MSE : 0.006371
        Accuracy : 9.9 %
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.2.2.-Training">
<h2>4.2.2. Training<a class="headerlink" href="#4.2.2.-Training" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_epochs</span> <span class="o">=</span> <span class="n">VARIABLES</span><span class="p">[</span><span class="s1">&#39;number_of_epochs&#39;</span><span class="p">]</span>
<span class="n">print_each</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># print each n&#39;th epoch info</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scheduler</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># sheduler for a lr tuning during training</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Recreate a system to restart training!</span>
<span class="n">SIM_PARAMS</span> <span class="o">=</span> <span class="n">SIM_PARAMS</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">net_to_train</span> <span class="o">=</span> <span class="n">get_net</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

<span class="c1"># Linc optimizer to a recreated net!</span>
<span class="n">optimizer_clf</span> <span class="o">=</span> <span class="n">get_adam_optimizer</span><span class="p">(</span><span class="n">net_to_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[92]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_epochs_losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">val_epochs_losses</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store losses of each epoch</span>

<span class="n">train_epochs_acc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">val_epochs_acc</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to store accuracies</span>

<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">98</span><span class="p">)</span>  <span class="c1"># for reproducability?</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Epoch #</span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">: &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># TRAIN</span>
    <span class="n">start_train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># start time of the epoch (train)</span>
    <span class="n">train_losses</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">train_accuracy</span> <span class="o">=</span> <span class="n">onn_train_mse</span><span class="p">(</span>
        <span class="n">net_to_train</span><span class="p">,</span>  <span class="c1"># optical network composed in 3.</span>
        <span class="n">train_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of training set</span>
        <span class="n">detector_processor</span><span class="p">,</span>  <span class="c1"># detector processor</span>
        <span class="n">loss_func_clf</span><span class="p">,</span>
        <span class="n">optimizer_clf</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
        <span class="n">show_process</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># train the model</span>
    <span class="n">mean_train_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_losses</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># train info</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training results&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">mean_train_loss</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Accuracy : </span><span class="si">{</span><span class="p">(</span><span class="n">train_accuracy</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;0.1f</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">------------   </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_train_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>

    <span class="c1"># VALIDATION</span>
    <span class="n">start_val_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># start time of the epoch (validation)</span>
    <span class="n">val_losses</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">val_accuracy</span> <span class="o">=</span> <span class="n">onn_validate_mse</span><span class="p">(</span>
        <span class="n">net_to_train</span><span class="p">,</span>  <span class="c1"># optical network composed in 3.</span>
        <span class="n">val_wf_loader</span><span class="p">,</span>  <span class="c1"># dataloader of validation set</span>
        <span class="n">detector_processor</span><span class="p">,</span>  <span class="c1"># detector processor</span>
        <span class="n">loss_func_clf</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span>
        <span class="n">show_process</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># evaluate the model</span>
    <span class="n">mean_val_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">val_losses</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">print_each</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">==</span> <span class="n">n_epochs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># validation info</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validation results&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">loss_func_name</span><span class="si">}</span><span class="s1"> : </span><span class="si">{</span><span class="n">mean_val_loss</span><span class="si">:</span><span class="s1">.6f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CALCULATE_ACCURACIES</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Accuracy : </span><span class="si">{</span><span class="p">(</span><span class="n">val_accuracy</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;0.1f</span><span class="si">}</span><span class="s1"> %&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">------------   </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_val_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scheduler</span><span class="p">:</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">mean_val_loss</span><span class="p">)</span>

    <span class="c1"># save losses</span>
    <span class="n">train_epochs_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_train_loss</span><span class="p">)</span>
    <span class="n">val_epochs_losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_val_loss</span><span class="p">)</span>
    <span class="c1"># seve accuracies</span>
    <span class="n">train_epochs_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_accuracy</span><span class="p">)</span>
    <span class="n">val_epochs_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_accuracy</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Epoch #1:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [08:08&lt;00:00,  1.76it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005861
        Accuracy : 51.9 %
        ------------   488.81 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:28&lt;00:00,  2.75it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005754
        Accuracy : 64.0 %
        ------------   28.74 s
Epoch #2:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [08:58&lt;00:00,  1.60it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005718
        Accuracy : 64.7 %
        ------------   538.35 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:30&lt;00:00,  2.63it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005709
        Accuracy : 63.8 %
        ------------   30.09 s
Epoch #4:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [10:12&lt;00:00,  1.41it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005675
        Accuracy : 67.2 %
        ------------   612.07 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:30&lt;00:00,  2.61it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005678
        Accuracy : 67.5 %
        ------------   30.33 s
Epoch #6:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [09:11&lt;00:00,  1.56it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005661
        Accuracy : 67.9 %
        ------------   551.55 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:30&lt;00:00,  2.57it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005667
        Accuracy : 68.6 %
        ------------   30.70 s
Epoch #8:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [10:45&lt;00:00,  1.33it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005653
        Accuracy : 68.3 %
        ------------   645.20 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:32&lt;00:00,  2.41it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005660
        Accuracy : 67.1 %
        ------------   32.82 s
Epoch #10:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [11:06&lt;00:00,  1.29it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005648
        Accuracy : 68.6 %
        ------------   666.04 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:31&lt;00:00,  2.53it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005655
        Accuracy : 68.3 %
        ------------   31.26 s
Epoch #12:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [09:17&lt;00:00,  1.54it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005645
        Accuracy : 68.8 %
        ------------   557.04 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:30&lt;00:00,  2.61it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005652
        Accuracy : 68.8 %
        ------------   30.32 s
Epoch #14:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [09:12&lt;00:00,  1.56it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005643
        Accuracy : 68.9 %
        ------------   552.11 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:30&lt;00:00,  2.61it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005651
        Accuracy : 68.0 %
        ------------   30.30 s
Epoch #16:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [09:34&lt;00:00,  1.50it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005641
        Accuracy : 68.9 %
        ------------   574.58 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:31&lt;00:00,  2.53it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005650
        Accuracy : 68.5 %
        ------------   31.20 s
Epoch #18:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [09:37&lt;00:00,  1.49it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005640
        Accuracy : 68.9 %
        ------------   577.47 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:31&lt;00:00,  2.50it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005649
        Accuracy : 68.9 %
        ------------   31.63 s
Epoch #20:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
train: 100%|███████████████████████████████████████████████| 860/860 [10:10&lt;00:00,  1.41it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Training results
        MSE : 0.005639
        Accuracy : 69.1 %
        ------------   610.99 s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
validation: 100%|████████████████████████████████████████████| 79/79 [00:31&lt;00:00,  2.54it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Validation results
        MSE : 0.005648
        Accuracy : 68.6 %
        ------------   31.16 s
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># learning curve</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_epochs_losses</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val_epochs_losses</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">train_epochs_acc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">val_epochs_acc</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">loss_func_name</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39; $\times 10^3$&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_148_0.png" src="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_148_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_cols</span> <span class="o">=</span> <span class="n">NUM_LAYERS</span>  <span class="c1"># number of columns for DiffractiveLayer&#39;s masks visualization</span>
<span class="n">n_rows</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># plot wavefronts phase</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>
<span class="n">ind_diff_layer</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gist_stern&#39;</span>  <span class="c1"># &#39;gist_stern&#39; &#39;rainbow&#39;</span>

<span class="n">net_to_plot</span> <span class="o">=</span> <span class="n">net_to_train</span><span class="o">.</span><span class="n">net</span>

<span class="k">for</span> <span class="n">ind_layer</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">net_to_plot</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">elements</span><span class="o">.</span><span class="n">DiffractiveLayer</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">elements</span><span class="o">.</span><span class="n">SpatialLightModulator</span><span class="p">):</span>
        <span class="c1"># plot masks for Diffractive layers</span>
        <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_diff_layer</span> <span class="o">//</span> <span class="n">n_cols</span><span class="p">][</span><span class="n">ind_diff_layer</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax_this</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">ind_diff_layer</span> <span class="o">%</span> <span class="n">n_cols</span><span class="p">]</span>

        <span class="c1"># ax_this.set_title(titles[ind_module])</span>

        <span class="n">trained_mask</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="n">phase_mask_this</span> <span class="o">=</span> <span class="n">ax_this</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">trained_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=MAX_PHASE</span>
        <span class="p">)</span>
        <span class="n">ind_diff_layer</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">APERTURES</span><span class="p">:</span>  <span class="c1"># select only a part within apertures!</span>
            <span class="n">x_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">DETECTOR_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">y_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">DETECTOR_SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax_this</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">x_frame</span><span class="p">,</span> <span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">x_frame</span><span class="p">,</span> <span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">y_frame</span><span class="p">,</span> <span class="n">y_frame</span><span class="p">])</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.87</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">phase_mask_this</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_154_0.png" src="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_154_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># array with all losses</span>
<span class="n">all_lasses_header</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">loss_func_name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_train&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">loss_func_name</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_val&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accuracy_train&#39;</span><span class="p">,</span> <span class="s1">&#39;accuracy_val&#39;</span>
<span class="p">])</span>
<span class="n">all_losses_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span><span class="n">train_epochs_losses</span><span class="p">,</span> <span class="n">val_epochs_losses</span><span class="p">,</span> <span class="n">train_epochs_acc</span><span class="p">,</span> <span class="n">val_epochs_acc</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># filepath to save the model</span>
<span class="n">model_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/conv_net.pth&#39;</span>
<span class="c1"># filepath to save losses</span>
<span class="n">losses_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">RESULTS_FOLDER</span><span class="si">}</span><span class="s1">/training_curves.csv&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># saving model</span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">net_to_train</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_filepath</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># saving losses</span>
<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
    <span class="n">losses_filepath</span><span class="p">,</span> <span class="n">all_losses_array</span><span class="p">,</span>
    <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">all_lasses_header</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="4.4.-Examples-of-encoding/decoding">
<h3>4.4. Examples of encoding/decoding<a class="headerlink" href="#4.4.-Examples-of-encoding/decoding" title="Link to this heading"></a></h3>
</section>
</section>
<section id="4.4.1.-Select-a-sample-to-encode/decode">
<h2>4.4.1. Select a sample to encode/decode<a class="headerlink" href="#4.4.1.-Select-a-sample-to-encode/decode" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[108]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_test_examples</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">78</span><span class="p">)</span>
<span class="n">test_examples_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mnist_wf_test_ds</span><span class="p">)),</span> <span class="n">n_test_examples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[109]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_test_examples</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_test_examples</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ind_test</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">test_examples_ids</span><span class="p">):</span>
    <span class="n">test_wavefront</span><span class="p">,</span> <span class="n">test_target</span> <span class="o">=</span> <span class="n">mnist_wf_test_ds</span><span class="p">[</span><span class="n">ind_test</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ind_test</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">test_wavefront</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

    <span class="c1"># ax.set_xticks([])</span>
    <span class="c1"># ax.set_yticks([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_169_0.png" src="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_169_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="4.4.2.-Encode/decode-an-example">
<h2>4.4.2. Encode/decode an example<a class="headerlink" href="#4.4.2.-Encode/decode-an-example" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">encode_and_decode</span><span class="p">(</span><span class="n">autoencoder</span><span class="p">,</span> <span class="n">input_wf</span><span class="p">,</span> <span class="n">use_encoder_aperture</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># if use_encoder_aperture is True - apply strickt square aperture to encoded image</span>
    <span class="c1"># aperture is defined as REGION_MASK, that was used in loss!</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="c1"># ENCODE</span>
        <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">input_wf</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PRESERVE_PHASE</span><span class="p">:</span>
            <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">encoded_image</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>  <span class="c1"># reset phases before decoding!</span>
        <span class="k">if</span> <span class="n">use_encoder_aperture</span><span class="p">:</span>
            <span class="n">encoded_image</span> <span class="o">=</span> <span class="n">encoded_image</span> <span class="o">*</span> <span class="n">REGION_MASK</span>  <span class="c1"># apply aperture for encoded image</span>

        <span class="c1"># DECODE</span>
        <span class="n">decoded_image</span> <span class="o">=</span> <span class="n">autoencoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoded_image</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PRESERVE_PHASE</span><span class="p">:</span>
            <span class="n">decoded_image</span> <span class="o">=</span> <span class="n">decoded_image</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="mi">0</span><span class="n">j</span>  <span class="c1"># reset phases before decoding!</span>

    <span class="k">return</span> <span class="n">encoded_image</span><span class="p">,</span> <span class="n">decoded_image</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[110]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_lines</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># image / encoded / decoded</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_lines</span><span class="p">,</span> <span class="n">n_test_examples</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_test_examples</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_lines</span> <span class="o">*</span> <span class="mf">3.2</span><span class="p">))</span>

<span class="n">to_plot</span> <span class="o">=</span> <span class="s1">&#39;amp&#39;</span>  <span class="c1"># &lt;--- chose what to plot</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;grey&#39;</span>  <span class="c1"># choose colormaps</span>
<span class="n">use_encoder_aperture</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">max_amp</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># upper limits for colorplots</span>
<span class="n">max_phase</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>

<span class="k">for</span> <span class="n">ind_ex</span><span class="p">,</span> <span class="n">ind_test</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_examples_ids</span><span class="p">):</span>
    <span class="n">ax_image</span><span class="p">,</span> <span class="n">ax_encoded</span><span class="p">,</span> <span class="n">ax_decoded</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">],</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ind_ex</span><span class="p">]</span>

    <span class="n">test_wavefront</span><span class="p">,</span> <span class="n">test_target</span> <span class="o">=</span> <span class="n">mnist_wf_test_ds</span><span class="p">[</span><span class="n">ind_test</span><span class="p">]</span>

    <span class="n">ax_image</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;id=</span><span class="si">{</span><span class="n">ind_test</span><span class="si">}</span><span class="s1"> [</span><span class="si">{</span><span class="n">test_target</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
        <span class="n">ax_image</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">test_wavefront</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_amp</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
        <span class="n">ax_image</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">test_wavefront</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_phase</span>
        <span class="p">)</span>

    <span class="n">encoded_this</span><span class="p">,</span> <span class="n">decoded_this</span> <span class="o">=</span> <span class="n">encode_and_decode</span><span class="p">(</span>
        <span class="n">autoencoder_to_train</span><span class="p">,</span> <span class="n">test_wavefront</span><span class="p">,</span> <span class="n">use_encoder_aperture</span>
    <span class="p">)</span>

    <span class="n">ax_encoded</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;encoded&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">encoded_this</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_amp</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">encoded_this</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_phase</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">use_encoder_aperture</span><span class="p">:</span>  <span class="c1"># select only a part within apertures!</span>
        <span class="n">x_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">REGION_MASK_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">REGION_MASK_SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">x_frame</span><span class="p">,</span> <span class="n">x_layer_nodes</span> <span class="o">-</span> <span class="n">x_frame</span><span class="p">])</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">y_layer_nodes</span> <span class="o">-</span> <span class="n">y_frame</span><span class="p">,</span> <span class="n">y_frame</span><span class="p">])</span>

    <span class="n">ax_decoded</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;decoded&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
        <span class="n">ax_decoded</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">decoded_this</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_amp</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
        <span class="n">ax_decoded</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">decoded_this</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="c1"># vmin=0, vmax=max_phase</span>
        <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_176_0.png" src="../../_images/examples_notebook_diff_networks_examples_09_convolutional_4f_176_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="08_autoencoder.html" class="btn btn-neutral float-left" title="Diffractive Autoencoder for MNIST classification task" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, CompPhysLab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>